<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ELIMINATOR</title>

  <!-- Police √©l√©gante (sans d√©pendance externe) -->
  <style>
    :root{
      --bg: #f4f6fb;
      --fg: #0d1321;
      --muted: rgba(13,19,33,.62);
      --glass: rgba(255,255,255,.55);
      --glass2: rgba(255,255,255,.35);
      --line: rgba(13,19,33,.14);
      --shadow: 0 18px 60px rgba(0,0,0,.10);
      --blur: 16px;
      --radius: 12px;           /* moins d'arrondis */
      --radius2: 10px;
      --barH: 26px;             /* barre √©paisse */
      --chipH: 18px;
      --accent: rgba(0,140,255,.22); /* mode clair : l√©ger bleu */
      --accent2: rgba(0,140,255,.38);
      --danger: rgba(0,0,0,.08);
      --ok: rgba(0,0,0,.06);
      --mono: ui-sans-serif, system-ui, -apple-system, "SF Pro Display", "Segoe UI", Roboto, Helvetica, Arial;
      --mono2: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    }
    [data-theme="dark"]{
      --bg:#0b0f17;
      --fg:#eaf0ff;
      --muted: rgba(234,240,255,.62);
      --glass: rgba(18,24,38,.55);
      --glass2: rgba(18,24,38,.35);
      --line: rgba(234,240,255,.14);
      --shadow: 0 18px 80px rgba(0,0,0,.38);
      --blur: 18px;
      --accent: rgba(0,255,140,.18); /* mode sombre : l√©ger vert */
      --accent2: rgba(0,255,140,.34);
      --danger: rgba(255,255,255,.08);
      --ok: rgba(255,255,255,.06);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: var(--mono);
      background: radial-gradient(1200px 700px at 30% 15%, rgba(255,255,255,.42), transparent 60%),
                  radial-gradient(1000px 680px at 75% 30%, rgba(0,0,0,.06), transparent 60%),
                  var(--bg);
      color:var(--fg);
      overflow-x:hidden;
    }
    [data-theme="dark"] body{
      background: radial-gradient(1200px 700px at 30% 15%, rgba(0,255,140,.06), transparent 60%),
                  radial-gradient(1100px 720px at 75% 30%, rgba(0,140,255,.05), transparent 60%),
                  var(--bg);
    }

    /* Layout */
    .wrap{
      min-height:100%;
      display:flex;
      flex-direction:column;
      padding: 14px 14px 18px;
      gap: 12px;
      align-items:center;
    }
    .topbar{
      width:min(980px, 100%);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:10px 10px;
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: var(--glass);
      backdrop-filter: blur(var(--blur));
      box-shadow: var(--shadow);
    }
    .topbar .left, .topbar .right{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }

    /* Minimal buttons */
    .btn{
      border:1px solid var(--line);
      background: transparent;
      color:var(--fg);
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 12px;
      letter-spacing:.08em;
      text-transform:uppercase;
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{ background: var(--ok); }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background: linear-gradient(180deg, var(--glass2), transparent);
      box-shadow: inset 0 0 0 1px var(--line);
    }
    .btn.tiny{
      padding:6px 8px;
      font-size:11px;
    }
    .btn.icon{
      width:38px;
      height:34px;
      display:grid;
      place-items:center;
      padding:0;
      font-family: var(--mono2);
      letter-spacing:0;
      text-transform:none;
      font-size:14px;
    }
    .btn.switch{
      display:flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
    }
    .pill{
      padding:5px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.03);
      color: var(--muted);
      font-size:12px;
      font-family: var(--mono2);
    }
    [data-theme="dark"] .pill{ background: rgba(255,255,255,.04); }

    /* Title area */
    .hero{
      width:min(980px, 100%);
      display:flex;
      flex-direction:column;
      align-items:center;
      gap: 8px;
      padding: 2px 8px 6px;
    }
    .title{
      font-size: 48px;  /* plus grand */
      letter-spacing: .18em;
      text-transform:uppercase;
      margin: 6px 0 0;
      font-weight: 650;
      line-height:1.1;
      text-align:center;
    }
    @media (max-width:520px){
      .title{ font-size: 36px; letter-spacing:.14em; }
    }
    .tag{
      font-size: 13px;
      color: var(--muted);
      text-align:center;
      max-width: 62ch;
      padding: 0 8px;
    }

    /* Main center block */
    .main{
      width:min(980px, 100%);
      display:flex;
      flex-direction:column;
      gap: 14px;
      align-items:center;
    }

    /* Progress bars */
    .barWrap{
      width:100%;
      display:flex;
      flex-direction:column;
      gap:10px;
      padding: 12px 12px 14px;
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: var(--glass);
      backdrop-filter: blur(var(--blur));
      box-shadow: var(--shadow);
    }
    .barRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .barLabel{
      font-size: 12px;
      letter-spacing:.08em;
      text-transform:uppercase;
      color: var(--muted);
    }
    .bar{
      width:100%;
      height: var(--barH);
      border:1px solid var(--line);
      background: rgba(0,0,0,.03);
      border-radius: var(--radius2);
      position:relative;
      overflow:hidden;
    }
    [data-theme="dark"] .bar{ background: rgba(255,255,255,.04); }
    .barFill{
      position:absolute; inset:0;
      width:100%;
      background: linear-gradient(90deg, var(--accent), transparent);
      transform-origin:left center;
      transition: width 260ms ease;
    }
    .barPct{
      position:absolute; inset:0;
      display:grid;
      place-items:center;
      font-family: var(--mono2);
      font-size: 12px;
      color: var(--fg);
      mix-blend-mode: normal;
      opacity:.92;
      pointer-events:none;
    }

    /* Current task block */
    .current{
      width:100%;
      padding: 14px 12px 12px;
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: var(--glass);
      backdrop-filter: blur(var(--blur));
      box-shadow: var(--shadow);
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .taskName{
      font-size: 20px;
      font-weight: 600;
      letter-spacing:.02em;
      text-align:center;
      line-height:1.25;
      padding: 2px 4px;
    }
    @media (max-width:520px){
      .taskName{ font-size: 18px; }
    }

    /* Etorion chips */
    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      justify-content:center;
      padding: 2px 0;
    }
    .chip{
      width: var(--chipH);
      height: var(--chipH);
      border-radius: 6px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.03);
    }
    [data-theme="dark"] .chip{ background: rgba(255,255,255,.04); }
    .chip.on{ background: var(--accent2); }

    /* Action row (roulette + bomb + notes + focus) */
    .actions{
      display:flex;
      gap:10px;
      justify-content:center;
      flex-wrap:wrap;
      align-items:center;
    }

    /* Roulette button */
    .roulette{
      width: 92px;
      height: 92px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: radial-gradient(circle at 30% 30%, var(--glass2), transparent 60%),
                  linear-gradient(180deg, var(--glass2), transparent);
      backdrop-filter: blur(var(--blur));
      box-shadow: var(--shadow);
      display:grid;
      place-items:center;
      cursor:pointer;
      position:relative;
      user-select:none;
    }
    .roulette:active{ transform: translateY(1px); }
    .rouletteText{
      font-size: 12px;
      letter-spacing:.14em;
      text-transform:uppercase;
      color: var(--fg);
      opacity:.9;
      font-weight:650;
    }
    .rouletteRing{
      position:absolute;
      inset:6px;
      border-radius:999px;
      border:1px dashed var(--line);
      opacity:.85;
    }
    .rouletteSpin{
      animation: spin 720ms cubic-bezier(.15,.9,.2,1) 1;
    }
    @keyframes spin{
      0%{ transform: rotate(0deg); }
      100%{ transform: rotate(720deg); } /* 2 tours propres */
    }

    .bomb{
      min-width: 160px;
      padding: 12px 14px;
      border-radius: 12px;
      border:1px solid var(--line);
      background: linear-gradient(180deg, var(--glass2), transparent);
      cursor:pointer;
      text-transform:uppercase;
      letter-spacing:.10em;
      font-size: 12px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      user-select:none;
      box-shadow: var(--shadow);
    }
    .bomb:hover{ background: var(--ok); }
    .bomb:active{ transform: translateY(1px); }
    .bomb .em{
      font-family: var(--mono2);
      font-size: 14px;
      opacity:.9;
    }
    .bomb .label{
      display:flex;
      flex-direction:column;
      line-height:1.1;
      align-items:center;
    }
    .bomb .label span{ font-size: 12px; }
    .bomb .label small{
      font-size: 10px;
      color: var(--muted);
      letter-spacing:.14em;
      text-transform:uppercase;
    }

    .miniIcon{
      width:44px; height:44px;
      border-radius: 12px;
      border:1px solid var(--line);
      display:grid;
      place-items:center;
      cursor:pointer;
      background: transparent;
      box-shadow: var(--shadow);
      font-family: var(--mono2);
      font-size: 14px;
      user-select:none;
    }
    .miniIcon:hover{ background: var(--ok); }
    .miniIcon:active{ transform: translateY(1px); }

    /* Optional active list drawer under main */
    .belowList{
      width:100%;
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: var(--glass);
      backdrop-filter: blur(var(--blur));
      box-shadow: var(--shadow);
      padding: 10px;
      display:none;
    }
    .belowList.show{ display:block; }
    .belowHead{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding-bottom:8px;
      border-bottom:1px solid var(--line);
      margin-bottom:8px;
    }
    .belowHead .h{
      font-size:12px; letter-spacing:.10em; text-transform:uppercase; color:var(--muted);
    }
    .taskRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 8px 6px;
      border-bottom:1px solid var(--line);
    }
    .taskRow:last-child{ border-bottom:none; }
    .taskRow .t{
      flex:1;
      min-width:0;
      font-size: 13px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      color: var(--fg);
    }
    .taskRow .meta{
      font-size: 11px;
      color: var(--muted);
      font-family: var(--mono2);
      white-space:nowrap;
    }
    .taskRow .tools{
      display:flex;
      gap:6px;
      align-items:center;
    }

    .toolBtn{
      width:34px; height:30px;
      border-radius: 10px;
      border:1px solid var(--line);
      display:grid;
      place-items:center;
      cursor:pointer;
      background: transparent;
      font-family: var(--mono2);
      font-size: 12px;
      user-select:none;
    }
    .toolBtn:hover{ background: var(--ok); }

    /* Focus mode */
    .focusOn .topbar .left .btn:not(.keepFocus),
    .focusOn .topbar .right,
    .focusOn .belowList.show{
      display:none !important;
    }
    .focusOn .topbar{
      justify-content:center;
    }
    .focusOn .topbar .left{
      width:100%;
      justify-content:center;
    }
    .focusOn .topbar .left .keepFocus{
      font-size:12px;
      padding:10px 14px;
    }
    .focusOn .tag{
      opacity:.9;
    }
    /* Focus should keep essential stats visible (already inside topbar pills) */
    .focusOn .hero{ margin-top: 0; }

    /* Drawer (menu lateral) */
    .drawerBack{
      position:fixed; inset:0;
      background: rgba(0,0,0,.25);
      backdrop-filter: blur(10px);
      display:none;
      z-index:50;
    }
    .drawer{
      position:fixed;
      top:0; left:0;
      width:min(420px, 92vw);  /* plus large */
      height:100%;
      background: var(--glass);
      border-right:1px solid var(--line);
      backdrop-filter: blur(var(--blur));
      box-shadow: var(--shadow);
      transform: translateX(-105%);
      transition: transform 220ms ease;
      z-index:60;
      display:flex;
      flex-direction:column;
    }
    .drawer.open{ transform: translateX(0); }
    .drawerBack.show{ display:block; }
    .drawerTop{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding: 10px 12px;
      border-bottom:1px solid var(--line);
    }
    .drawerTitle{
      font-size: 12px;
      letter-spacing:.12em;
      text-transform:uppercase;
      color: var(--muted);
      font-family: var(--mono2);
    }
    .tabs{
      display:flex;
      gap:8px;
      padding: 10px 12px 6px;
      flex-wrap:wrap;
    }
    .tab{
      padding: 7px 9px;
      border-radius: 10px;
      border:1px solid var(--line);
      cursor:pointer;
      font-size: 11px;
      letter-spacing:.12em;
      text-transform:uppercase;
      color: var(--muted);
      user-select:none;
    }
    .tab.active{
      color: var(--fg);
      background: linear-gradient(180deg, var(--glass2), transparent);
      box-shadow: inset 0 0 0 1px var(--line);
    }
    .drawerBody{
      padding: 10px 12px 18px;
      overflow:auto;
    }

    .section{
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding: 10px;
      background: rgba(0,0,0,.02);
    }
    [data-theme="dark"] .section{ background: rgba(255,255,255,.03); }
    .section h3{
      margin: 0 0 8px;
      font-size: 11px;
      letter-spacing:.14em;
      text-transform:uppercase;
      color: var(--muted);
      font-family: var(--mono2);
      font-weight:650;
    }
    textarea, input, select{
      width:100%;
      border:1px solid var(--line);
      background: transparent;
      color: var(--fg);
      border-radius: 10px;
      padding: 10px;
      outline:none;
      font-family: var(--mono);
      font-size: 13px;
    }
    textarea{ min-height: 140px; resize:vertical; }
    .row{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .row > *{ flex:1; min-width: 120px; }

    /* Modals */
    .modalBack{
      position:fixed; inset:0;
      background: rgba(0,0,0,.25);
      backdrop-filter: blur(12px);
      display:none;
      z-index:80;
    }
    .modal{
      position:fixed;
      inset: 0;
      display:none;
      z-index:90;
      padding: 18px;
      align-items:center;
      justify-content:center;
    }
    .modalCard{
      width:min(720px, 96vw);
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: var(--glass);
      backdrop-filter: blur(var(--blur));
      box-shadow: var(--shadow);
      padding: 12px;
    }
    .modalHead{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding: 6px 6px 10px;
      border-bottom:1px solid var(--line);
      margin-bottom:10px;
    }
    .modalHead .mh{
      font-size: 12px; letter-spacing:.12em; text-transform:uppercase; color: var(--muted);
      font-family: var(--mono2);
    }

    /* Celebration & Tips */
    .bigTitle{
      font-size: 22px;
      font-weight: 700;
      letter-spacing:.06em;
      text-transform:uppercase;
      text-align:center;
      margin: 6px 0 6px;
    }
    .bigMsg{
      font-size: 14px;
      color: var(--fg);
      opacity:.92;
      text-align:center;
      line-height:1.45;
      margin: 0 0 10px;
    }
    .subMsg{
      font-size: 12px;
      color: var(--muted);
      text-align:center;
      margin: 0 0 6px;
      font-family: var(--mono2);
    }

    /* Confetti canvas */
    #confetti{
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:120;
    }

    /* Sets panel (right overlay) */
    .setsPanel{
      position:fixed;
      top: 70px;
      right: 14px;
      width: min(360px, 92vw);
      max-height: calc(100vh - 88px);
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: var(--glass);
      backdrop-filter: blur(var(--blur));
      box-shadow: var(--shadow);
      padding: 10px;
      overflow:auto;
      display:none;
      z-index:40;
    }
    .setsPanel.show{ display:block; }
    .setsPanel .h{
      font-size: 11px; letter-spacing:.14em; text-transform:uppercase; color: var(--muted);
      font-family: var(--mono2);
      margin: 0 0 8px;
    }
    .setCard{
      border:1px solid var(--line);
      border-radius: var(--radius2);
      padding: 10px;
      margin-bottom:10px;
      background: rgba(0,0,0,.02);
    }
    [data-theme="dark"] .setCard{ background: rgba(255,255,255,.03); }
    .setCard .name{
      font-size: 12px; letter-spacing:.10em; text-transform:uppercase;
      margin-bottom:8px;
      color: var(--fg);
      font-family: var(--mono2);
    }
    .setItem{
      display:flex;
      align-items:center;
      gap:8px;
      margin: 6px 0;
    }
    .check{
      width:18px; height:18px;
      border:1px solid var(--line);
      border-radius: 4px;
      display:grid;
      place-items:center;
      cursor:pointer;
      user-select:none;
      background: transparent;
      font-family: var(--mono2);
      font-size:12px;
    }
    .check.on{ background: var(--accent2); }

    /* Small text */
    .small{
      font-size:12px;
      color: var(--muted);
    }
  </style>
</head>

<body data-theme="light">
<canvas id="confetti"></canvas>

<div class="drawerBack" id="drawerBack"></div>
<div class="drawer" id="drawer">
  <div class="drawerTop">
    <div class="drawerTitle">MENU</div>
    <button class="btn tiny" id="drawerClose">FERMER</button>
  </div>
  <div class="tabs" id="tabs"></div>
  <div class="drawerBody" id="drawerBody"></div>
</div>

<div class="modalBack" id="modalBack"></div>

<!-- Notes modal -->
<div class="modal" id="notesModal">
  <div class="modalCard">
    <div class="modalHead">
      <div class="mh">NOTES</div>
      <button class="btn tiny" id="notesClose">FERMER</button>
    </div>
    <div class="section">
      <h3>Ajouter une note</h3>
      <textarea id="noteInput" placeholder="√âcris ici. Ce qui traverse ton cerveau a le droit d'exister."></textarea>
      <div class="row" style="margin-top:8px">
        <button class="btn primary" id="noteAdd">AJOUTER</button>
        <button class="btn" id="noteClear">EFFACER LE CHAMP</button>
      </div>
    </div>
    <div style="height:10px"></div>
    <div class="section">
      <h3>Historique</h3>
      <div id="notesList" class="small"></div>
    </div>
  </div>
</div>

<!-- Celebration modal -->
<div class="modal" id="celeModal">
  <div class="modalCard">
    <div class="modalHead">
      <div class="mh">C√âL√âBRATION</div>
      <button class="btn tiny" id="celeClose">OK</button>
    </div>
    <div class="bigTitle" id="celeTitle"></div>
    <div class="bigMsg" id="celeMsg"></div>
    <div class="subMsg" id="celeSub"></div>
  </div>
</div>

<!-- Tips modal -->
<div class="modal" id="tipsModal">
  <div class="modalCard">
    <div class="modalHead">
      <div class="mh">CONSEIL FLOW</div>
      <button class="btn tiny" id="tipsClose">OK</button>
    </div>
    <div class="bigTitle" id="tipsTitle"></div>
    <div class="bigMsg" id="tipsMsg"></div>
    <div class="subMsg" id="tipsSub"></div>
  </div>
</div>

<!-- Sets panel -->
<div class="setsPanel" id="setsPanel">
  <div class="h">SETS</div>
  <div id="setsContent"></div>
</div>

<div class="wrap" id="app">
  <!-- TOP BAR -->
  <div class="topbar">
    <div class="left">
      <button class="btn icon" id="btnMenu" title="Menu">‚â°</button>

      <!-- Essentiels (pas en boutons, mais en pills) -->
      <span class="pill" id="pillTasks">0/0 t√¢ches</span>
      <span class="pill" id="pillEto">0/0 √©torions</span>
      <span class="pill" id="pillDone">0 faite</span>
      <span class="pill" id="pillTimer">00:00</span>

      <!-- Toggle clair/sombre au centre / haut (texte explicite) -->
      <button class="btn switch primary" id="btnTheme" title="Th√®me">
        <span id="themeLabel">TH√àME CLAIR</span>
      </button>

      <button class="btn tiny" id="btnToggleList" title="Afficher/masquer la liste">LISTE</button>
      <button class="btn tiny" id="btnToggleSets" title="Afficher/masquer les sets">SETS</button>

      <!-- Le bouton focus doit rester en focus (keepFocus) -->
      <button class="btn primary keepFocus" id="btnFocus">FOCUS</button>

      <button class="btn tiny" id="btnReset">RESET</button>
    </div>

    <div class="right">
      <span class="pill" id="pillMode">mode: normal</span>
      <span class="pill" id="pillFlow">flow: stable</span>
    </div>
  </div>

  <!-- HERO -->
  <div class="hero">
    <div class="title">ELIMINATOR</div>
    <div class="tag" id="tagline"></div>
  </div>

  <!-- MAIN -->
  <div class="main">
    <!-- PROGRESS (isol√©e) -->
    <div class="barWrap">
      <div class="barRow">
        <div class="barLabel">progression t√¢ches</div>
        <div class="barLabel" id="barInfo">‚Äî</div>
      </div>
      <div class="bar" aria-label="Progression">
        <div class="barFill" id="taskBarFill" style="width:100%"></div>
        <div class="barPct" id="taskBarPct">100%</div>
      </div>
    </div>

    <!-- CURRENT TASK -->
    <div class="current">
      <div class="taskName" id="taskName">Aucune t√¢che</div>

      <div class="chips" id="chips"></div>

      <div class="actions">
        <div class="roulette" id="btnRoulette" title="Roulette">
          <div class="rouletteRing" aria-hidden="true"></div>
          <div class="rouletteText">ROULETTE</div>
        </div>

        <div class="bomb" id="btnEtorion" title="D√©gommer un √©torion">
          <div class="em">üí£</div>
          <div class="label">
            <span>D√âGOMMER</span>
            <small>1 √âTORION</small>
          </div>
        </div>

        <div class="miniIcon" id="btnNotes" title="Notes">‚úé</div>
        <div class="miniIcon" id="btnDoneTask" title="Marquer t√¢che d√©gomm√©e">‚úì</div>
        <div class="miniIcon" id="btnEditTask" title="√âditer t√¢che">‚âã</div>
      </div>

      <!-- Liste active "dans une fen√™tre en dessous", masquable -->
      <div class="belowList" id="belowList">
        <div class="belowHead">
          <div class="h">LISTE EN COURS</div>
          <div class="row" style="justify-content:flex-end; gap:8px; flex:0">
            <button class="btn tiny" id="btnHideBelow">MASQUER</button>
          </div>
        </div>
        <div id="belowTasks"></div>
      </div>

      <div class="small" id="hintLine" style="text-align:center">
        Astuce: roulette pour choisir, üí£ pour grignoter l‚Äô√©torion. Focus pour le mode tunnel.
      </div>
    </div>
  </div>
</div>

<script>
/* =========================================================
   ELIMINATOR ‚Äî Single-file app
   Objectif: flow, minimalisme, pas de redondance.
   ========================================================= */

/* -------------------------
   Helpers
------------------------- */
const $ = (id)=>document.getElementById(id);
const clamp = (n,a,b)=>Math.max(a, Math.min(b,n));
const uid = ()=>Math.random().toString(36).slice(2,10)+"_"+Date.now().toString(36);
const nowISO = ()=>new Date().toISOString();
const dayKey = (d=new Date())=>{
  const y=d.getFullYear();
  const m=String(d.getMonth()+1).padStart(2,"0");
  const da=String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${da}`;
};
function fmtMMSS(ms){
  const s = Math.floor(ms/1000);
  const mm = String(Math.floor(s/60)).padStart(2,"0");
  const ss = String(s%60).padStart(2,"0");
  return `${mm}:${ss}`;
}
function plural(n, one, many){
  return (n===1)? one : many;
}
function rand(n){ return Math.floor(Math.random()*n); }

/* -------------------------
   Storage
------------------------- */
const LS_KEY = "eliminator_v3_flow";
const defaultState = {
  theme: "light",          // clair par d√©faut
  focus: false,
  showBelowList: false,
  showSets: false,
  activeTab: "inbox",
  settings: {
    etorionMin: 5,                 // minutes
    fatigue: 2,                    // 0..4
    motivation: 2,                 // 0..4
    celebrationChance: 0.35,       // surprise (pas tout le temps)
    celebrationAutoCloseSec: 10,   // visible
    tipsChance: 0.18,              // coaching ponctuel
    tipsMinGapMin: 6,              // pas spam
    keepListInFocus: true,         // l‚Äôutilisateur l‚Äôa demand√©: possible de garder/afficher
    allowSound: false,             // non
    listSort: "roulette",          // roulette | ordre | alpha | cat
    includedCats: [],              // si vide => toutes
  },
  tasks: [],
  baseline: { totalTasks:0, totalEtorions:0 },
  currentTaskId: null,
  currentTaskStart: null, // timestamp when current task chosen
  notes: [],              // persistent across resets
  habits: [],             // [{id,name,slots,checks:[], createdAt}]
  history: [],            // [{day, doneTaskIds:[], doneTitles:[], remainingTitles:[], doneEtorions, totalEtorions, habitsDoneSummary}]
  kiffance: {
    bank: {
      "5": [],
      "10": [],
      "15": [],
      "25": []
    }
  },
  sets: {
    hospital: { enabled:true, patients: 4, itemsPerPatient:["Voir patient","Note","Traitement","Dossier"], checks:{} },
    consult:  { enabled:true, patients: 6, itemsPerPatient:["Voir patient","Note","Ordonnance","Dossier"], checks:{} },
    custom: [] // future
  },
  lastTipAt: null,
  stats: {
    etorionsDone: 0,
    tasksDone: 0
  }
};

let state = loadState();
function loadState(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return seedState(structuredClone(defaultState));
    const parsed = JSON.parse(raw);
    // Merge shallowly to avoid missing keys after updates
    const merged = structuredClone(defaultState);
    deepAssign(merged, parsed);
    // ensure seed banks exist
    return seedState(merged);
  }catch(e){
    return seedState(structuredClone(defaultState));
  }
}
function saveState(){
  localStorage.setItem(LS_KEY, JSON.stringify(state));
}
function deepAssign(target, src){
  for(const k in src){
    if(src[k] && typeof src[k]==="object" && !Array.isArray(src[k]) && target[k]){
      deepAssign(target[k], src[k]);
    }else{
      target[k] = src[k];
    }
  }
}

/* -------------------------
   Seed content (kiffance + celebrations + taglines + tips)
------------------------- */
function seedState(s){
  // Seed kiffance bank if empty (rich, structured, flow-friendly)
  const bank = s.kiffance?.bank;
  if(bank){
    const emptyAll = ["5","10","15","25"].every(k => Array.isArray(bank[k]) && bank[k].length===0);
    if(emptyAll){
      bank["5"] = [
        "Bois un verre d‚Äôeau. Debout. Sans n√©gocier.",
        "Respire 5 cycles lents. √âpaules en bas.",
        "Nettoie une surface de 30 secondes. Stop.",
        "√âtire cou/nuque 45 secondes. Retour imm√©diat.",
        "Regarde au loin 20 secondes. Reviens.",
        "Micro-marche: 60 secondes. Pas plus."
      ];
      bank["10"] = [
        "Mini-reset: toilette + eau + retour.",
        "Rangement √©clair: 10 objets, pas un de plus.",
        "2 minutes respiration + 8 minutes action simple.",
        "D√©charge mentale: √©cris 8 lignes, ferme.",
        "Soleil/fen√™tre: 3 minutes + 7 minutes reprise."
      ];
      bank["15"] = [
        "Pause active: marche 10 + eau 5.",
        "Snack simple + respiration lente, sans √©cran.",
        "√âtirements + douche flash si possible.",
        "Rituel anti-chaos: 15 minutes chrono, stop net."
      ];
      bank["25"] = [
        "Vraie pause: 20 minutes hors √©cran + 5 minutes reprise douce.",
        "Petite marche + retour avec une seule priorit√©.",
        "Micro-sieste 15‚Äì20 min + eau + reprise.",
        "D√©compression structur√©e: musique 10 + marche 10 + retour 5."
      ];
    }
  }

  // Seed notes/habits arrays safety
  s.notes = Array.isArray(s.notes)? s.notes : [];
  s.habits = Array.isArray(s.habits)? s.habits : [];
  s.history = Array.isArray(s.history)? s.history : [];
  s.tasks = Array.isArray(s.tasks)? s.tasks : [];

  // Ensure theme default light
  if(!s.theme) s.theme = "light";
  // Ensure baseline exists
  if(!s.baseline) s.baseline = { totalTasks:0, totalEtorions:0 };

  return s;
}

// Taglines (varient parfois)
const TAGLINE_POOL = [
  "D√©gomme toutes les t√¢ches. R√©√©cris la r√©alit√©.",
  "D√©gomme les √©torions. Forgeron¬∑ne du temps, √©dition finale.",
  "La procrastination a une arm√©e. Tu as un plan.",
  "Mode qu√™te principale: activ√©. PNJ int√©rieur: rassur√©.",
  "Une t√¢che √† la fois. Sort ancien: neutralis√©.",
  "Ce n‚Äôest pas une liste. C‚Äôest une campagne.",
  "Aujourd‚Äôhui, on fait propre. Comme un geste clinique net.",
  "Objectif: flow. R√©sultat: domination calme.",
  "Tu avances. Le chaos recule. Sans fanfare, avec efficacit√©.",
  "Une micro-action = une faille dans l‚Äôempire du bazar."
];

// Celebrations: surprise (pond√©r√©e fatigue/motivation)
const CELE_POOL = [
  {cat:"fantasy", t:"CHANT DE VICTOIRE", m:"Une t√¢che est tomb√©e. Les montagnes administratives ont l√©g√®rement trembl√©."},
  {cat:"fantasy", t:"BANNI√àRE PLANT√âE", m:"Territoire reconquis. La fronti√®re du chaos recule d‚Äôun pas."},
  {cat:"dream",   t:"ARCHITECTE DU R√âEL", m:"Tu viens de plier le temps en origami. R√©alit√©: stabilis√©e."},
  {cat:"dream",   t:"TOTEM: STABLE", m:"Tu es dans le r√©el. Et dans le r√©el, tu termines les choses. Magnifique."},
  {cat:"ninja",   t:"TECHNIQUE INTERDITE", m:"Coup pr√©cis. Une t√¢che KO avant qu‚Äôelle ne crie."},
  {cat:"ninja",   t:"MODE INFILTRATION", m:"Entre les lasers de la distraction. Personne n‚Äôa vu. Sauf le r√©sultat."},
  {cat:"med",     t:"GESTE CHIRURGICAL", m:"Incision propre dans le chaos. H√©mostase parfaite. Fermeture: impeccable."},
  {cat:"med",     t:"DIAGNOSTIC: R√âSOLU", m:"Sympt√¥me: t√¢che. Traitement: action. Pronostic: victoire."},
  {cat:"game",    t:"QU√äTE VALID√âE", m:"Objectif atteint. Butin: paix int√©rieure + 2 points en dignit√©."},
  {cat:"game",    t:"ACHIEVEMENT D√âBLOQU√â", m:"¬´ Je termine ce que je commence ¬ª. Qualit√© l√©gendaire."},
  {cat:"empire",  t:"EMPIRE √âTENDU", m:"Un √©torion de moins. Ton r√®gne sur la journ√©e s‚Äôintensifie."},
  {cat:"empire",  t:"H√âRO√èSME ADMINISTRATIF", m:"La bureaucratie a tent√© un regard. Tu l‚Äôas ignor√©e. Elle a capitul√©."},
];

// Tips (coaching flow, ponctuel)
const TIPS_POOL = [
  {cat:"pause", t:"MICRO-PAUSE INTELLIGENTE", m:"Pause 60 secondes: eau + 5 respirations lentes. Puis reprise imm√©diate."},
  {cat:"focus", t:"R√àGLE DU LASER", m:"Une seule cible. Pas de multi-onglets. Pas d‚Äôarbitrage. Ex√©cution."},
  {cat:"body",  t:"CORPS = INTERRUPTEUR", m:"√âpaules basses, m√¢choire rel√¢ch√©e. Ton cerveau suit ton corps."},
  {cat:"time",  t:"MINUTEUR MENTAL", m:"Fais juste 1 √©torion. Apr√®s, tu ren√©gocies. (Spoiler: tu ne ren√©gocies pas.)"},
  {cat:"env",   t:"ANTI-FRICTION", m:"Enl√®ve un obstacle mat√©riel maintenant (c√¢ble, dossier, onglet)."},
  {cat:"story", t:"NARRATION", m:"Tu es dans la sc√®ne ¬´ ex√©cution ¬ª. Le personnage n‚Äôexplique pas. Il agit."},
];

/* -------------------------
   Parsing tasks from inbox
   Format:
   CAT√âGORIE EN MAJUSCULE
   t√¢che - 3
   autre t√¢che 2
   (chiffre = √©torions)
------------------------- */
function isAllCapsLine(line){
  const t = line.trim();
  if(!t) return false;
  // Consider "majuscule" if letters exist and equals upper
  const hasLetters = /[A-Za-z√Ä-√ñ√ò-√∂√∏-√ø]/.test(t);
  if(!hasLetters) return false;
  return t === t.toUpperCase() && t.length <= 80;
}
function parseTaskLine(line){
  // Extract trailing number (etorions) if exists: "xxx - 3" or "xxx 3"
  const raw = line.trim();
  if(!raw) return null;

  // Remove leading bullets
  const cleaned = raw.replace(/^[-*‚Ä¢\s]+/, "").trim();
  if(!cleaned) return null;

  let et = null;
  let title = cleaned;

  // patterns:
  // "titre - 3" OR "titre ‚Äì 3" OR "titre 3"
  const m1 = cleaned.match(/^(.*?)(?:\s*[-‚Äì‚Äî]\s*|\s+)(\d+)\s*$/);
  if(m1){
    title = m1[1].trim();
    et = parseInt(m1[2],10);
  }
  // sanitize title
  title = title.replace(/\s+/g," ").trim();

  if(!title) return null;

  // clamp etorions if present
  if(et!==null){
    et = clamp(et, 1, 99);
  }
  return {title, etorions: et};
}
function importFromInbox(text){
  const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(l=>l.length>0);
  let cat = "INBOX";
  const out = [];
  for(const line of lines){
    if(isAllCapsLine(line)){
      cat = line.trim().toUpperCase();
      continue;
    }
    const parsed = parseTaskLine(line);
    if(!parsed) continue;
    out.push({
      id: uid(),
      title: parsed.title,
      cat,
      etorionsTotal: parsed.etorions ?? 1,
      etorionsLeft: parsed.etorions ?? 1,
      pinned: false,
      priority: 0,
      done: false,
      createdAt: nowISO(),
      doneAt: null
    });
  }
  return out;
}

/* -------------------------
   Task selection / ordering
------------------------- */
function activeTasks(){
  // filter by included categories if set
  const inc = state.settings.includedCats;
  return state.tasks.filter(t => !t.done).filter(t=>{
    if(!inc || inc.length===0) return true;
    return inc.includes(t.cat);
  });
}
function getTaskById(id){
  return state.tasks.find(t=>t.id===id) || null;
}
function setCurrentTask(id){
  state.currentTaskId = id;
  state.currentTaskStart = Date.now();
  saveState();
}
function ensureCurrentTask(){
  const list = activeTasks();
  if(list.length===0){
    state.currentTaskId = null;
    state.currentTaskStart = null;
    return;
  }
  const cur = getTaskById(state.currentTaskId);
  if(!cur || cur.done){
    // choose pinned first
    const pinned = list.find(t=>t.pinned);
    setCurrentTask((pinned||list[0]).id);
  }
}
function sortTasks(list){
  const mode = state.settings.listSort || "roulette";
  if(mode==="alpha"){
    return [...list].sort((a,b)=>a.title.localeCompare(b.title,"fr"));
  }
  if(mode==="cat"){
    return [...list].sort((a,b)=>{
      const c = a.cat.localeCompare(b.cat,"fr");
      return c!==0 ? c : a.title.localeCompare(b.title,"fr");
    });
  }
  if(mode==="ordre"){
    // keep insertion order by createdAt
    return [...list].sort((a,b)=> (a.createdAt||"").localeCompare(b.createdAt||""));
  }
  // roulette mode keeps pinned at top then random pick when asked
  return [...list].sort((a,b)=>{
    if(a.pinned && !b.pinned) return -1;
    if(!a.pinned && b.pinned) return 1;
    // stable by createdAt
    return (a.createdAt||"").localeCompare(b.createdAt||"");
  });
}
function roulettePick(){
  const list = sortTasks(activeTasks());
  if(list.length===0) return null;
  const pinned = list.filter(t=>t.pinned);
  const pool = pinned.length>0 ? pinned : list;
  return pool[rand(pool.length)];
}

/* -------------------------
   Progress logic
   IMPORTANT: bar starts at 100% filled and DECREASES as tasks are completed.
------------------------- */
function recomputeBaselineIfNeeded(){
  // baseline should represent "start of session" totals for current task batch
  // If baseline is empty but tasks exist, set baseline.
  if(state.baseline.totalTasks===0 && state.baseline.totalEtorions===0 && state.tasks.length>0){
    const allActive = activeTasks();
    const totalTasks = allActive.length;
    const totalEto = allActive.reduce((a,t)=>a+(t.etorionsTotal||0),0);
    state.baseline = { totalTasks, totalEtorions: totalEto };
  }
}
function computeProgress(){
  const baseT = state.baseline.totalTasks || 0;
  const baseE = state.baseline.totalEtorions || 0;

  const remaining = activeTasks();
  const remT = remaining.length;
  const remE = remaining.reduce((a,t)=>a+(t.etorionsLeft||0),0);

  // Decreasing bar: percent filled = remaining/base
  const pct = (baseT<=0) ? 100 : clamp(Math.round((remT/baseT)*100), 0, 100);

  return { baseT, baseE, remT, remE, pct };
}

/* -------------------------
   Etorion actions
------------------------- */
function degommeEtorion(){
  const t = getTaskById(state.currentTaskId);
  if(!t || t.done) return;

  if(typeof t.etorionsLeft!=="number") t.etorionsLeft = t.etorionsTotal||1;
  t.etorionsLeft = clamp(t.etorionsLeft - 1, 0, 99);

  state.stats.etorionsDone = (state.stats.etorionsDone||0) + 1;

  // if task etorions reach 0 => task completed
  if(t.etorionsLeft<=0){
    completeTask(t.id);
  }else{
    maybeShowTip(); // micro-coaching sometimes
  }
  saveState();
  renderAll();
}
function completeTask(taskId){
  const t = getTaskById(taskId);
  if(!t || t.done) return;
  t.done = true;
  t.doneAt = nowISO();

  state.stats.tasksDone = (state.stats.tasksDone||0) + 1;

  // confetti ALWAYS at end of task
  confettiBurst();

  // celebration SOMETIMES
  maybeShowCelebration();

  // update history today snapshot
  snapshotDay();

  // choose next task
  ensureCurrentTask();
}

/* -------------------------
   Celebration & tips (surprise, weighted)
------------------------- */
let celeTimer = null;
let tipsTimer = null;

function pickCelebration(){
  const f = clamp(state.settings.fatigue,0,4);
  const m = clamp(state.settings.motivation,0,4);
  const weights = {
    fantasy: 1 + (f>=3 ? 0.6 : 0),
    dream:   1 + (f>=3 ? 0.5 : 0),
    med:     1 + (f>=3 ? 0.7 : 0),
    ninja:   1 + (m>=3 ? 0.7 : 0),
    game:    1 + (m>=3 ? 0.6 : 0),
    empire:  1 + (m>=3 ? 0.8 : 0),
  };
  const pool = CELE_POOL.map(x=>({x,w:(weights[x.cat]??1)}));
  const sum = pool.reduce((a,p)=>a+p.w,0);
  let r = Math.random()*sum;
  for(const p of pool){
    r -= p.w;
    if(r<=0) return p.x;
  }
  return CELE_POOL[rand(CELE_POOL.length)];
}
function showCelebration(){
  const pick = pickCelebration();
  $("celeTitle").textContent = pick.t;
  $("celeMsg").textContent = pick.m;

  // small subtitle: keep it minimal
  const p = computeProgress();
  const done = (p.baseT - p.remT);
  $("celeSub").textContent = `${done} ${plural(done,"t√¢che","t√¢ches")} d√©gomm√©e${done===1?"":"s"} ¬∑ continue`;

  openModal("celeModal");
  const sec = clamp(parseInt(state.settings.celebrationAutoCloseSec,10)||10, 4, 20);
  if(celeTimer) clearTimeout(celeTimer);
  celeTimer = setTimeout(()=>closeModal("celeModal"), sec*1000);
}
function maybeShowCelebration(){
  const chance = clamp(Number(state.settings.celebrationChance)||0.35, 0, 1);
  // Surprise: only sometimes, and slightly more likely after 2-3 tasks
  const p = computeProgress();
  const done = (p.baseT - p.remT);
  const boost = (done>0 && done%3===0) ? 0.22 : 0;
  if(Math.random() < clamp(chance + boost, 0, 0.85)){
    showCelebration();
  }
}

function pickTip(){
  // Simple pick: prefer pause if fatigue high, prefer focus if motivation low
  const f = clamp(state.settings.fatigue,0,4);
  const m = clamp(state.settings.motivation,0,4);

  const candidates = [];
  for(const tip of TIPS_POOL){
    let w = 1;
    if(tip.cat==="pause") w += (f>=3 ? 1.2 : 0);
    if(tip.cat==="focus") w += (m<=1 ? 1.0 : 0);
    if(tip.cat==="body")  w += (f>=2 ? 0.4 : 0);
    if(tip.cat==="time")  w += (m<=2 ? 0.4 : 0);
    candidates.push({tip,w});
  }
  const sum = candidates.reduce((a,p)=>a+p.w,0);
  let r = Math.random()*sum;
  for(const c of candidates){
    r -= c.w;
    if(r<=0) return c.tip;
  }
  return TIPS_POOL[rand(TIPS_POOL.length)];
}
function showTip(){
  const tip = pickTip();
  $("tipsTitle").textContent = tip.t;
  $("tipsMsg").textContent = tip.m;
  $("tipsSub").textContent = "Un conseil, puis retour au flow.";

  openModal("tipsModal");
  if(tipsTimer) clearTimeout(tipsTimer);
  tipsTimer = setTimeout(()=>closeModal("tipsModal"), 9000);
}
function maybeShowTip(){
  const chance = clamp(Number(state.settings.tipsChance)||0.18, 0, 1);

  // gap control
  const minGap = clamp(Number(state.settings.tipsMinGapMin)||6, 2, 30);
  const last = state.lastTipAt ? new Date(state.lastTipAt).getTime() : 0;
  if(last && (Date.now()-last) < minGap*60*1000) return;

  if(Math.random() < chance){
    state.lastTipAt = nowISO();
    saveState();
    showTip();
  }
}

/* -------------------------
   Notes (persistent)
------------------------- */
function addNote(text){
  const t = (text||"").trim();
  if(!t) return;
  state.notes.unshift({ id: uid(), text: t, at: nowISO() });
  saveState();
  renderNotes();
}
function renderNotes(){
  const list = state.notes || [];
  if(list.length===0){
    $("notesList").innerHTML = "<div class='small'>Aucune note.</div>";
    return;
  }
  $("notesList").innerHTML = list.slice(0,80).map(n=>{
    const dt = new Date(n.at);
    const stamp = dt.toLocaleString("fr-BE",{hour:"2-digit",minute:"2-digit", day:"2-digit", month:"2-digit"});
    const safe = escapeHTML(n.text);
    return `<div style="padding:8px 6px; border-bottom:1px solid var(--line)">
      <div style="font-family:var(--mono2); color:var(--muted); font-size:11px; letter-spacing:.06em">${stamp}</div>
      <div style="white-space:pre-wrap; font-size:13px">${safe}</div>
    </div>`;
  }).join("");
}
function escapeHTML(s){
  return (s||"").replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[c]));
}

/* -------------------------
   Habits
------------------------- */
function addHabit(name, slots){
  const nm = (name||"").trim();
  if(!nm) return;
  const sl = clamp(parseInt(slots,10)||8, 3, 12);
  const checks = Array.from({length:sl}, ()=>false);
  state.habits.push({ id: uid(), name:nm, slots:sl, checks, createdAt: nowISO() });
  saveState();
}
function toggleHabitCheck(hId, idx){
  const h = state.habits.find(x=>x.id===hId);
  if(!h) return;
  h.checks[idx] = !h.checks[idx];
  saveState();
  renderAll();
  snapshotDay();
}
function habitProgress(h){
  const done = h.checks.filter(Boolean).length;
  const tot = h.checks.length;
  return {done, tot, pct: tot? Math.round(done/tot*100):0};
}

/* -------------------------
   Sets (Hospital/Consult) ‚Äî right panel
   Checks stored by day key
------------------------- */
function initSetsChecksForToday(){
  const dk = dayKey();
  for(const key of ["hospital","consult"]){
    const s = state.sets[key];
    if(!s.checks) s.checks = {};
    if(!s.checks[dk]) s.checks[dk] = {};
  }
}
function setKeyItem(setName, pIndex, itemIndex){
  return `${setName}|p${pIndex}|i${itemIndex}`;
}
function toggleSetCheck(setName, pIndex, itemIndex){
  initSetsChecksForToday();
  const dk = dayKey();
  const set = state.sets[setName];
  const k = setKeyItem(setName,pIndex,itemIndex);
  set.checks[dk][k] = !set.checks[dk][k];
  saveState();
  renderSetsPanel();
  snapshotDay();
}
function resetSetToday(setName){
  initSetsChecksForToday();
  const dk = dayKey();
  const set = state.sets[setName];
  set.checks[dk] = {};
  saveState();
  renderSetsPanel();
  snapshotDay();
}

/* -------------------------
   History snapshot + export
------------------------- */
function snapshotDay(){
  const dk = dayKey();
  const doneToday = state.tasks.filter(t=>t.done && t.doneAt && t.doneAt.startsWith(dk));
  const active = activeTasks();

  const baseE = state.baseline.totalEtorions || 0;
  const doneE = (state.stats.etorionsDone||0);

  const habitsSummary = (state.habits||[]).map(h=>{
    const p = habitProgress(h);
    return { name:h.name, done:p.done, total:p.tot };
  });

  // Upsert
  const entry = {
    day: dk,
    doneTitles: doneToday.map(t=>t.title),
    remainingTitles: active.map(t=>t.title),
    doneTasks: doneToday.length,
    remainingTasks: active.length,
    doneEtorions: doneE,
    baselineEtorions: baseE,
    habits: habitsSummary,
    sets: summarizeSetsToday()
  };

  const idx = state.history.findIndex(x=>x.day===dk);
  if(idx>=0) state.history[idx] = entry;
  else state.history.unshift(entry);

  saveState();
}
function summarizeSetsToday(){
  initSetsChecksForToday();
  const dk = dayKey();
  const out = {};
  for(const key of ["hospital","consult"]){
    const set = state.sets[key];
    const checks = set.checks?.[dk] || {};
    const total = set.patients * set.itemsPerPatient.length;
    const done = Object.values(checks).filter(Boolean).length;
    out[key] = { done, total };
  }
  return out;
}
function exportTodayText(){
  snapshotDay();
  const dk = dayKey();
  const e = state.history.find(x=>x.day===dk);
  if(!e) return "Aucune donn√©e.";

  const lines = [];
  lines.push(`ELIMINATOR ‚Äî RAPPORT JOURNALIER ‚Äî ${dk}`);
  lines.push("");
  lines.push(`T√ÇCHES FAITES (${e.doneTasks})`);
  if(e.doneTitles.length===0) lines.push("‚Äî");
  else e.doneTitles.forEach(t=>lines.push(`- ${t}`));
  lines.push("");
  lines.push(`T√ÇCHES RESTANTES (${e.remainingTasks})`);
  if(e.remainingTitles.length===0) lines.push("‚Äî");
  else e.remainingTitles.forEach(t=>lines.push(`- ${t}`));
  lines.push("");
  lines.push(`HABITUDES`);
  if(!e.habits || e.habits.length===0) lines.push("‚Äî");
  else e.habits.forEach(h=>lines.push(`- ${h.name}: ${h.done}/${h.total}`));
  lines.push("");
  lines.push(`SETS`);
  const hs = e.sets?.hospital || {done:0,total:0};
  const cs = e.sets?.consult || {done:0,total:0};
  lines.push(`- HOSPITALIER: ${hs.done}/${hs.total}`);
  lines.push(`- CONSULTATION: ${cs.done}/${cs.total}`);
  lines.push("");
  lines.push(`STATS`);
  lines.push(`- √âTORIONS D√âGOMM√âS (cumul session): ${e.doneEtorions}`);
  lines.push(`- √âTORIONS BASE (au d√©marrage): ${e.baselineEtorions}`);
  return lines.join("\n");
}

/* -------------------------
   Kiffance (by duration buckets)
------------------------- */
function kBucket(min){
  if(min<=5) return "5";
  if(min<=10) return "10";
  if(min<=15) return "15";
  return "25";
}
function pickKiffance(){
  const min = state.settings.etorionMin || 5;
  const b = kBucket(min);
  const list = state.kiffance.bank[b] || [];
  if(list.length===0) return "Respire. Puis reviens.";
  return list[rand(list.length)];
}
function addKiffanceItem(bucket, text){
  const t = (text||"").trim();
  if(!t) return;
  if(!state.kiffance.bank[bucket]) state.kiffance.bank[bucket]=[];
  state.kiffance.bank[bucket].push(t);
  saveState();
}

/* -------------------------
   Confetti (no sound)
------------------------- */
const conf = $("confetti");
const ctx = conf.getContext("2d");
let confettiPieces = [];
function resizeCanvas(){
  conf.width = window.innerWidth * devicePixelRatio;
  conf.height = window.innerHeight * devicePixelRatio;
  conf.style.width = window.innerWidth+"px";
  conf.style.height = window.innerHeight+"px";
  ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
}
window.addEventListener("resize", resizeCanvas);
resizeCanvas();

function confettiBurst(){
  const w = window.innerWidth;
  const h = window.innerHeight;
  const n = 120;
  const centerX = w/2;
  const centerY = h/3;

  for(let i=0;i<n;i++){
    confettiPieces.push({
      x:centerX,
      y:centerY,
      vx:(Math.random()-0.5)*10,
      vy:(Math.random()-0.8)*12,
      g: 0.35 + Math.random()*0.25,
      r: 2 + Math.random()*3,
      life: 70 + Math.random()*40,
      rot: Math.random()*Math.PI,
      vr: (Math.random()-0.5)*0.3
    });
  }
  animateConfetti();
}
let confettiRAF = null;
function animateConfetti(){
  if(confettiRAF) return;
  const step = ()=>{
    ctx.clearRect(0,0,window.innerWidth,window.innerHeight);
    confettiPieces = confettiPieces.filter(p=>p.life>0);
    for(const p of confettiPieces){
      p.vy += p.g;
      p.x += p.vx;
      p.y += p.vy;
      p.rot += p.vr;
      p.life -= 1;
      // minimal monochrome look: use fg with alpha
      ctx.save();
      ctx.translate(p.x,p.y);
      ctx.rotate(p.rot);
      ctx.globalAlpha = 0.85;
      ctx.fillStyle = getComputedStyle(document.body).getPropertyValue("--fg");
      ctx.fillRect(-p.r, -p.r, p.r*2, p.r*2);
      ctx.restore();
    }
    if(confettiPieces.length>0){
      confettiRAF = requestAnimationFrame(step);
    }else{
      cancelAnimationFrame(confettiRAF);
      confettiRAF = null;
      ctx.clearRect(0,0,window.innerWidth,window.innerHeight);
    }
  };
  confettiRAF = requestAnimationFrame(step);
}

/* -------------------------
   UI: Drawer tabs + views (regroup√©s, moins d‚Äôonglets)
------------------------- */
const TAB_DEFS = [
  { key:"inbox",   label:"INBOX" },     // import
  { key:"liste",   label:"LISTE" },     // manage tasks + categories
  { key:"flow",    label:"FLOW" },      // fatigue/motivation/tips/celebration + display prefs
  { key:"kiff",    label:"KIFFANCE" },  // bank + refresh
  { key:"habits",  label:"HABITUDES" }, // habits tracker
  { key:"sets",    label:"SETS" },      // sets settings + export
  { key:"hist",    label:"HIST" }       // export + calendar
];

function buildTabs(){
  const el = $("tabs");
  el.innerHTML = "";
  TAB_DEFS.forEach(t=>{
    const b = document.createElement("div");
    b.className = "tab"+(state.activeTab===t.key?" active":"");
    b.textContent = t.label;
    b.onclick = ()=>{ state.activeTab=t.key; saveState(); renderDrawer(); };
    el.appendChild(b);
  });
}

/* -------------------------
   Drawer views content
------------------------- */
function renderDrawer(){
  buildTabs();
  const body = $("drawerBody");
  body.innerHTML = "";

  if(state.activeTab==="inbox"){
    body.appendChild(viewInbox());
  }else if(state.activeTab==="liste"){
    body.appendChild(viewListe());
  }else if(state.activeTab==="flow"){
    body.appendChild(viewFlow());
  }else if(state.activeTab==="kiff"){
    body.appendChild(viewKiffance());
  }else if(state.activeTab==="habits"){
    body.appendChild(viewHabits());
  }else if(state.activeTab==="sets"){
    body.appendChild(viewSets());
  }else if(state.activeTab==="hist"){
    body.appendChild(viewHist());
  }
}

function viewInbox(){
  const wrap = document.createElement("div");
  wrap.className = "section";

  wrap.innerHTML = `
    <h3>Importer des t√¢ches</h3>
    <div class="small" style="margin-bottom:8px">
      Format: cat√©gorie en MAJUSCULE, puis lignes de t√¢ches. Un chiffre en fin = √©torions.<br/>
      Exemple:<br/>
      <span style="font-family:var(--mono2)">APPELS<br/>Appeler X - 2<br/>Appeler Y 1</span>
    </div>
    <textarea id="inboxArea" placeholder="Colle ta liste ici"></textarea>
    <div class="row" style="margin-top:8px">
      <button class="btn primary" id="btnImport">IMPORTER</button>
      <button class="btn" id="btnClearInbox">VIDER</button>
    </div>
    <div class="small" id="importMsg" style="margin-top:8px"></div>
  `;

  setTimeout(()=>{
    const btn = $("btnImport");
    const area = $("inboxArea");
    const msg = $("importMsg");
    $("btnClearInbox").onclick = ()=>{ area.value=""; };
    btn.onclick = ()=>{
      const txt = area.value || "";
      const imported = importFromInbox(txt);
      if(imported.length===0){
        msg.textContent = "Rien import√©. V√©rifie le format.";
        return;
      }
      // Append without auto-preloaded tasks (important requirement)
      state.tasks.push(...imported);
      // baseline only set if empty
      if(state.baseline.totalTasks===0 && state.baseline.totalEtorions===0){
        const act = activeTasks();
        state.baseline.totalTasks = act.length;
        state.baseline.totalEtorions = act.reduce((a,t)=>a+(t.etorionsTotal||0),0);
      }else{
        // baseline stays: user asked baseline start full; but if they import mid-run,
        // we expand baseline to keep bar meaningful
        state.baseline.totalTasks += imported.length;
        state.baseline.totalEtorions += imported.reduce((a,t)=>a+(t.etorionsTotal||0),0);
      }

      saveState();
      ensureCurrentTask();
      renderAll();

      msg.textContent = `${imported.length} ${plural(imported.length,"t√¢che import√©e","t√¢ches import√©es")}.`;
    };
  },0);

  return wrap;
}

function viewListe(){
  const wrap = document.createElement("div");
  wrap.className = "section";
  const cats = Array.from(new Set(state.tasks.map(t=>t.cat))).sort((a,b)=>a.localeCompare(b,"fr"));

  wrap.innerHTML = `
    <h3>Liste + tri</h3>
    <div class="row" style="margin-bottom:8px">
      <select id="sortSel">
        <option value="roulette">roulette (pinned d‚Äôabord)</option>
        <option value="ordre">ordre d‚Äôimport</option>
        <option value="alpha">alphab√©tique</option>
        <option value="cat">par cat√©gorie</option>
      </select>
      <button class="btn" id="btnPurgeDone">PURGER FAITES</button>
    </div>

    <div class="section" style="margin-bottom:10px">
      <h3>Cat√©gories incluses</h3>
      <div class="small" style="margin-bottom:8px">Vide = toutes. Sinon, coche celles √† inclure.</div>
      <div id="catsBox"></div>
      <div class="row" style="margin-top:8px">
        <button class="btn" id="catsAll">TOUTES</button>
        <button class="btn" id="catsNone">AUCUNE</button>
      </div>
    </div>

    <div class="section">
      <h3>T√¢ches (minimal)</h3>
      <div id="taskListBox"></div>
    </div>
  `;

  setTimeout(()=>{
    $("sortSel").value = state.settings.listSort || "roulette";
    $("sortSel").onchange = (e)=>{
      state.settings.listSort = e.target.value;
      saveState();
      renderAll();
      renderDrawer();
    };

    $("btnPurgeDone").onclick = ()=>{
      state.tasks = state.tasks.filter(t=>!t.done);
      // reset baseline to current active totals (keeps logic clean)
      const act = activeTasks();
      state.baseline.totalTasks = act.length;
      state.baseline.totalEtorions = act.reduce((a,t)=>a+(t.etorionsTotal||0),0);
      saveState();
      ensureCurrentTask();
      renderAll();
      renderDrawer();
    };

    // categories included
    const catsBox = $("catsBox");
    const inc = state.settings.includedCats || [];
    catsBox.innerHTML = cats.map(c=>{
      const checked = inc.length===0 ? true : inc.includes(c);
      return `
        <div class="row" style="justify-content:space-between; margin:6px 0">
          <div style="flex:1; min-width:0; font-size:13px; color:var(--fg); overflow:hidden; text-overflow:ellipsis; white-space:nowrap">${escapeHTML(c)}</div>
          <div class="check ${checked?"on":""}" data-cat="${escapeHTML(c)}">${checked?"‚úì":""}</div>
        </div>
      `;
    }).join("");

    catsBox.querySelectorAll(".check").forEach(el=>{
      el.onclick = ()=>{
        const c = el.getAttribute("data-cat");
        // if inc empty means all; switch to explicit list excluding clicked if turning off
        let list = state.settings.includedCats || [];
        if(list.length===0){
          list = [...cats];
        }
        if(list.includes(c)){
          list = list.filter(x=>x!==c);
        }else{
          list.push(c);
        }
        // if list equals all cats => keep empty (all)
        const normalized = list.length===cats.length ? [] : list;
        state.settings.includedCats = normalized;
        saveState();
        ensureCurrentTask();
        renderAll();
        renderDrawer();
      };
    });

    $("catsAll").onclick = ()=>{
      state.settings.includedCats = [];
      saveState();
      ensureCurrentTask();
      renderAll();
      renderDrawer();
    };
    $("catsNone").onclick = ()=>{
      state.settings.includedCats = [];
      // none is tricky; we interpret "none" as empty tasks view; so set to impossible cat
      state.settings.includedCats = ["__NONE__"];
      saveState();
      ensureCurrentTask();
      renderAll();
      renderDrawer();
    };

    // task list minimal controls: up/down/edit/delete + mark done
    const box = $("taskListBox");
    const list = sortTasks(state.tasks.filter(t=>!t.done));
    box.innerHTML = list.length===0 ? `<div class="small">Aucune t√¢che en cours.</div>` : list.map(t=>{
      const et = t.etorionsTotal||1;
      const left = t.etorionsLeft??et;
      const isCur = t.id===state.currentTaskId;
      return `
        <div class="taskRow" style="${isCur?"background:linear-gradient(180deg,var(--glass2),transparent); border-radius:10px; border:1px solid var(--line)":""}">
          <div class="t">${escapeHTML(t.title)}</div>
          <div class="meta">${left}/${et}</div>
          <div class="tools">
            <div class="toolBtn" data-act="up" data-id="${t.id}" title="Monter">‚Üë</div>
            <div class="toolBtn" data-act="down" data-id="${t.id}" title="Descendre">‚Üì</div>
            <div class="toolBtn" data-act="edit" data-id="${t.id}" title="√âditer">‚âã</div>
            <div class="toolBtn" data-act="done" data-id="${t.id}" title="D√©gomm√©e">‚úì</div>
            <div class="toolBtn" data-act="del" data-id="${t.id}" title="Supprimer">√ó</div>
          </div>
        </div>
      `;
    }).join("");

    box.querySelectorAll(".toolBtn").forEach(b=>{
      b.onclick = ()=>{
        const id = b.getAttribute("data-id");
        const act = b.getAttribute("data-act");
        if(act==="up") moveTask(id,-1);
        if(act==="down") moveTask(id,1);
        if(act==="edit") editTaskPrompt(id);
        if(act==="done") completeTask(id);
        if(act==="del") deleteTask(id);
        saveState();
        ensureCurrentTask();
        renderAll();
        renderDrawer();
      };
    });
  },0);

  return wrap;
}

function viewFlow(){
  const wrap = document.createElement("div");
  wrap.className = "section";
  wrap.innerHTML = `
    <h3>Flow (param√®tres)</h3>

    <div class="section" style="margin-bottom:10px">
      <h3>√ânergie</h3>
      <div class="row">
        <div>
          <div class="small">Fatigue (0‚Äì4)</div>
          <input id="fatigue" type="number" min="0" max="4" />
        </div>
        <div>
          <div class="small">Motivation (0‚Äì4)</div>
          <input id="motivation" type="number" min="0" max="4" />
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <div>
          <div class="small">Surprise c√©l√©bration (0‚Äì1)</div>
          <input id="celeChance" type="number" step="0.05" min="0" max="1" />
        </div>
        <div>
          <div class="small">Auto-fermeture c√©l√©bration (sec)</div>
          <input id="celeSec" type="number" min="4" max="20" />
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <div>
          <div class="small">Conseils flow (0‚Äì1)</div>
          <input id="tipsChance" type="number" step="0.05" min="0" max="1" />
        </div>
        <div>
          <div class="small">Gap conseils (min)</div>
          <input id="tipsGap" type="number" min="2" max="30" />
        </div>
      </div>
    </div>

    <div class="section" style="margin-bottom:10px">
      <h3>Affichage</h3>
      <div class="row">
        <div>
          <div class="small">√ât. 1 √©torion = (min)</div>
          <input id="etoMin" type="number" min="1" max="60" />
        </div>
        <div>
          <div class="small">Liste visible en focus</div>
          <select id="listFocus">
            <option value="true">oui</option>
            <option value="false">non</option>
          </select>
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn primary" id="saveFlow">SAUVER</button>
        <button class="btn" id="testTip">TEST CONSEIL</button>
        <button class="btn" id="testCele">TEST C√âL√âBRATION</button>
      </div>
    </div>

    <div class="small">
      Note: rien n‚Äôest affich√© en permanence sur l‚Äôinterface, sauf l‚Äôessentiel. Les conseils et c√©l√©brations restent des surprises.
    </div>
  `;
  setTimeout(()=>{
    $("fatigue").value = state.settings.fatigue;
    $("motivation").value = state.settings.motivation;
    $("celeChance").value = state.settings.celebrationChance;
    $("celeSec").value = state.settings.celebrationAutoCloseSec;
    $("tipsChance").value = state.settings.tipsChance;
    $("tipsGap").value = state.settings.tipsMinGapMin;
    $("etoMin").value = state.settings.etorionMin;
    $("listFocus").value = String(!!state.settings.keepListInFocus);

    $("saveFlow").onclick = ()=>{
      state.settings.fatigue = clamp(parseInt($("fatigue").value,10)||0,0,4);
      state.settings.motivation = clamp(parseInt($("motivation").value,10)||0,0,4);
      state.settings.celebrationChance = clamp(Number($("celeChance").value)||0,0,1);
      state.settings.celebrationAutoCloseSec = clamp(parseInt($("celeSec").value,10)||10,4,20);
      state.settings.tipsChance = clamp(Number($("tipsChance").value)||0,0,1);
      state.settings.tipsMinGapMin = clamp(parseInt($("tipsGap").value,10)||6,2,30);
      state.settings.etorionMin = clamp(parseInt($("etoMin").value,10)||5,1,60);
      state.settings.keepListInFocus = ($("listFocus").value==="true");
      saveState();
      renderAll();
      renderDrawer();
    };
    $("testTip").onclick = ()=>showTip();
    $("testCele").onclick = ()=>showCelebration();
  },0);
  return wrap;
}

function viewKiffance(){
  const wrap = document.createElement("div");
  wrap.className = "section";

  wrap.innerHTML = `
    <h3>Kiffance</h3>

    <div class="section" style="margin-bottom:10px">
      <h3>Suggestion (selon dur√©e √©torion)</h3>
      <div class="row">
        <button class="btn primary" id="kPick">RAFRA√éCHIR</button>
        <button class="btn" id="kAddToTasks">AJOUTER EN T√ÇCHE</button>
      </div>
      <div id="kOut" class="bigMsg" style="margin-top:10px"></div>
      <div class="small" style="text-align:center">Cat√©gorie: <span id="kCat"></span></div>
    </div>

    <div class="section" style="margin-bottom:10px">
      <h3>Banque (visible)</h3>
      <div class="row">
        <select id="kBucket">
          <option value="5">‚â§ 5 min</option>
          <option value="10">‚â§ 10 min</option>
          <option value="15">‚â§ 15 min</option>
          <option value="25">‚â• 25 min</option>
        </select>
        <button class="btn" id="kShow">AFFICHER</button>
      </div>
      <div id="kList" class="small" style="margin-top:8px"></div>
    </div>

    <div class="section">
      <h3>Ajouter √† la banque</h3>
      <select id="kAddBucket">
        <option value="5">‚â§ 5 min</option>
        <option value="10">‚â§ 10 min</option>
        <option value="15">‚â§ 15 min</option>
        <option value="25">‚â• 25 min</option>
      </select>
      <textarea id="kText" placeholder="Ajoute une kiffance (sans emoji, simple, actionnable)."></textarea>
      <div class="row" style="margin-top:8px">
        <button class="btn primary" id="kAdd">AJOUTER</button>
      </div>
    </div>
  `;

  setTimeout(()=>{
    let last = pickKiffance();
    $("kOut").textContent = last;
    $("kCat").textContent = kBucket(state.settings.etorionMin||5);

    $("kPick").onclick = ()=>{
      last = pickKiffance();
      $("kOut").textContent = last;
      $("kCat").textContent = kBucket(state.settings.etorionMin||5);
      saveState();
    };
    $("kAddToTasks").onclick = ()=>{
      // Add as task in category "KIFFANCE"
      const t = last.trim();
      if(!t) return;
      const et = 1; // small
      const newT = {
        id: uid(),
        title: t,
        cat: "KIFFANCE",
        etorionsTotal: et,
        etorionsLeft: et,
        pinned: false,
        priority: 0,
        done: false,
        createdAt: nowISO(),
        doneAt: null
      };
      state.tasks.push(newT);
      state.baseline.totalTasks += 1;
      state.baseline.totalEtorions += et;
      saveState();
      ensureCurrentTask();
      renderAll();
      renderDrawer();
    };

    $("kShow").onclick = ()=>{
      const b = $("kBucket").value;
      const list = state.kiffance.bank[b] || [];
      $("kList").innerHTML = list.length===0 ? "‚Äî" : list.map((x,i)=>`
        <div style="padding:6px 4px; border-bottom:1px solid var(--line)">
          <span style="font-family:var(--mono2); color:var(--muted); font-size:11px">${i+1}</span>
          <span style="margin-left:8px">${escapeHTML(x)}</span>
        </div>
      `).join("");
    };

    $("kAdd").onclick = ()=>{
      const b = $("kAddBucket").value;
      const txt = $("kText").value;
      addKiffanceItem(b, txt);
      $("kText").value = "";
      renderDrawer();
    };
  },0);

  return wrap;
}

function viewHabits(){
  const wrap = document.createElement("div");
  wrap.className = "section";

  wrap.innerHTML = `
    <h3>Habitudes</h3>

    <div class="section" style="margin-bottom:10px">
      <h3>Ajouter</h3>
      <div class="row">
        <input id="hName" placeholder="Nom de l'habitude (ex: boire des verres d'eau)" />
        <input id="hSlots" type="number" min="3" max="12" value="8" />
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn primary" id="hAdd">AJOUTER</button>
      </div>
    </div>

    <div class="section">
      <h3>Liste</h3>
      <div id="hList"></div>
    </div>
  `;

  setTimeout(()=>{
    $("hAdd").onclick = ()=>{
      addHabit($("hName").value, $("hSlots").value);
      $("hName").value="";
      saveState();
      renderDrawer();
      renderAll();
      snapshotDay();
    };
    renderHabitsList();
  },0);

  return wrap;
}
function renderHabitsList(){
  const box = $("hList");
  if(!box) return;
  const list = state.habits || [];
  if(list.length===0){
    box.innerHTML = `<div class="small">Aucune habitude.</div>`;
    return;
  }
  box.innerHTML = list.map(h=>{
    const p = habitProgress(h);
    const checks = h.checks.map((v,idx)=>`
      <div class="check ${v?"on":""}" data-h="${h.id}" data-i="${idx}">${v?"‚úì":""}</div>
    `).join("");
    return `
      <div class="section" style="margin-bottom:10px">
        <h3>${escapeHTML(h.name)} <span style="font-weight:400; letter-spacing:.06em">(${p.done}/${p.tot})</span></h3>
        <div class="row" style="gap:6px; align-items:center; justify-content:flex-start">
          <div style="display:flex; gap:6px; flex-wrap:wrap">${checks}</div>
        </div>
        <div class="row" style="margin-top:8px">
          <button class="btn" data-act="resetHabit" data-h="${h.id}">RESET</button>
          <button class="btn" data-act="delHabit" data-h="${h.id}">SUPPRIMER</button>
        </div>
      </div>
    `;
  }).join("");

  box.querySelectorAll(".check").forEach(el=>{
    el.onclick = ()=>{
      const hId = el.getAttribute("data-h");
      const i = parseInt(el.getAttribute("data-i"),10);
      toggleHabitCheck(hId, i);
      renderHabitsList();
    };
  });
  box.querySelectorAll("button[data-act]").forEach(b=>{
    b.onclick = ()=>{
      const act = b.getAttribute("data-act");
      const hId = b.getAttribute("data-h");
      const h = state.habits.find(x=>x.id===hId);
      if(!h) return;
      if(act==="resetHabit"){
        h.checks = h.checks.map(()=>false);
      }
      if(act==="delHabit"){
        state.habits = state.habits.filter(x=>x.id!==hId);
      }
      saveState();
      renderDrawer();
      renderAll();
      snapshotDay();
    };
  });
}

function viewSets(){
  const wrap = document.createElement("div");
  wrap.className = "section";
  initSetsChecksForToday();

  wrap.innerHTML = `
    <h3>Sets</h3>
    <div class="small" style="margin-bottom:10px">
      Objectif: tour de salle / consultation sans oublis. Les sets sont visibles √† droite (masquables).
    </div>

    <div class="section" style="margin-bottom:10px">
      <h3>Hospitalier</h3>
      <div class="row">
        <input id="hospPatients" type="number" min="1" max="20" />
        <button class="btn" id="hospResetToday">RESET AUJOURD'HUI</button>
      </div>
      <div class="small" style="margin-top:8px">Fragments par patient: Voir patient ¬∑ Note ¬∑ Traitement ¬∑ Dossier</div>
    </div>

    <div class="section" style="margin-bottom:10px">
      <h3>Consultation</h3>
      <div class="row">
        <input id="consPatients" type="number" min="1" max="30" />
        <button class="btn" id="consResetToday">RESET AUJOURD'HUI</button>
      </div>
      <div class="small" style="margin-top:8px">Fragments par patient: Voir patient ¬∑ Note ¬∑ Ordonnance ¬∑ Dossier</div>
    </div>

    <div class="section">
      <h3>Export</h3>
      <div class="row">
        <button class="btn primary" id="expCopy">COPIER RAPPORT DU JOUR</button>
        <button class="btn" id="expDownload">T√âL√âCHARGER .TXT</button>
      </div>
      <textarea id="expArea" style="margin-top:8px"></textarea>
    </div>
  `;

  setTimeout(()=>{
    $("hospPatients").value = state.sets.hospital.patients;
    $("consPatients").value = state.sets.consult.patients;

    $("hospPatients").onchange = (e)=>{
      state.sets.hospital.patients = clamp(parseInt(e.target.value,10)||4,1,20);
      saveState();
      renderSetsPanel();
    };
    $("consPatients").onchange = (e)=>{
      state.sets.consult.patients = clamp(parseInt(e.target.value,10)||6,1,30);
      saveState();
      renderSetsPanel();
    };

    $("hospResetToday").onclick = ()=>{ resetSetToday("hospital"); };
    $("consResetToday").onclick = ()=>{ resetSetToday("consult"); };

    const txt = exportTodayText();
    $("expArea").value = txt;

    $("expCopy").onclick = async ()=>{
      snapshotDay();
      const t = exportTodayText();
      $("expArea").value = t;
      try{ await navigator.clipboard.writeText(t); }catch(e){}
    };
    $("expDownload").onclick = ()=>{
      snapshotDay();
      const t = exportTodayText();
      $("expArea").value = t;
      const blob = new Blob([t], {type:"text/plain;charset=utf-8"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `eliminator_${dayKey()}.txt`;
      a.click();
      URL.revokeObjectURL(a.href);
    };
  },0);

  return wrap;
}

function viewHist(){
  const wrap = document.createElement("div");
  wrap.className = "section";
  snapshotDay();

  wrap.innerHTML = `
    <h3>Historique + calendrier</h3>
    <div class="small" style="margin-bottom:10px">
      Vision simple: jours r√©cents + un mini-calendrier d‚Äôactivit√© (t√¢ches/jour).
    </div>

    <div class="section" style="margin-bottom:10px">
      <h3>Jours r√©cents</h3>
      <div id="histList"></div>
    </div>

    <div class="section">
      <h3>Calendrier (30 jours)</h3>
      <div id="calGrid" style="display:grid; grid-template-columns: repeat(10, 1fr); gap:6px"></div>
      <div class="small" style="margin-top:8px">
        Intensit√© = nombre de t√¢ches faites. (Monochrome, vitr√©.)
      </div>
    </div>
  `;

  setTimeout(()=>{
    const box = $("histList");
    const hist = (state.history||[]).slice(0,14);
    box.innerHTML = hist.length===0 ? "‚Äî" : hist.map(h=>{
      return `
        <div style="padding:8px 6px; border-bottom:1px solid var(--line)">
          <div style="font-family:var(--mono2); color:var(--muted); font-size:11px; letter-spacing:.08em">${h.day}</div>
          <div style="font-size:13px">Faites: ${h.doneTasks} ¬∑ Restantes: ${h.remainingTasks} ¬∑ √âtorions: ${h.doneEtorions}</div>
        </div>
      `;
    }).join("");

    // calendar (last 30 days)
    const grid = $("calGrid");
    const days = [];
    const today = new Date();
    for(let i=29;i>=0;i--){
      const d = new Date(today);
      d.setDate(today.getDate()-i);
      days.push(dayKey(d));
    }
    const map = {};
    (state.history||[]).forEach(e=>{ map[e.day] = e.doneTasks || 0; });
    const max = Math.max(1, ...Object.values(map));
    grid.innerHTML = days.map(dk=>{
      const v = map[dk] || 0;
      const intensity = clamp(v/max, 0, 1);
      // Use accent alpha, still monochrome-ish
      const a = 0.08 + intensity*0.38;
      return `
        <div title="${dk} ‚Äî ${v} ${plural(v,"t√¢che","t√¢ches")}"
             style="
              height:26px;
              border-radius:10px;
              border:1px solid var(--line);
              background: rgba(0,0,0,.02);
              position:relative;
              overflow:hidden;">
          <div style="position:absolute; inset:0; background: var(--accent); opacity:${a};"></div>
          <div style="position:absolute; inset:0; display:grid; place-items:center; font-family:var(--mono2); font-size:10px; color:var(--muted)">
            ${String(new Date(dk).getDate()).padStart(2,"0")}
          </div>
        </div>
      `;
    }).join("");
  },0);

  return wrap;
}

/* -------------------------
   Task management ops
------------------------- */
function moveTask(id, delta){
  const idx = state.tasks.findIndex(t=>t.id===id);
  if(idx<0) return;
  const j = clamp(idx+delta, 0, state.tasks.length-1);
  const [it] = state.tasks.splice(idx,1);
  state.tasks.splice(j,0,it);
}
function deleteTask(id){
  const t = getTaskById(id);
  if(!t) return;
  const wasActive = !t.done;
  state.tasks = state.tasks.filter(x=>x.id!==id);
  if(wasActive){
    // adjust baseline so bar remains coherent
    state.baseline.totalTasks = Math.max(0, (state.baseline.totalTasks||0) - 1);
    state.baseline.totalEtorions = Math.max(0, (state.baseline.totalEtorions||0) - (t.etorionsTotal||0));
  }
  if(state.currentTaskId===id){
    state.currentTaskId=null; state.currentTaskStart=null;
  }
}
function editTaskPrompt(id){
  const t = getTaskById(id);
  if(!t) return;
  const nv = prompt("√âditer la t√¢che (titre)", t.title);
  if(nv===null) return;
  const v = nv.trim();
  if(!v) return;
  t.title = v;
}

/* -------------------------
   Theme / Focus / Drawer / Modals
------------------------- */
function applyTheme(){
  document.body.setAttribute("data-theme", state.theme);
  $("themeLabel").textContent = state.theme==="light" ? "TH√àME CLAIR" : "TH√àME SOMBRE";
}
function toggleTheme(){
  state.theme = (state.theme==="light") ? "dark" : "light";
  saveState();
  renderAll();
}
function applyFocus(){
  const app = $("app");
  if(state.focus) app.classList.add("focusOn");
  else app.classList.remove("focusOn");
  $("pillMode").textContent = `mode: ${state.focus ? "focus" : "normal"}`;
}
function toggleFocus(){
  state.focus = !state.focus;
  saveState();
  applyFocus();
  // In focus, hide everything except essentials; keep list if setting enabled and showBelowList true
  renderAll();
}
function openDrawer(){
  $("drawerBack").classList.add("show");
  $("drawer").classList.add("open");
  renderDrawer();
}
function closeDrawer(){
  $("drawerBack").classList.remove("show");
  $("drawer").classList.remove("open");
}
function openModal(id){
  $("modalBack").style.display = "block";
  $(id).style.display = "flex";
}
function closeModal(id){
  $(id).style.display = "none";
  // close back only if no other modal open
  const anyOpen = ["notesModal","celeModal","tipsModal"].some(mid => $(mid).style.display==="flex");
  if(!anyOpen){
    $("modalBack").style.display = "none";
  }
}

/* -------------------------
   Sets panel render
------------------------- */
function renderSetsPanel(){
  const panel = $("setsPanel");
  if(!state.showSets){
    panel.classList.remove("show");
    return;
  }
  panel.classList.add("show");
  initSetsChecksForToday();
  const dk = dayKey();

  const buildSet = (key, title)=>{
    const set = state.sets[key];
    const checks = set.checks?.[dk] || {};
    const items = set.itemsPerPatient;
    let html = `<div class="setCard">
      <div class="name">${title}</div>
      <div class="small" style="margin-bottom:8px">Patients: ${set.patients} ¬∑ ${Object.values(checks).filter(Boolean).length}/${set.patients*items.length}</div>
      <div class="row" style="margin-bottom:8px">
        <button class="btn tiny" data-reset="${key}">RESET AUJOURD'HUI</button>
      </div>`;
    for(let p=1;p<=set.patients;p++){
      html += `<div class="small" style="font-family:var(--mono2); letter-spacing:.06em; margin-top:8px">Patient ${p}</div>`;
      items.forEach((it,idx)=>{
        const k = setKeyItem(key,p,idx);
        const on = !!checks[k];
        html += `
          <div class="setItem">
            <div class="check ${on?"on":""}" data-set="${key}" data-p="${p}" data-i="${idx}">${on?"‚úì":""}</div>
            <div style="font-size:13px; color:var(--fg)">${escapeHTML(it)}</div>
          </div>
        `;
      });
    }
    html += `</div>`;
    return html;
  };

  $("setsContent").innerHTML = buildSet("hospital","HOSPITALIER") + buildSet("consult","CONSULTATION");

  $("setsContent").querySelectorAll(".check").forEach(el=>{
    el.onclick = ()=>{
      const set = el.getAttribute("data-set");
      const p = parseInt(el.getAttribute("data-p"),10);
      const i = parseInt(el.getAttribute("data-i"),10);
      toggleSetCheck(set, p, i);
    };
  });
  $("setsContent").querySelectorAll("button[data-reset]").forEach(b=>{
    b.onclick = ()=>{
      resetSetToday(b.getAttribute("data-reset"));
    };
  });
}

/* -------------------------
   Rendering main UI
------------------------- */
function setRandomTagline(force=false){
  const elTag = $("tagline");
  if(!elTag) return;
  if(force || Math.random()<0.25 || !elTag.textContent.trim()){
    elTag.textContent = TAGLINE_POOL[rand(TAGLINE_POOL.length)];
  }
}
function renderHUD(){
  recomputeBaselineIfNeeded();
  const p = computeProgress();

  // tasks: remaining/starting
  $("pillTasks").textContent = `${p.remT}/${p.baseT} ${plural(p.baseT,"t√¢che","t√¢ches")}`;
  $("pillEto").textContent = `${p.remE}/${p.baseE} √©torions`;
  const done = (p.baseT - p.remT);
  $("pillDone").textContent = `${done} ${plural(done,"faite","faites")}`;

  // flow indicator (simple)
  const f = clamp(state.settings.fatigue,0,4);
  const m = clamp(state.settings.motivation,0,4);
  const flow = (m>=3 && f<=2) ? "fort" : (m<=1 && f>=3) ? "fragile" : "stable";
  $("pillFlow").textContent = `flow: ${flow}`;
}
function renderTimer(){
  const el = $("pillTimer");
  if(!state.currentTaskStart){
    el.textContent = "00:00";
    return;
  }
  const ms = Date.now() - state.currentTaskStart;
  el.textContent = fmtMMSS(ms);
}
let timerInterval = null;
function startTimerLoop(){
  if(timerInterval) clearInterval(timerInterval);
  timerInterval = setInterval(()=>{
    renderTimer();
  }, 500);
}
function renderProgress(){
  const p = computeProgress();
  // Bar should start 100% and DECREASE as tasks done => fill = remaining/base
  const fillPct = p.pct;
  $("taskBarFill").style.width = `${fillPct}%`;
  $("taskBarPct").textContent = `${fillPct}%`;
  $("barInfo").textContent = `${p.remT} restantes sur ${p.baseT}`;
}
function renderCurrent(){
  ensureCurrentTask();
  const t = getTaskById(state.currentTaskId);

  if(!t){
    $("taskName").textContent = "Aucune t√¢che";
    $("chips").innerHTML = "";
    $("btnEtorion").style.opacity = 0.5;
    $("btnEtorion").style.pointerEvents = "none";
    return;
  }

  $("btnEtorion").style.opacity = 1;
  $("btnEtorion").style.pointerEvents = "auto";

  // IMPORTANT: do not append durations or extra info to task name
  $("taskName").textContent = t.title;

  // chips show etorions total, filled for remaining
  const total = t.etorionsTotal || 1;
  const left = (typeof t.etorionsLeft==="number") ? t.etorionsLeft : total;
  const chips = [];
  for(let i=0;i<total;i++){
    const on = i < left;
    chips.push(`<div class="chip ${on?"on":""}"></div>`);
  }
  $("chips").innerHTML = chips.join("");

  // timer: if current changed and no start set, set
  if(!state.currentTaskStart) state.currentTaskStart = Date.now();
}

function applyListVisible(){
  const show = !!state.showBelowList;
  const el = $("belowList");
  if(show){
    el.classList.add("show");
  }else{
    el.classList.remove("show");
  }

  // In focus mode, list visibility depends on setting
  if(state.focus && !state.settings.keepListInFocus){
    el.classList.remove("show");
  }
}
function renderBelowList(){
  const box = $("belowTasks");
  const list = sortTasks(activeTasks());
  if(list.length===0){
    box.innerHTML = `<div class="small">Aucune t√¢che.</div>`;
    return;
  }
  box.innerHTML = list.slice(0,30).map(t=>{
    const et = t.etorionsTotal||1;
    const left = t.etorionsLeft??et;
    const isCur = t.id===state.currentTaskId;
    return `
      <div class="taskRow" style="${isCur?"background:linear-gradient(180deg,var(--glass2),transparent); border-radius:10px; border:1px solid var(--line)":""}">
        <div class="t">${escapeHTML(t.title)}</div>
        <div class="meta">${left}/${et}</div>
        <div class="tools">
          <div class="toolBtn" data-act="up" data-id="${t.id}" title="Monter">‚Üë</div>
          <div class="toolBtn" data-act="down" data-id="${t.id}" title="Descendre">‚Üì</div>
          <div class="toolBtn" data-act="pin" data-id="${t.id}" title="√âpingler">${t.pinned?"‚ñ†":"‚ñ°"}</div>
          <div class="toolBtn" data-act="done" data-id="${t.id}" title="D√©gomm√©e">‚úì</div>
        </div>
      </div>
    `;
  }).join("");

  box.querySelectorAll(".toolBtn").forEach(b=>{
    b.onclick = ()=>{
      const id = b.getAttribute("data-id");
      const act = b.getAttribute("data-act");
      const t = getTaskById(id);
      if(!t) return;
      if(act==="up") moveTask(id,-1);
      if(act==="down") moveTask(id,1);
      if(act==="pin") t.pinned = !t.pinned;
      if(act==="done") completeTask(id);
      saveState();
      ensureCurrentTask();
      renderAll();
    };
  });
}

function renderAll(){
  applyTheme();
  applyFocus();
  setRandomTagline();
  recomputeBaselineIfNeeded();
  ensureCurrentTask();
  renderHUD();
  renderProgress();
  renderCurrent();
  renderBelowList();
  applyListVisible();
  renderSetsPanel();
  renderTimer();
}

/* -------------------------
   Wire buttons
------------------------- */
$("btnMenu").onclick = openDrawer;
$("drawerClose").onclick = closeDrawer;
$("drawerBack").onclick = closeDrawer;

$("btnTheme").onclick = toggleTheme;

$("btnFocus").onclick = ()=>toggleFocus();

$("btnReset").onclick = ()=>{
  // Reset tasks, keep notes + kiffance + habits + history
  state.tasks = [];
  state.baseline = { totalTasks:0, totalEtorions:0 };
  state.currentTaskId = null;
  state.currentTaskStart = null;
  state.stats = { etorionsDone:0, tasksDone:0 };
  state.settings.includedCats = [];
  saveState();
  renderAll();
};

$("btnToggleList").onclick = ()=>{
  state.showBelowList = !state.showBelowList;
  saveState();
  renderAll();
};
$("btnHideBelow").onclick = ()=>{
  state.showBelowList = false;
  saveState();
  renderAll();
};

$("btnToggleSets").onclick = ()=>{
  state.showSets = !state.showSets;
  saveState();
  renderAll();
};

$("btnRoulette").onclick = ()=>{
  const el = $("btnRoulette");
  el.classList.remove("rouletteSpin"); // reset
  void el.offsetWidth; // reflow
  el.classList.add("rouletteSpin");

  const pick = roulettePick();
  if(!pick) return;

  // set current task (smooth)
  setTimeout(()=>{
    setCurrentTask(pick.id);
    saveState();
    renderAll();
    maybeShowTip();
  }, 220);
};

$("btnEtorion").onclick = ()=>{
  degommeEtorion();
};

$("btnNotes").onclick = ()=>{
  renderNotes();
  openModal("notesModal");
};
$("notesClose").onclick = ()=>closeModal("notesModal");
$("noteAdd").onclick = ()=>{ addNote($("noteInput").value); $("noteInput").value=""; };
$("noteClear").onclick = ()=>{ $("noteInput").value=""; };

$("btnDoneTask").onclick = ()=>{
  const t = getTaskById(state.currentTaskId);
  if(!t) return;
  completeTask(t.id);
  saveState();
  renderAll();
};

$("btnEditTask").onclick = ()=>{
  const t = getTaskById(state.currentTaskId);
  if(!t) return;
  editTaskPrompt(t.id);
  saveState();
  renderAll();
};

$("celeClose").onclick = ()=>closeModal("celeModal");
$("tipsClose").onclick = ()=>closeModal("tipsModal");
$("modalBack").onclick = ()=>{
  // close all
  ["notesModal","celeModal","tipsModal"].forEach(closeModal);
};

/* -------------------------
   Start
------------------------- */
applyTheme();
renderAll();
renderDrawer();
startTimerLoop();
snapshotDay();

/* -------------------------
   Tiny extras for flow: when user comes back to app, re-render timer
------------------------- */
document.addEventListener("visibilitychange", ()=>{
  if(!document.hidden){
    renderAll();
  }
});
</script>
</body>
</html>
