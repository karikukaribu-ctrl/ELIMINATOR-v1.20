<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ELIMINATOR</title>
  <style>
    :root{
      --bg:#f4f6fb; --fg:#0d1321; --muted:rgba(13,19,33,.62);
      --glass:rgba(255,255,255,.58); --glass2:rgba(255,255,255,.34);
      --line:rgba(13,19,33,.14); --shadow:0 18px 60px rgba(0,0,0,.10); --blur:18px;
      --accent:rgba(0,140,255,.16); --accent2:rgba(0,140,255,.32);
      --radius:8px; --radius2:6px;
      --appW:min(1220px,96vw);
      --barH:38px;
      --font:ui-sans-serif,system-ui,-apple-system,"SF Pro Display","Segoe UI",Roboto,Helvetica,Arial;
      --mono:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace;
    }
    [data-theme="dark"]{
      --bg:#0b0f17; --fg:#eaf0ff; --muted:rgba(234,240,255,.62);
      --glass:rgba(18,24,38,.60); --glass2:rgba(18,24,38,.36);
      --line:rgba(234,240,255,.14); --shadow:0 18px 80px rgba(0,0,0,.36); --blur:20px;
      --accent:rgba(0,255,140,.14); --accent2:rgba(0,255,140,.28);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:var(--font); color:var(--fg);
      background:
        radial-gradient(1200px 700px at 25% 15%, rgba(255,255,255,.45), transparent 60%),
        radial-gradient(1000px 680px at 80% 30%, rgba(0,0,0,.06), transparent 60%),
        var(--bg);
      overflow-x:hidden;
    }
    body[data-theme="dark"]{
      background:
        radial-gradient(1200px 700px at 25% 15%, rgba(0,255,140,.055), transparent 60%),
        radial-gradient(1100px 720px at 80% 30%, rgba(0,140,255,.045), transparent 60%),
        var(--bg);
    }

    .wrap{min-height:100%;display:flex;flex-direction:column;align-items:center;gap:14px;padding:14px 14px 22px}
    .topbar{
      width:var(--appW); display:flex; justify-content:space-between; align-items:center; gap:10px;
      padding:10px; position:sticky; top:8px; z-index:50;
      border:1px solid var(--line); border-radius:var(--radius);
      background:var(--glass); backdrop-filter:blur(var(--blur)); box-shadow:var(--shadow);
    }
    .left,.right{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .btn{
      border:1px solid var(--line); background:transparent; color:var(--fg);
      border-radius:var(--radius2); padding:8px 10px; font-size:12px;
      letter-spacing:.08em; text-transform:uppercase; cursor:pointer; user-select:none;
      transition:transform 140ms ease, background 120ms ease;
      white-space:nowrap;
    }
    .btn:hover{background:rgba(0,0,0,.04)}
    body[data-theme="dark"] .btn:hover{background:rgba(255,255,255,.05)}
    .btn:active{transform:translateY(1px)}
    .btn.icon{width:40px;height:36px;display:grid;place-items:center;padding:0;font-family:var(--mono);letter-spacing:0;text-transform:none;font-size:15px}

    .pill{
      padding:6px 10px;border-radius:999px;border:1px solid var(--line);
      background:rgba(0,0,0,.03);color:var(--muted);font-size:12px;font-family:var(--mono);
    }
    body[data-theme="dark"] .pill{background:rgba(255,255,255,.04)}
    .pill.hidden{display:none}

    .hero{width:var(--appW);display:flex;flex-direction:column;align-items:center;gap:6px;padding:2px 8px 0}
    .title{
      font-size:clamp(46px,5.4vw,84px); letter-spacing:.22em; text-transform:uppercase;
      margin:6px 0 0; font-weight:900; line-height:1.02; text-align:center;
    }
    .tag{font-size:13px;color:var(--muted);text-align:center;max-width:78ch;min-height:18px}

    .main{width:var(--appW);display:flex;flex-direction:column;gap:16px;flex:1;justify-content:center}
    .card{
      border:1px solid var(--line); border-radius:var(--radius);
      background:var(--glass); backdrop-filter:blur(var(--blur)); box-shadow:var(--shadow);
      padding:16px;
    }

    .barWrap{display:flex;flex-direction:column;gap:10px}
    .barRow{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .barLabel{font-size:12px;letter-spacing:.08em;text-transform:uppercase;color:var(--muted);font-family:var(--mono)}
    .bar{width:100%;height:var(--barH);border:1px solid var(--line);background:rgba(0,0,0,.03);border-radius:var(--radius2);position:relative;overflow:hidden}
    body[data-theme="dark"] .bar{background:rgba(255,255,255,.04)}
    .barFill{position:absolute;inset:0;width:100%;background:radial-gradient(800px 140px at 20% 50%, var(--accent2), transparent 55%),linear-gradient(90deg, var(--accent), transparent 70%);transition:width 220ms ease}
    .barPct{position:absolute;inset:0;display:grid;place-items:center;font-family:var(--mono);font-size:12px;opacity:.92;pointer-events:none}

    .taskName{
      font-size:clamp(34px,4.2vw,64px);font-weight:900;letter-spacing:.01em;
      text-align:center;line-height:1.06;word-break:break-word;margin:6px 0 10px;
    }
    .chips{display:flex;flex-wrap:wrap;gap:6px;justify-content:center}
    .chip{width:18px;height:18px;border-radius:4px;border:1px solid var(--line);background:rgba(0,0,0,.03)}
    body[data-theme="dark"] .chip{background:rgba(255,255,255,.04)}
    .chip.on{background:var(--accent2)}

    .actions{display:flex;gap:12px;justify-content:center;flex-wrap:wrap;align-items:center;margin-top:12px}
    .roulette{
      width:150px;height:150px;border-radius:999px;border:1px solid var(--line);
      background:radial-gradient(circle at 30% 30%, var(--glass2), transparent 60%),linear-gradient(180deg, var(--glass2), transparent);
      backdrop-filter:blur(var(--blur));box-shadow:var(--shadow);
      display:grid;place-items:center;cursor:pointer;user-select:none;position:relative;overflow:hidden;
      transition:transform 140ms ease;
    }
    .roulette:active{transform:translateY(1px) scale(.99)}
    .rouletteText{font-size:12px;letter-spacing:.14em;text-transform:uppercase;font-weight:900;font-family:var(--mono);opacity:.92}
    .rouletteRing{position:absolute;inset:10px;border-radius:999px;border:1px dashed var(--line);opacity:.85}
    .rouletteNeedle{position:absolute;top:10px;left:50%;width:0;height:0;border-left:8px solid transparent;border-right:8px solid transparent;border-bottom:14px solid rgba(0,0,0,.18);transform:translateX(-50%);opacity:.9}
    body[data-theme="dark"] .rouletteNeedle{border-bottom-color:rgba(255,255,255,.18)}
    .rouletteSpin{animation:spin 860ms cubic-bezier(.08,.92,.20,1) 1}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(1080deg)}}

    .bomb{
      min-width:240px;padding:14px 16px;border-radius:var(--radius2);border:1px solid var(--line);
      background:linear-gradient(180deg,var(--glass2),transparent);
      cursor:pointer;text-transform:uppercase;letter-spacing:.10em;font-size:12px;
      display:flex;align-items:center;justify-content:center;gap:12px;user-select:none;box-shadow:var(--shadow);
      transition:transform 140ms ease;
    }
    .bomb:hover{background:rgba(0,0,0,.03)}
    body[data-theme="dark"] .bomb:hover{background:rgba(255,255,255,.04)}
    .bomb:active{transform:translateY(1px) scale(.99)}
    .bomb .em{font-family:var(--mono);font-size:16px;opacity:.92}
    .bomb .label{display:flex;flex-direction:column;line-height:1.10;align-items:center}
    .bomb .label span{font-size:12px;font-family:var(--mono)}
    .bomb .label small{font-size:10px;color:var(--muted);letter-spacing:.14em;text-transform:uppercase;font-family:var(--mono)}

    .miniRow{display:flex;gap:10px;justify-content:center;align-items:center;flex-wrap:wrap;margin-top:12px}
    .miniIcon{
      width:56px;height:56px;border-radius:var(--radius2);border:1px solid var(--line);
      display:grid;place-items:center;cursor:pointer;background:transparent;box-shadow:var(--shadow);
      font-family:var(--mono);font-size:15px;user-select:none;transition:transform 140ms ease, background 120ms ease;
    }
    .miniIcon:hover{background:rgba(0,0,0,.03)}
    body[data-theme="dark"] .miniIcon:hover{background:rgba(255,255,255,.04)}
    .miniIcon:active{transform:translateY(1px) scale(.99)}
    .miniLabel{width:auto;padding:0 12px;font-size:12px;text-transform:uppercase}

    /* panels */
    .panelBack{position:fixed;inset:0;background:rgba(0,0,0,.20);backdrop-filter:blur(10px);display:none;z-index:80}
    .panel{position:fixed;top:0;height:100%;background:var(--glass);border:1px solid var(--line);backdrop-filter:blur(var(--blur));box-shadow:var(--shadow);display:flex;flex-direction:column;z-index:90;transition:transform 220ms ease}
    .panel.left{left:0;width:min(460px,94vw);transform:translateX(-105%);border-left:none}
    .panel.right{right:0;width:min(520px,94vw);transform:translateX(105%);border-right:none}
    .panel.open{transform:translateX(0)}
    .panelTop{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid var(--line);gap:10px}
    .panelTitle{font-size:12px;letter-spacing:.14em;text-transform:uppercase;color:var(--muted);font-family:var(--mono)}
    .panelBody{padding:12px;overflow:auto}
    .section{border:1px solid var(--line);border-radius:var(--radius);padding:10px;background:rgba(0,0,0,.02)}
    body[data-theme="dark"] .section{background:rgba(255,255,255,.03)}
    .section h3{margin:0 0 8px;font-size:11px;letter-spacing:.14em;text-transform:uppercase;color:var(--muted);font-family:var(--mono);font-weight:900}

    textarea,input,select{
      width:100%;border:1px solid var(--line);background:transparent;color:var(--fg);
      border-radius:var(--radius2);padding:10px;outline:none;font-family:var(--font);font-size:13px
    }
    textarea{min-height:140px;resize:vertical}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .row>*{flex:1;min-width:140px}

    .taskRow{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:8px 6px;border-bottom:1px solid var(--line)}
    .taskRow:last-child{border-bottom:none}
    .taskRow .t{flex:1;min-width:0;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .taskRow .meta{font-size:11px;color:var(--muted);font-family:var(--mono);white-space:nowrap}
    .tools{display:flex;gap:6px;align-items:center}
    .toolBtn{width:36px;height:32px;border-radius:var(--radius2);border:1px solid var(--line);display:grid;place-items:center;cursor:pointer;background:transparent;font-family:var(--mono);font-size:12px;user-select:none}
    .toolBtn:hover{background:rgba(0,0,0,.03)}
    body[data-theme="dark"] .toolBtn:hover{background:rgba(255,255,255,.04)}
    .small{font-size:12px;color:var(--muted);font-family:var(--mono)}

    /* confetti */
    #confetti{position:fixed;inset:0;pointer-events:none;z-index:140}
  </style>
</head>

<body data-theme="light">
  <canvas id="confetti"></canvas>

  <!-- LEFT PANEL -->
  <div class="panelBack" id="leftBack"></div>
  <div class="panel left" id="leftPanel">
    <div class="panelTop">
      <div class="panelTitle">MENU</div>
      <button class="btn" id="leftClose">FERMER</button>
    </div>
    <div class="panelBody" id="leftBody"></div>
  </div>

  <!-- RIGHT PANEL -->
  <div class="panelBack" id="rightBack"></div>
  <div class="panel right" id="rightPanel">
    <div class="panelTop">
      <div class="panelTitle">PANNEAU DROIT</div>
      <button class="btn" id="rightClose">FERMER</button>
    </div>
    <div class="panelBody" id="rightBody"></div>
  </div>

  <div class="wrap" id="app">
    <div class="topbar">
      <div class="left">
        <button class="btn icon" id="btnMenu" title="Menu">‚â°</button>
        <button class="btn" id="btnTheme"><span id="themeLabel">TH√àME CLAIR</span></button>
        <button class="btn" id="btnCounters">COMPTEURS</button>
        <span class="pill hidden" id="pillTasks">0/0 t√¢ches</span>
        <span class="pill hidden" id="pillEto">0/0 √©torions</span>
        <span class="pill hidden" id="pillDone">0 faites</span>
        <span class="pill hidden" id="pillTimer">00:00</span>
      </div>
      <div class="right">
        <button class="btn icon" id="btnRight" title="Panneau droit">‚ñ¶</button>
      </div>
    </div>

    <div class="hero">
      <div class="title">ELIMINATOR</div>
      <div class="tag" id="tagline"></div>
    </div>

    <div class="main">
      <div class="card barWrap">
        <div class="barRow">
          <div class="barLabel">progression t√¢ches</div>
          <div class="barLabel" id="barInfo">‚Äî</div>
        </div>
        <div class="bar">
          <div class="barFill" id="taskBarFill" style="width:100%"></div>
          <div class="barPct" id="taskBarPct">100%</div>
        </div>
      </div>

      <div class="card">
        <div class="taskName" id="taskName">Aucune t√¢che</div>
        <div class="chips" id="chips"></div>

        <div class="actions">
          <div class="roulette" id="btnRoulette" title="Roulette">
            <div class="rouletteRing"></div>
            <div class="rouletteNeedle"></div>
            <div class="rouletteText">ROULETTE</div>
          </div>

          <div class="bomb" id="btnEtorion" title="D√©gommer un √©torion">
            <div class="em">üí£</div>
            <div class="label">
              <span>D√âGOMMER</span>
              <small>1 √âTORION</small>
            </div>
          </div>
        </div>

        <div class="miniRow">
          <div class="miniIcon" id="btnUndo" title="Annuler">‚Ü∂</div>
          <div class="miniIcon miniLabel" id="btnShowList" title="Liste">LISTE</div>
          <div class="miniIcon" id="btnDoneTask" title="Finir t√¢che">‚úì</div>
          <div class="miniIcon" id="btnPause" title="Pause timer">‚è∏</div>
        </div>

        <div class="small" style="text-align:center;margin-top:10px">
          Une cible. Une action. Z√©ro tribunal int√©rieur.
        </div>
      </div>

      <div class="card" id="belowList" style="display:none">
        <div class="barRow" style="margin-bottom:8px">
          <div class="barLabel">liste en cours</div>
          <button class="btn" id="btnHideList">MASQUER</button>
        </div>
        <div id="belowTasks"></div>
      </div>
    </div>
  </div>

  <script>
  /* =========================
     ELIMINATOR ‚Äî version robuste (compat Safari)
     - pas de structuredClone / ?? / ||= / ?.
     - SET = to-do list √©ditable
  ========================= */

  function $(id){ return document.getElementById(id); }
  function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }
  function rand(n){ return Math.floor(Math.random()*n); }
  function uid(){
    return Math.random().toString(36).slice(2,10) + "_" + Date.now().toString(36);
  }
  function nowISO(){ return new Date().toISOString(); }
  function dayKey(d){
    d = d || new Date();
    var y=d.getFullYear();
    var m=("0"+(d.getMonth()+1)).slice(-2);
    var da=("0"+d.getDate()).slice(-2);
    return y+"-"+m+"-"+da;
  }
  function fmtMMSS(ms){
    var s = Math.floor(ms/1000);
    var mm = ("0"+Math.floor(s/60)).slice(-2);
    var ss = ("0"+(s%60)).slice(-2);
    return mm+":"+ss;
  }
  function escapeHTML(s){
    s = s || "";
    return s.replace(/[&<>"']/g, function(c){
      return {"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"}[c];
    });
  }
  function deepClone(obj){
    return JSON.parse(JSON.stringify(obj));
  }

  var LS_KEY = "eliminator_v1_robust_set_todo";
  var TAGLINES = [
    "Qu√™te principale: active. Qu√™tes secondaires: musel√©es.",
    "Un √©torion. Une incision nette. H√©mostase du bazar.",
    "Mode ninja: silencieux. Pr√©cis. Irr√©prochable.",
    "Tu poses des balises dans le temps. Le temps ob√©it."
  ];

  var defaultState = {
    theme:"light",
    showCounters:false,
    showList:false,

    timer:{ running:true, startedAt:null, pausedAt:null, pausedTotal:0 },

    tasks:[],
    baseline:{ totalTasks:0, totalEtorions:0 },
    currentTaskId:null,
    stats:{ etorionsDone:0, tasksDone:0 },

    // ‚úÖ SET = to-do list √©ditable
    setTodo:{
      title:"SET",
      items:[ /* {id,text,done,doneAt} */ ]
    },

    undo:[]
  };

  function loadState(){
    try{
      var raw = localStorage.getItem(LS_KEY);
      if(!raw) return deepClone(defaultState);
      var s = JSON.parse(raw);

      // merge simple
      var base = deepClone(defaultState);
      for(var k in s){ base[k] = s[k]; }
      if(!base.timer) base.timer = deepClone(defaultState.timer);
      if(!base.baseline) base.baseline = deepClone(defaultState.baseline);
      if(!base.stats) base.stats = deepClone(defaultState.stats);
      if(!base.setTodo) base.setTodo = deepClone(defaultState.setTodo);
      if(!base.setTodo.items) base.setTodo.items = [];
      if(!base.undo) base.undo = [];
      return base;
    }catch(e){
      return deepClone(defaultState);
    }
  }
  function saveState(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }

  var state = loadState();

  function activeTasks(){
    var out=[];
    for(var i=0;i<state.tasks.length;i++){
      if(!state.tasks[i].done) out.push(state.tasks[i]);
    }
    return out;
  }
  function getTask(id){
    for(var i=0;i<state.tasks.length;i++){
      if(state.tasks[i].id===id) return state.tasks[i];
    }
    return null;
  }
  function sortTasks(list){
    return list.slice().sort(function(a,b){
      if(a.pinned && !b.pinned) return -1;
      if(!a.pinned && b.pinned) return 1;
      return String(a.createdAt||"").localeCompare(String(b.createdAt||""));
    });
  }
  function ensureBaseline(){
    if(state.baseline.totalTasks===0 && activeTasks().length>0){
      var a = activeTasks();
      state.baseline.totalTasks = a.length;
      var sum=0;
      for(var i=0;i<a.length;i++) sum += (a[i].etorionsTotal||1);
      state.baseline.totalEtorions = sum;
    }
  }
  function progress(){
    ensureBaseline();
    var baseT = state.baseline.totalTasks || 0;
    var baseE = state.baseline.totalEtorions || 0;
    var rem = activeTasks();
    var remT = rem.length;
    var remE = 0;
    for(var i=0;i<rem.length;i++) remE += (typeof rem[i].etorionsLeft==="number"? rem[i].etorionsLeft : (rem[i].etorionsTotal||1));
    var pct = baseT<=0 ? 100 : clamp(Math.round((remT/baseT)*100),0,100);
    return {baseT:baseT, baseE:baseE, remT:remT, remE:remE, pct:pct};
  }

  function setCurrentTask(id){
    state.currentTaskId = id;
    if(!state.timer.startedAt) state.timer.startedAt = Date.now();
  }
  function ensureCurrentTask(){
    var a = sortTasks(activeTasks());
    if(a.length===0){ state.currentTaskId=null; return; }
    var cur = getTask(state.currentTaskId);
    if(!cur || cur.done){
      var pinned=null;
      for(var i=0;i<a.length;i++){ if(a[i].pinned){ pinned=a[i]; break; } }
      setCurrentTask((pinned||a[0]).id);
    }
  }

  function pushUndo(label){
    state.undo.unshift({
      label:label,
      at:Date.now(),
      snapshot: deepClone({
        tasks:state.tasks,
        baseline:state.baseline,
        currentTaskId:state.currentTaskId,
        stats:state.stats,
        setTodo:state.setTodo
      })
    });
    state.undo = state.undo.slice(0,12);
  }
  function undo(){
    var u = state.undo.shift();
    if(!u) return;
    state.tasks = u.snapshot.tasks;
    state.baseline = u.snapshot.baseline;
    state.currentTaskId = u.snapshot.currentTaskId;
    state.stats = u.snapshot.stats;
    state.setTodo = u.snapshot.setTodo;
    saveState();
    renderAll();
  }

  function importTasks(text){
    var lines = String(text||"").split(/\r?\n/);
    var cat = "INBOX";
    var out=[];
    for(var i=0;i<lines.length;i++){
      var line = lines[i].trim();
      if(!line) continue;

      // category = ALL CAPS line (simple)
      var hasLetter = /[A-Za-z√Ä-√ñ√ò-√∂√∏-√ø]/.test(line);
      if(hasLetter && line === line.toUpperCase() && line.length<=90){
        cat = line;
        continue;
      }

      // parse "title 6" or "title - 6"
      line = line.replace(/^[-*‚Ä¢\s]+/, "").trim();
      if(!line) continue;

      var et = 1;
      var m = line.match(/^(.*?)(?:\s*[-‚Äì‚Äî]\s*|\s+)(\d+)\s*$/);
      var title = line;
      if(m){
        title = m[1].trim();
        et = clamp(parseInt(m[2],10)||1,1,99);
      }
      out.push({
        id:uid(),
        title:title,
        cat:cat,
        etorionsTotal:et,
        etorionsLeft:et,
        pinned:false,
        done:false,
        createdAt:nowISO(),
        doneAt:null
      });
    }
    return out;
  }

  /* --------- confetti minimal --------- */
  var conf = $("confetti");
  var ctx = conf.getContext("2d");
  var pieces = [];
  var raf = null;

  function resizeCanvas(){
    var dpr = window.devicePixelRatio || 1;
    conf.width = Math.floor(window.innerWidth * dpr);
    conf.height = Math.floor(window.innerHeight * dpr);
    conf.style.width = window.innerWidth+"px";
    conf.style.height = window.innerHeight+"px";
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  window.addEventListener("resize", resizeCanvas);
  resizeCanvas();

  function confettiBurst(strength){
    strength = strength || 1;
    var n = Math.floor(150*strength);
    var cx = window.innerWidth/2;
    var cy = window.innerHeight/3;

    for(var i=0;i<n;i++){
      pieces.push({
        x:cx, y:cy,
        vx:(Math.random()-0.5)*12*strength,
        vy:(Math.random()-0.85)*16*strength,
        g:(0.33 + Math.random()*0.25),
        r:2 + Math.random()*4*strength,
        life:80 + Math.random()*70,
        rot:Math.random()*Math.PI,
        vr:(Math.random()-0.5)*0.35
      });
    }
    animateConfetti();
  }

  function animateConfetti(){
    if(raf) return;
    raf = requestAnimationFrame(function step(){
      ctx.clearRect(0,0,window.innerWidth,window.innerHeight);
      var alive=[];
      for(var i=0;i<pieces.length;i++){
        var p = pieces[i];
        p.vy += p.g;
        p.x += p.vx; p.y += p.vy;
        p.rot += p.vr;
        p.life -= 1;
        if(p.life>0) alive.push(p);

        ctx.save();
        ctx.translate(p.x,p.y);
        ctx.rotate(p.rot);
        ctx.globalAlpha = 0.84;
        ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue("--fg");
        ctx.fillRect(-p.r, -p.r, p.r*2, p.r*2);
        ctx.restore();
      }
      pieces = alive;
      if(pieces.length){
        raf = requestAnimationFrame(step);
      }else{
        cancelAnimationFrame(raf);
        raf = null;
        ctx.clearRect(0,0,window.innerWidth,window.innerHeight);
      }
    });
  }

  /* --------- timer --------- */
  function timerMs(){
    if(!state.timer.startedAt) return 0;
    var now = Date.now();
    var paused = state.timer.pausedTotal || 0;
    var extra = state.timer.pausedAt ? (now - state.timer.pausedAt) : 0;
    return Math.max(0, now - state.timer.startedAt - paused - extra);
  }
  function togglePause(){
    if(!state.timer.startedAt) state.timer.startedAt = Date.now();
    if(state.timer.pausedAt){
      state.timer.pausedTotal = (state.timer.pausedTotal||0) + (Date.now() - state.timer.pausedAt);
      state.timer.pausedAt = null;
      state.timer.running = true;
    }else{
      state.timer.pausedAt = Date.now();
      state.timer.running = false;
    }
    saveState();
    renderAll();
  }

  /* --------- actions --------- */
  function roulettePick(){
    var list = sortTasks(activeTasks());
    if(!list.length) return null;
    var pinned=[];
    for(var i=0;i<list.length;i++) if(list[i].pinned) pinned.push(list[i]);
    var pool = pinned.length ? pinned : list;
    return pool[rand(pool.length)];
  }

  function completeTask(id){
    var t = getTask(id);
    if(!t || t.done) return;
    pushUndo("taskComplete");
    t.done=true;
    t.doneAt=nowISO();
    state.stats.tasksDone = (state.stats.tasksDone||0) + 1;
    confettiBurst(1.15);
    ensureCurrentTask();
    saveState();
    renderAll();
  }

  function degommeEtorion(){
    ensureCurrentTask();
    var t = getTask(state.currentTaskId);
    if(!t || t.done) return;

    pushUndo("etorion");
    if(typeof t.etorionsLeft!=="number") t.etorionsLeft = t.etorionsTotal||1;
    t.etorionsLeft = clamp(t.etorionsLeft-1,0,99);
    state.stats.etorionsDone = (state.stats.etorionsDone||0) + 1;

    if(t.etorionsLeft<=0){
      completeTask(t.id);
      return;
    }
    saveState();
    renderAll();
  }

  /* =========================
     ‚úÖ SET TODO LIST (√©ditable)
  ========================= */
  function setAddItem(text){
    text = String(text||"").trim();
    if(!text) return;
    pushUndo("setAdd");
    state.setTodo.items.unshift({ id:uid(), text:text, done:false, doneAt:null });
    saveState();
    renderRight();
  }
  function setToggle(id){
    for(var i=0;i<state.setTodo.items.length;i++){
      var it = state.setTodo.items[i];
      if(it.id===id){
        pushUndo("setToggle");
        it.done = !it.done;
        it.doneAt = it.done ? nowISO() : null;
        saveState();
        renderRight();
        return;
      }
    }
  }
  function setDelete(id){
    pushUndo("setDelete");
    var out=[];
    for(var i=0;i<state.setTodo.items.length;i++){
      if(state.setTodo.items[i].id!==id) out.push(state.setTodo.items[i]);
    }
    state.setTodo.items = out;
    saveState();
    renderRight();
  }
  function setEdit(id,newText){
    newText = String(newText||"").trim();
    if(!newText) return;
    for(var i=0;i<state.setTodo.items.length;i++){
      var it = state.setTodo.items[i];
      if(it.id===id){
        pushUndo("setEdit");
        it.text = newText;
        saveState();
        renderRight();
        return;
      }
    }
  }
  function setClearDone(){
    pushUndo("setClearDone");
    var out=[];
    for(var i=0;i<state.setTodo.items.length;i++){
      if(!state.setTodo.items[i].done) out.push(state.setTodo.items[i]);
    }
    state.setTodo.items = out;
    saveState();
    renderRight();
  }

  /* --------- UI panels --------- */
  function openLeft(){
    $("leftBack").style.display="block";
    $("leftPanel").classList.add("open");
    renderLeft();
  }
  function closeLeft(){
    $("leftBack").style.display="none";
    $("leftPanel").classList.remove("open");
  }
  function openRight(){
    $("rightBack").style.display="block";
    $("rightPanel").classList.add("open");
    renderRight();
  }
  function closeRight(){
    $("rightBack").style.display="none";
    $("rightPanel").classList.remove("open");
  }

  function mkSection(title){
    var s=document.createElement("div");
    s.className="section";
    var h=document.createElement("h3");
    h.textContent=title;
    s.appendChild(h);
    return s;
  }

  function renderLeft(){
    var body = $("leftBody");
    body.innerHTML="";

    var s1 = mkSection("Importer des t√¢ches");
    var ta = document.createElement("textarea");
    ta.placeholder = "COLLE ICI.\n\nADMIN\n- Mail X 2\n- Appeler Y 1\n\nCLINIQUE\n- Rapport Z 6";
    s1.appendChild(ta);

    var row=document.createElement("div");
    row.className="row";
    row.style.marginTop="8px";

    var bImp=document.createElement("button");
    bImp.className="btn";
    bImp.textContent="IMPORT + RESET BASELINE";
    bImp.onclick=function(){
      var items = importTasks(ta.value);
      if(!items.length) return;
      pushUndo("import");
      state.tasks = state.tasks.concat(items);
      // reset baseline
      var a = activeTasks();
      state.baseline.totalTasks = a.length;
      var sum=0; for(var i=0;i<a.length;i++) sum += (a[i].etorionsTotal||1);
      state.baseline.totalEtorions = sum;
      ensureCurrentTask();
      saveState();
      renderAll();
      ta.value="";
      closeLeft();
    };

    var bAdd=document.createElement("button");
    bAdd.className="btn";
    bAdd.textContent="AJOUTER SANS RESET";
    bAdd.onclick=function(){
      var items = importTasks(ta.value);
      if(!items.length) return;
      pushUndo("append");
      state.tasks = state.tasks.concat(items);
      ensureBaseline();
      ensureCurrentTask();
      saveState();
      renderAll();
      ta.value="";
    };

    row.appendChild(bImp);
    row.appendChild(bAdd);
    s1.appendChild(row);
    body.appendChild(s1);

    body.appendChild(document.createElement("div")).style.height="10px";

    var s2 = mkSection("Outils");
    var r2=document.createElement("div"); r2.className="row";

    var bBaseline=document.createElement("button");
    bBaseline.className="btn";
    bBaseline.textContent="BASELINE = ACTIF";
    bBaseline.onclick=function(){
      pushUndo("baselineActive");
      var a=activeTasks();
      state.baseline.totalTasks=a.length;
      var sum=0; for(var i=0;i<a.length;i++) sum += (a[i].etorionsTotal||1);
      state.baseline.totalEtorions=sum;
      saveState(); renderAll();
    };

    var bClearDone=document.createElement("button");
    bClearDone.className="btn";
    bClearDone.textContent="SUPPRIMER FINIES";
    bClearDone.onclick=function(){
      pushUndo("clearDone");
      var out=[];
      for(var i=0;i<state.tasks.length;i++) if(!state.tasks[i].done) out.push(state.tasks[i]);
      state.tasks=out;
      // baseline recalibr√©e
      var a=activeTasks();
      state.baseline.totalTasks=a.length;
      var sum=0; for(var i=0;i<a.length;i++) sum += (a[i].etorionsTotal||1);
      state.baseline.totalEtorions=sum;
      ensureCurrentTask();
      saveState(); renderAll();
    };

    r2.appendChild(bBaseline);
    r2.appendChild(bClearDone);
    s2.appendChild(r2);
    body.appendChild(s2);

    body.appendChild(document.createElement("div")).style.height="10px";

    var s3 = mkSection("Format");
    var info=document.createElement("div");
    info.className="small";
    info.textContent = "‚Ä¢ Ligne MAJUSCULES = cat√©gorie ¬∑ ¬´ titre 6 ¬ª = √©torions ¬∑ sans chiffre = 1";
    s3.appendChild(info);
    body.appendChild(s3);
  }

  function renderRight(){
    var body = $("rightBody");
    body.innerHTML="";

    // ‚úÖ Set todo list
    var s = mkSection("SET (to-do list √©ditable)");
    var row=document.createElement("div"); row.className="row";

    var inp=document.createElement("input");
    inp.placeholder="Ajouter un item‚Ä¶";
    var btn=document.createElement("button");
    btn.className="btn";
    btn.textContent="AJOUTER";
    btn.onclick=function(){ setAddItem(inp.value); inp.value=""; };

    row.appendChild(inp);
    row.appendChild(btn);
    s.appendChild(row);

    var tools=document.createElement("div");
    tools.className="row";
    tools.style.marginTop="8px";

    var clear=document.createElement("button");
    clear.className="btn";
    clear.textContent="SUPPRIMER COCH√âS";
    clear.onclick=setClearDone;

    tools.appendChild(clear);
    s.appendChild(tools);

    var list=document.createElement("div");
    list.style.marginTop="10px";

    var items = state.setTodo.items || [];
    if(!items.length){
      list.innerHTML = "<div class='small'>Aucun item dans le set.</div>";
    }else{
      var html=[];
      for(var i=0;i<items.length;i++){
        var it=items[i];
        html.push(
          "<div class='taskRow' style='opacity:"+(it.done?0.55:1)+"'>"+
            "<div class='t'>"+escapeHTML(it.text)+"</div>"+
            "<div class='meta'>"+(it.done?"‚úì":"")+"</div>"+
            "<div class='tools'>"+
              "<div class='toolBtn' data-act='toggle' data-id='"+it.id+"' title='Cocher'>"+(it.done?"‚Ü∫":"‚úì")+"</div>"+
              "<div class='toolBtn' data-act='edit' data-id='"+it.id+"' title='√âditer'>‚âã</div>"+
              "<div class='toolBtn' data-act='del' data-id='"+it.id+"' title='Supprimer'>‚úï</div>"+
            "</div>"+
          "</div>"
        );
      }
      list.innerHTML = html.join("");
    }
    s.appendChild(list);
    body.appendChild(s);

    // handlers
    var btns = body.querySelectorAll(".toolBtn");
    for(var j=0;j<btns.length;j++){
      btns[j].onclick = function(){
        var act = this.getAttribute("data-act");
        var id = this.getAttribute("data-id");
        if(act==="toggle") return setToggle(id);
        if(act==="del") return setDelete(id);
        if(act==="edit"){
          var newText = prompt("Modifier item :", "");
          if(newText===null) return;
          return setEdit(id, newText);
        }
      };
    }

    body.appendChild(document.createElement("div")).style.height="10px";

    // mini stats set
    var done=0;
    for(var k=0;k<items.length;k++) if(items[k].done) done++;
    var s2 = mkSection("R√©sum√©");
    var sm=document.createElement("div");
    sm.className="small";
    sm.textContent = done+"/"+items.length+" coch√©s aujourd‚Äôhui ("+dayKey()+")";
    s2.appendChild(sm);
    body.appendChild(s2);
  }

  /* --------- render main --------- */
  function setTagline(){
    var el=$("tagline");
    if(!el.textContent) el.textContent = TAGLINES[rand(TAGLINES.length)];
    if(Math.random()<0.20) el.textContent = TAGLINES[rand(TAGLINES.length)];
  }

  function renderHUD(){
    var p = progress();
    $("pillTasks").textContent = p.remT + "/" + p.baseT + " t√¢ches";
    $("pillEto").textContent = p.remE + "/" + p.baseE + " √©torions";
    var done = (p.baseT - p.remT);
    $("pillDone").textContent = done + " faites";
    $("pillTimer").textContent = fmtMMSS(timerMs());
  }

  function renderProgress(){
    var p = progress();
    $("taskBarFill").style.width = p.pct + "%";
    $("taskBarPct").textContent = p.pct + "%";
    $("barInfo").textContent = p.remT + " restantes sur " + p.baseT;
  }

  function renderCurrent(){
    ensureCurrentTask();
    var t = getTask(state.currentTaskId);
    if(!t){
      $("taskName").textContent="Aucune t√¢che";
      $("chips").innerHTML="";
      $("btnEtorion").style.opacity=0.45;
      $("btnEtorion").style.pointerEvents="none";
      return;
    }
    $("btnEtorion").style.opacity=1;
    $("btnEtorion").style.pointerEvents="auto";
    $("taskName").textContent = t.title;

    var total = t.etorionsTotal || 1;
    var left = (typeof t.etorionsLeft==="number") ? t.etorionsLeft : total;

    var chips=[];
    for(var i=0;i<total;i++){
      chips.push("<div class='chip "+(i<left?"on":"")+"'></div>");
    }
    $("chips").innerHTML = chips.join("");
    if(!state.timer.startedAt) state.timer.startedAt = Date.now();
  }

  function renderList(){
    var box = $("belowTasks");
    var list = sortTasks(activeTasks());
    if(!list.length){
      box.innerHTML = "<div class='small'>Aucune t√¢che.</div>";
      return;
    }
    var html=[];
    for(var i=0;i<list.length;i++){
      var t=list[i];
      var et=t.etorionsTotal||1;
      var left=(typeof t.etorionsLeft==="number")?t.etorionsLeft:et;
      var isCur = (t.id===state.currentTaskId);
      html.push(
        "<div class='taskRow' style='"+(isCur?"background:linear-gradient(180deg,var(--glass2),transparent);border-radius:var(--radius2);border:1px solid var(--line)":"")+"'>"+
          "<div class='t'>"+escapeHTML(t.title)+"</div>"+
          "<div class='meta'>"+left+"/"+et+"</div>"+
          "<div class='tools'>"+
            "<div class='toolBtn' data-act='pin' data-id='"+t.id+"' title='√âpingler'>"+(t.pinned?"‚ñ†":"‚ñ°")+"</div>"+
            "<div class='toolBtn' data-act='go' data-id='"+t.id+"' title='Cibler'>‚óé</div>"+
            "<div class='toolBtn' data-act='done' data-id='"+t.id+"' title='Finir'>‚úì</div>"+
          "</div>"+
        "</div>"
      );
    }
    box.innerHTML = html.join("");

    var btns = box.querySelectorAll(".toolBtn");
    for(var j=0;j<btns.length;j++){
      btns[j].onclick = function(){
        var act=this.getAttribute("data-act");
        var id=this.getAttribute("data-id");
        var t=getTask(id);
        if(!t) return;
        pushUndo("listAction");
        if(act==="pin"){ t.pinned=!t.pinned; }
        if(act==="go"){ setCurrentTask(id); }
        if(act==="done"){ completeTask(id); return; }
        saveState();
        renderAll();
      };
    }
  }

  function applyTheme(){
    document.body.setAttribute("data-theme", state.theme);
    $("themeLabel").textContent = (state.theme==="light") ? "TH√àME CLAIR" : "TH√àME SOMBRE";
  }

  function setCountersVisible(on){
    state.showCounters = !!on;
    var ids=["pillTasks","pillEto","pillDone","pillTimer"];
    for(var i=0;i<ids.length;i++){
      $(ids[i]).classList.toggle("hidden", !state.showCounters);
    }
    saveState();
  }

  function renderAll(){
    applyTheme();
    setTagline();
    ensureBaseline();
    ensureCurrentTask();
    renderHUD();
    renderProgress();
    renderCurrent();
    if(state.showList){
      $("belowList").style.display="block";
      renderList();
    }else{
      $("belowList").style.display="none";
    }
    $("btnUndo").style.opacity = state.undo.length ? 1 : 0.45;
    $("btnUndo").style.pointerEvents = state.undo.length ? "auto" : "none";
    $("btnPause").textContent = state.timer.pausedAt ? "‚ñ∂" : "‚è∏";
  }

  /* --------- events --------- */
  $("btnMenu").onclick=function(){ openLeft(); };
  $("leftClose").onclick=function(){ closeLeft(); };
  $("leftBack").onclick=function(){ closeLeft(); };

  $("btnRight").onclick=function(){ openRight(); };
  $("rightClose").onclick=function(){ closeRight(); };
  $("rightBack").onclick=function(){ closeRight(); };

  $("btnTheme").onclick=function(){
    state.theme = (state.theme==="light") ? "dark" : "light";
    saveState();
    renderAll();
  };

  $("btnCounters").onclick=function(){
    setCountersVisible(!state.showCounters);
    renderAll();
  };

  $("btnShowList").onclick=function(){
    state.showList = !state.showList;
    saveState();
    renderAll();
  };
  $("btnHideList").onclick=function(){
    state.showList=false;
    saveState();
    renderAll();
  };

  $("btnRoulette").onclick=function(){
    var btn=$("btnRoulette");
    btn.classList.remove("rouletteSpin");
    void btn.offsetWidth;
    btn.classList.add("rouletteSpin");

    var pick = roulettePick();
    if(!pick) return;
    setTimeout(function(){
      setCurrentTask(pick.id);
      saveState();
      renderAll();
    }, 520);
  };

  $("btnEtorion").onclick=degommeEtorion;
  $("btnDoneTask").onclick=function(){
    ensureCurrentTask();
    if(state.currentTaskId) completeTask(state.currentTaskId);
  };

  $("btnUndo").onclick=function(){ undo(); };
  $("btnPause").onclick=function(){ togglePause(); };

  document.addEventListener("keydown", function(e){
    if(e.key==="Escape"){ closeLeft(); closeRight(); }
    var tag = (document.activeElement && document.activeElement.tagName || "").toLowerCase();
    if(e.code==="Space" && ["input","textarea","select"].indexOf(tag)===-1){
      e.preventDefault();
      togglePause();
    }
  });

  /* --------- boot --------- */
  (function boot(){
    applyTheme();
    if(state.timer.running && !state.timer.startedAt) state.timer.startedAt = Date.now();
    renderAll();
    setInterval(function(){
      if(state.showCounters) $("pillTimer").textContent = fmtMMSS(timerMs());
      $("btnPause").textContent = state.timer.pausedAt ? "‚ñ∂" : "‚è∏";
    }, 500);
  })();

  </script>
</body>
</html>
