<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ELIMINATOR</title>

  <style>
    :root{
      /* ===== THEME CORE ===== */
      --bg: #f4f6fb;
      --fg: #0d1321;
      --muted: rgba(13,19,33,.62);

      --glass: rgba(255,255,255,.60);
      --glass2: rgba(255,255,255,.38);
      --lineA: rgba(13,19,33,.14);
      --shadow: 0 18px 60px rgba(0,0,0,.10);
      --blur: 18px;

      /* ===== ACCENT (surbrillance) ===== */
      --accent: rgba(0,140,255,.16);   /* default light */
      --accent2: rgba(0,140,255,.30);

      /* ===== APPEARANCE KNOBS ===== */
      --radius: 12px;     /* moins arrondi */
      --radius2: 10px;
      --barH: 34px;       /* + grand */
      --chipH: 18px;

      --appW: min(1240px, 96vw);
      --vpad: clamp(10px, 2.2vh, 18px);
      --hpad: clamp(10px, 2.2vw, 18px);

      /* fonts */
      --font: ui-sans-serif, system-ui, -apple-system, "SF Pro Display", "Segoe UI", Roboto, Helvetica, Arial;
      --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;

      /* size scales */
      --uiScale: 1.00;     /* buttons/pills */
      --titleScale: 1.00;  /* ELIMINATOR title */
      --taskScale: 1.22;   /* task name -> BIG */

      /* border toggles */
      --line: var(--lineA);
      --btnFill: 0;        /* 0 ghost, 1 filled */

      /* right panel width */
      --rightW: 420px;
      --drawerW: 440px;
    }

    [data-theme="dark"]{
      --bg:#0b0f17;
      --fg:#eaf0ff;
      --muted: rgba(234,240,255,.62);

      --glass: rgba(18,24,38,.60);
      --glass2: rgba(18,24,38,.38);
      --lineA: rgba(234,240,255,.14);
      --shadow: 0 18px 80px rgba(0,0,0,.36);
      --blur: 20px;

      --accent: rgba(0,255,140,.14);  /* default dark */
      --accent2: rgba(0,255,140,.26);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: var(--font);
      background:
        radial-gradient(1200px 700px at 25% 15%, rgba(255,255,255,.42), transparent 60%),
        radial-gradient(1000px 680px at 80% 30%, rgba(0,0,0,.06), transparent 60%),
        var(--bg);
      color: var(--fg);
      overflow-x:hidden;
    }
    [data-theme="dark"] body{
      background:
        radial-gradient(1200px 700px at 25% 15%, rgba(0,255,140,.055), transparent 60%),
        radial-gradient(1100px 720px at 80% 30%, rgba(0,140,255,.045), transparent 60%),
        var(--bg);
    }

    /* ===== APP ===== */
    .wrap{
      min-height:100%;
      display:flex;
      flex-direction:column;
      gap: clamp(10px, 1.6vh, 14px);
      padding: var(--vpad) var(--hpad) calc(var(--vpad) + 10px);
      align-items:center;
    }

    /* ===== TOPBAR ===== */
    .topbar{
      width: var(--appW);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding: 10px 10px;
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: var(--glass);
      backdrop-filter: blur(var(--blur));
      box-shadow: var(--shadow);
      position: sticky;
      top: 8px;
      z-index: 70;
    }
    .topbar .left, .topbar .right{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      min-width:0;
    }
    .topbar .right{ justify-content:flex-end; }

    /* ===== Buttons ===== */
    .btn{
      border:1px solid var(--line);
      background: transparent;
      color:var(--fg);
      border-radius: 10px;
      padding: calc(8px * var(--uiScale)) calc(10px * var(--uiScale));
      font-size: calc(12px * var(--uiScale));
      letter-spacing:.08em;
      text-transform:uppercase;
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
      transition: transform 140ms ease, background 120ms ease, opacity 120ms ease;
    }
    .btn:hover{ background: rgba(0,0,0,.04); }
    [data-theme="dark"] .btn:hover{ background: rgba(255,255,255,.05); }
    .btn:active{ transform: translateY(1px); }

    .btn.icon{
      width: calc(40px * var(--uiScale));
      height: calc(36px * var(--uiScale));
      display:grid;
      place-items:center;
      padding:0;
      font-family: var(--mono);
      letter-spacing:0;
      text-transform:none;
      font-size: calc(15px * var(--uiScale));
    }

    .btn.primary{
      background:
        linear-gradient(180deg,
          rgba(255,255,255, calc(.30 * var(--btnFill))) ,
          rgba(0,0,0,0)
        );
      box-shadow: inset 0 0 0 1px var(--line);
    }
    [data-theme="dark"] .btn.primary{
      background:
        linear-gradient(180deg,
          rgba(255,255,255, calc(.12 * var(--btnFill))) ,
          rgba(0,0,0,0)
        );
    }

    .pill{
      padding: calc(6px * var(--uiScale)) calc(10px * var(--uiScale));
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.03);
      color: var(--muted);
      font-size: calc(12px * var(--uiScale));
      font-family: var(--mono);
      white-space:nowrap;
      user-select:none;
    }
    [data-theme="dark"] .pill{ background: rgba(255,255,255,.04); }

    .pill.hidden{ display:none; }

    /* ===== HERO ===== */
    .hero{
      width: var(--appW);
      display:flex;
      flex-direction:column;
      align-items:center;
      gap: 8px;
      padding: 2px 8px 0;
    }
    .title{
      font-size: calc(clamp(46px, 5.4vw, 72px) * var(--titleScale));
      letter-spacing: .20em;
      text-transform:uppercase;
      margin: 6px 0 0;
      font-weight: 720;
      line-height:1.05;
      text-align:center;
    }
    .tag{
      font-size: 13px;
      color: var(--muted);
      text-align:center;
      max-width: 78ch;
      padding: 0 8px;
      min-height: 18px;
    }

    /* ===== MAIN ===== */
    .main{
      width: var(--appW);
      display:flex;
      flex-direction:column;
      gap: clamp(12px, 2.2vh, 18px);
      align-items:center;
      flex:1;
      justify-content:flex-start;
    }

    /* ===== PROGRESS (isol√©e + dominante) ===== */
    .barWrap{
      width:100%;
      display:flex;
      flex-direction:column;
      gap:10px;
      padding: 16px 14px 16px;
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: var(--glass);
      backdrop-filter: blur(var(--blur));
      box-shadow: var(--shadow);
    }
    .barRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .barLabel{
      font-size: 12px;
      letter-spacing:.08em;
      text-transform:uppercase;
      color: var(--muted);
      font-family: var(--mono);
    }
    .bar{
      width:100%;
      height: var(--barH);
      border:1px solid var(--line);
      background: rgba(0,0,0,.03);
      border-radius: var(--radius2);
      position:relative;
      overflow:hidden;
    }
    [data-theme="dark"] .bar{ background: rgba(255,255,255,.04); }
    .barFill{
      position:absolute; inset:0;
      width:100%;
      background: linear-gradient(90deg, var(--accent), transparent);
      transition: width 260ms ease;
    }
    .barPct{
      position:absolute; inset:0;
      display:grid;
      place-items:center;
      font-family: var(--mono);
      font-size: 12px;
      color: var(--fg);
      opacity:.92;
      pointer-events:none;
    }

    /* ===== CURRENT TASK ===== */
    .current{
      width:100%;
      padding: 14px 14px 14px;
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: var(--glass);
      backdrop-filter: blur(var(--blur));
      box-shadow: var(--shadow);
      display:flex;
      flex-direction:column;
      gap: 14px;
    }
    .taskName{
      font-size: calc(clamp(30px, 3.7vw, 52px) * var(--taskScale));
      font-weight: 780;
      letter-spacing:.01em;
      text-align:center;
      line-height:1.10;
      padding: 4px 6px;
      word-break: break-word;
    }

    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      justify-content:center;
      padding: 0;
    }
    .chip{
      width: var(--chipH);
      height: var(--chipH);
      border-radius: 6px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.03);
    }
    [data-theme="dark"] .chip{ background: rgba(255,255,255,.04); }
    .chip.on{ background: var(--accent2); }

    /* ===== Actions ===== */
    .actions{
      display:flex;
      gap:12px;
      justify-content:center;
      flex-wrap:wrap;
      align-items:center;
    }

    .roulette{
      width: clamp(100px, 12vw, 140px);
      height: clamp(100px, 12vw, 140px);
      border-radius: 999px;
      border:1px solid var(--line);
      background:
        radial-gradient(circle at 30% 30%, var(--glass2), transparent 60%),
        linear-gradient(180deg, var(--glass2), transparent);
      backdrop-filter: blur(var(--blur));
      box-shadow: var(--shadow);
      display:grid;
      place-items:center;
      cursor:pointer;
      user-select:none;
      transition: transform 140ms ease;
      position:relative;
    }
    .roulette:active{ transform: translateY(1px) scale(.99); }
    .rouletteText{
      font-size: 12px;
      letter-spacing:.14em;
      text-transform:uppercase;
      color: var(--fg);
      opacity:.92;
      font-weight:780;
      font-family: var(--mono);
    }
    .rouletteRing{
      position:absolute;
      inset:8px;
      border-radius:999px;
      border:1px dashed var(--line);
      opacity:.85;
    }
    .rouletteSpin{
      animation: spin 740ms cubic-bezier(.08,.92,.22,1) 1;
    }
    @keyframes spin{
      0%{ transform: rotate(0deg); }
      100%{ transform: rotate(820deg); }
    }

    .bomb{
      min-width: clamp(170px, 24vw, 260px);
      padding: 14px 16px;
      border-radius: 12px;
      border:1px solid var(--line);
      background: linear-gradient(180deg, var(--glass2), transparent);
      cursor:pointer;
      text-transform:uppercase;
      letter-spacing:.10em;
      font-size: 12px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:12px;
      user-select:none;
      box-shadow: var(--shadow);
      transition: transform 140ms ease;
    }
    .bomb:hover{ background: rgba(0,0,0,.03); }
    [data-theme="dark"] .bomb:hover{ background: rgba(255,255,255,.04); }
    .bomb:active{ transform: translateY(1px) scale(.99); }
    .bomb .em{ font-family: var(--mono); font-size: 15px; opacity:.92; }
    .bomb .label{ display:flex; flex-direction:column; line-height:1.12; align-items:center; }
    .bomb .label span{ font-size: 12px; font-family: var(--mono); }
    .bomb .label small{
      font-size: 10px;
      color: var(--muted);
      letter-spacing:.14em;
      text-transform:uppercase;
      font-family: var(--mono);
    }

    .miniIcon{
      width:52px; height:52px;
      border-radius: 12px;
      border:1px solid var(--line);
      display:grid;
      place-items:center;
      cursor:pointer;
      background: transparent;
      box-shadow: var(--shadow);
      font-family: var(--mono);
      font-size: 15px;
      user-select:none;
      transition: transform 140ms ease, background 120ms ease;
    }
    .miniIcon:hover{ background: rgba(0,0,0,.03); }
    [data-theme="dark"] .miniIcon:hover{ background: rgba(255,255,255,.04); }
    .miniIcon:active{ transform: translateY(1px) scale(.99); }

    .belowList{
      width:100%;
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: var(--glass);
      backdrop-filter: blur(var(--blur));
      box-shadow: var(--shadow);
      padding: 10px;
      display:none;
    }
    .belowList.show{ display:block; }
    .belowHead{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding-bottom:8px;
      border-bottom:1px solid var(--line);
      margin-bottom:8px;
    }
    .belowHead .h{
      font-size:12px; letter-spacing:.10em; text-transform:uppercase; color:var(--muted);
      font-family: var(--mono);
    }
    .taskRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 8px 6px;
      border-bottom:1px solid var(--line);
    }
    .taskRow:last-child{ border-bottom:none; }
    .taskRow .t{
      flex:1;
      min-width:0;
      font-size: 13px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      color: var(--fg);
    }
    .taskRow .meta{
      font-size: 11px;
      color: var(--muted);
      font-family: var(--mono);
      white-space:nowrap;
    }
    .taskRow .tools{
      display:flex;
      gap:6px;
      align-items:center;
    }
    .toolBtn{
      width:36px; height:32px;
      border-radius: 10px;
      border:1px solid var(--line);
      display:grid;
      place-items:center;
      cursor:pointer;
      background: transparent;
      font-family: var(--mono);
      font-size: 12px;
      user-select:none;
    }
    .toolBtn:hover{ background: rgba(0,0,0,.03); }
    [data-theme="dark"] .toolBtn:hover{ background: rgba(255,255,255,.04); }

    .small{
      font-size:12px;
      color: var(--muted);
      font-family: var(--mono);
    }

    /* ===== FOCUS MODE ===== */
    .focusOn .topbar .btn:not(.keepFocus),
    .focusOn .topbar .right{ display:none !important; }
    .focusOn .topbar{ justify-content:center; }
    .focusOn .topbar .left{ width:100%; justify-content:center; }
    .focusOn .tag{ opacity:.95; }

    /* ===== LEFT DRAWER ===== */
    .drawerBack{
      position:fixed; inset:0;
      background: rgba(0,0,0,.22);
      backdrop-filter: blur(10px);
      display:none;
      z-index:80;
    }
    .drawer{
      position:fixed;
      top:0; left:0;
      width: min(var(--drawerW), 94vw);
      height:100%;
      background: var(--glass);
      border-right:1px solid var(--line);
      backdrop-filter: blur(var(--blur));
      box-shadow: var(--shadow);
      transform: translateX(-105%);
      transition: transform 220ms ease;
      z-index:90;
      display:flex;
      flex-direction:column;
    }
    .drawer.open{ transform: translateX(0); }
    .drawerBack.show{ display:block; }

    .drawerTop{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding: 10px 12px;
      border-bottom:1px solid var(--line);
      gap:10px;
    }
    .drawerTitle{
      font-size: 12px;
      letter-spacing:.14em;
      text-transform:uppercase;
      color: var(--muted);
      font-family: var(--mono);
    }
    .drawerResizer{
      position:absolute;
      top:0; right:-6px;
      width:12px;
      height:100%;
      cursor: ew-resize;
      opacity:0;
    }
    .drawer:hover .drawerResizer{ opacity:1; }

    .tabs{
      display:flex;
      gap:8px;
      padding: 10px 12px 6px;
      flex-wrap:wrap;
    }
    .tab{
      padding: 7px 9px;
      border-radius: 10px;
      border:1px solid var(--line);
      cursor:pointer;
      font-size: 11px;
      letter-spacing:.12em;
      text-transform:uppercase;
      color: var(--muted);
      user-select:none;
      font-family: var(--mono);
    }
    .tab.active{
      color: var(--fg);
      background: linear-gradient(180deg, var(--glass2), transparent);
      box-shadow: inset 0 0 0 1px var(--line);
    }
    .drawerBody{
      padding: 10px 12px 18px;
      overflow:auto;
    }

    .section{
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding: 10px;
      background: rgba(0,0,0,.02);
    }
    [data-theme="dark"] .section{ background: rgba(255,255,255,.03); }
    .section h3{
      margin: 0 0 8px;
      font-size: 11px;
      letter-spacing:.14em;
      text-transform:uppercase;
      color: var(--muted);
      font-family: var(--mono);
      font-weight:780;
    }

    textarea, input, select{
      width:100%;
      border:1px solid var(--line);
      background: transparent;
      color: var(--fg);
      border-radius: 10px;
      padding: 10px;
      outline:none;
      font-family: var(--font);
      font-size: 13px;
    }
    textarea{ min-height: 120px; resize:vertical; }
    .row{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .row > *{ flex:1; min-width: 120px; }

    /* ===== MODALS (click anywhere closes) ===== */
    .modalBack{
      position:fixed; inset:0;
      background: rgba(0,0,0,.25);
      backdrop-filter: blur(14px);
      display:none;
      z-index:110;
    }
    .modal{
      position:fixed;
      inset:0;
      display:none;
      z-index:120;
      padding: 18px;
      align-items:center;
      justify-content:center;
    }
    .modalCard{
      width:min(900px, 96vw);
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: var(--glass);
      backdrop-filter: blur(var(--blur));
      box-shadow: var(--shadow);
      padding: 12px;
      position:relative;
      overflow:hidden;
    }
    .modalHead{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding: 6px 6px 10px;
      border-bottom:1px solid var(--line);
      margin-bottom:10px;
    }
    .modalHead .mh{
      font-size: 12px; letter-spacing:.14em; text-transform:uppercase; color: var(--muted);
      font-family: var(--mono);
    }

    /* ===== CELEBRATION: GIANT ===== */
    .celeCard{
      width:min(980px, 97vw);
      min-height: min(72vh, 740px);
      display:flex;
      flex-direction:column;
      justify-content:center;
      padding: 22px 16px;
    }
    .celeHalo{
      position:absolute;
      inset:-40%;
      background:
        radial-gradient(circle at 30% 30%, var(--accent2), transparent 55%),
        radial-gradient(circle at 70% 40%, var(--accent), transparent 55%),
        radial-gradient(circle at 50% 70%, rgba(255,255,255,.10), transparent 55%);
      opacity:.55;
      filter: blur(2px);
      transform: rotate(8deg);
      pointer-events:none;
      animation: halo 2.2s ease-in-out infinite alternate;
    }
    @keyframes halo{
      0%{ transform: rotate(6deg) scale(1.02); opacity:.50; }
      100%{ transform: rotate(10deg) scale(1.08); opacity:.68; }
    }
    .celeTitle{
      font-size: clamp(28px, 4.2vw, 56px);
      font-weight: 860;
      letter-spacing:.14em;
      text-transform:uppercase;
      text-align:center;
      margin: 10px 0 10px;
    }
    .celeMsg{
      font-size: clamp(14px, 1.8vw, 22px);
      text-align:center;
      line-height:1.55;
      margin: 0 auto 12px;
      max-width: 72ch;
      opacity:.95;
    }
    .celeSub{
      font-size: 12px;
      color: var(--muted);
      text-align:center;
      margin: 0;
      font-family: var(--mono);
      letter-spacing:.06em;
    }
    .celeHint{
      margin-top: 14px;
      text-align:center;
      color: var(--muted);
      font-size: 11px;
      letter-spacing:.10em;
      text-transform:uppercase;
      font-family: var(--mono);
    }

    /* Confetti */
    #confetti{
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:140;
    }

    /* ===== RIGHT PANEL (tabs: SETS/HABITS/EMOTIONS) ===== */
    .rightBack{
      position:fixed; inset:0;
      background: rgba(0,0,0,.12);
      backdrop-filter: blur(10px);
      display:none;
      z-index:75;
    }
    .rightPanel{
      position:fixed;
      top:0; right:0;
      width: min(var(--rightW), 94vw);
      height:100%;
      background: var(--glass);
      border-left:1px solid var(--line);
      backdrop-filter: blur(var(--blur));
      box-shadow: var(--shadow);
      transform: translateX(105%);
      transition: transform 220ms ease;
      z-index:85;
      display:flex;
      flex-direction:column;
    }
    .rightPanel.open{ transform: translateX(0); }
    .rightBack.show{ display:block; }
    .rightTop{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding: 10px 12px;
      border-bottom:1px solid var(--line);
      gap:10px;
    }
    .rightTitle{
      font-size: 12px;
      letter-spacing:.14em;
      text-transform:uppercase;
      color: var(--muted);
      font-family: var(--mono);
    }
    .rightResizer{
      position:absolute;
      top:0; left:-6px;
      width:12px;
      height:100%;
      cursor: ew-resize;
      opacity:0;
    }
    .rightPanel:hover .rightResizer{ opacity:1; }
    .rightTabs{
      display:flex;
      gap:8px;
      padding: 10px 12px 6px;
      flex-wrap:wrap;
      justify-content:flex-start;
    }
    .rightBody{
      padding: 10px 12px 18px;
      overflow:auto;
    }

    /* ===== Simple inline charts (monochrome + accent) ===== */
    .spark{
      width:100%;
      height: 34px;
      border:1px solid var(--line);
      border-radius: 10px;
      background: rgba(0,0,0,.02);
      position:relative;
      overflow:hidden;
    }
    [data-theme="dark"] .spark{ background: rgba(255,255,255,.03); }
    .sparkFill{
      position:absolute; inset:0;
      width:50%;
      background: linear-gradient(90deg, var(--accent), transparent);
    }

    .gridCal{
      display:grid;
      grid-template-columns: repeat(10, 1fr);
      gap:6px;
    }
    .calCell{
      height:28px;
      border-radius:10px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.02);
      position:relative;
      overflow:hidden;
      user-select:none;
    }
    [data-theme="dark"] .calCell{ background: rgba(255,255,255,.03); }
    .calInk{
      position:absolute; inset:0;
      background: var(--accent);
      opacity:.10;
    }
    .calTxt{
      position:absolute; inset:0;
      display:grid; place-items:center;
      font-family: var(--mono);
      font-size:10px;
      color: var(--muted);
    }

    /* ===== Minimal mode: remove borders if desired ===== */
    [data-borders="off"]{
      --line: rgba(0,0,0,0);
    }

    /* ===== Button style: filled ===== */
    [data-buttons="filled"]{
      --btnFill: 1;
    }
  </style>
</head>

<body data-theme="light" data-borders="on" data-buttons="ghost">
  <canvas id="confetti"></canvas>

  <!-- LEFT DRAWER -->
  <div class="drawerBack" id="drawerBack"></div>
  <div class="drawer" id="drawer">
    <div class="drawerResizer" id="drawerResizer" title="Agrandir/r√©duire"></div>
    <div class="drawerTop">
      <div class="drawerTitle">MENU</div>
      <button class="btn" id="drawerClose">FERMER</button>
    </div>
    <div class="tabs" id="tabs"></div>
    <div class="drawerBody" id="drawerBody"></div>
  </div>

  <!-- RIGHT PANEL -->
  <div class="rightBack" id="rightBack"></div>
  <div class="rightPanel" id="rightPanel">
    <div class="rightResizer" id="rightResizer" title="Agrandir/r√©duire"></div>
    <div class="rightTop">
      <div class="rightTitle">PANNEAU</div>
      <button class="btn" id="rightClose">FERMER</button>
    </div>
    <div class="rightTabs" id="rightTabs"></div>
    <div class="rightBody" id="rightBody"></div>
  </div>

  <!-- MODALS -->
  <div class="modalBack" id="modalBack"></div>

  <div class="modal" id="notesModal">
    <div class="modalCard">
      <div class="modalHead">
        <div class="mh">NOTES</div>
        <div class="small">Clique n‚Äôimporte o√π pour fermer</div>
      </div>
      <div class="section">
        <h3>Ajouter une note</h3>
        <textarea id="noteInput" placeholder="√âcris ici. Sortie de RAM."></textarea>
        <div class="row" style="margin-top:8px">
          <button class="btn primary" id="noteAdd">AJOUTER</button>
          <button class="btn" id="noteClear">VIDER</button>
        </div>
      </div>
      <div style="height:10px"></div>
      <div class="section">
        <h3>Historique</h3>
        <div id="notesList" class="small"></div>
      </div>
    </div>
  </div>

  <div class="modal" id="celeModal">
    <div class="modalCard celeCard">
      <div class="celeHalo" aria-hidden="true"></div>
      <div class="celeTitle" id="celeTitle"></div>
      <div class="celeMsg" id="celeMsg"></div>
      <div class="celeSub" id="celeSub"></div>
      <div class="celeHint">Clique n‚Äôimporte o√π pour fermer</div>
    </div>
  </div>

  <div class="modal" id="tipsModal">
    <div class="modalCard">
      <div class="modalHead">
        <div class="mh">CONSEIL FLOW</div>
        <div class="small">Clique n‚Äôimporte o√π pour fermer</div>
      </div>
      <div class="celeTitle" style="font-size:clamp(18px,2.4vw,26px); letter-spacing:.08em" id="tipsTitle"></div>
      <div class="celeMsg" style="font-size:clamp(13px,1.6vw,18px)" id="tipsMsg"></div>
      <div class="celeSub" id="tipsSub"></div>
    </div>
  </div>

  <div class="modal" id="emoNudgeModal">
    <div class="modalCard">
      <div class="modalHead">
        <div class="mh">MICRO-R√âGULATION</div>
        <div class="small">Clique n‚Äôimporte o√π pour fermer</div>
      </div>
      <div class="celeTitle" style="font-size:clamp(18px,2.4vw,28px); letter-spacing:.10em" id="emoNudgeTitle"></div>
      <div class="celeMsg" style="font-size:clamp(13px,1.6vw,18px)" id="emoNudgeMsg"></div>
      <div class="celeSub" id="emoNudgeSub"></div>
    </div>
  </div>

  <div class="wrap" id="app">
    <!-- TOPBAR -->
    <div class="topbar">
      <div class="left">
        <button class="btn icon keepFocus" id="btnMenu" title="Menu gauche">‚â°</button>

        <!-- Toggle counters (hidden by default) -->
        <button class="btn keepFocus" id="btnCounters">COMPTEURS</button>

        <span class="pill hidden" id="pillTasks">0/0 t√¢ches</span>
        <span class="pill hidden" id="pillEto">0/0 √©torions</span>
        <span class="pill hidden" id="pillDone">0 faites</span>
        <span class="pill hidden" id="pillTimer">00:00</span>

        <!-- quick theme -->
        <button class="btn primary keepFocus" id="btnTheme" title="Th√®me"><span id="themeLabel">TH√àME CLAIR</span></button>

        <!-- show/hide below list on main -->
        <button class="btn keepFocus" id="btnListToggle">LISTE</button>

        <!-- undo -->
        <button class="btn keepFocus" id="btnUndo" title="Annuler la derni√®re action">UNDO</button>

        <button class="btn keepFocus" id="btnFocus">FOCUS</button>
      </div>

      <div class="right">
        <!-- open right panel -->
        <button class="btn icon keepFocus" id="btnRight" title="Panneau droit">‚ñ¶</button>
      </div>
    </div>

    <!-- HERO -->
    <div class="hero">
      <div class="title" id="appTitle">ELIMINATOR</div>
      <div class="tag" id="tagline"></div>
    </div>

    <!-- MAIN -->
    <div class="main">
      <!-- PROGRESS -->
      <div class="barWrap">
        <div class="barRow">
          <div class="barLabel">progression t√¢ches</div>
          <div class="barLabel" id="barInfo">‚Äî</div>
        </div>
        <div class="bar">
          <div class="barFill" id="taskBarFill" style="width:100%"></div>
          <div class="barPct" id="taskBarPct">100%</div>
        </div>
      </div>

      <!-- CURRENT TASK -->
      <div class="current">
        <div class="taskName" id="taskName">Aucune t√¢che</div>
        <div class="chips" id="chips"></div>

        <div class="actions">
          <div class="roulette" id="btnRoulette" title="Roulette">
            <div class="rouletteRing" aria-hidden="true"></div>
            <div class="rouletteText">ROULETTE</div>
          </div>

          <div class="bomb" id="btnEtorion" title="D√©gommer un √©torion">
            <div class="em">üí£</div>
            <div class="label">
              <span>D√âGOMMER</span>
              <small>1 √âTORION</small>
            </div>
          </div>

          <div class="miniIcon" id="btnNotes" title="Notes">‚úé</div>
          <div class="miniIcon" id="btnDoneTask" title="T√¢che d√©gomm√©e">‚úì</div>
          <div class="miniIcon" id="btnEditTask" title="√âditer">‚âã</div>
        </div>

        <div class="belowList" id="belowList">
          <div class="belowHead">
            <div class="h">LISTE EN COURS</div>
            <button class="btn" id="btnHideBelow">MASQUER</button>
          </div>
          <div id="belowTasks"></div>
        </div>

        <div class="small" id="hintLine" style="text-align:center">
          Flow = une cible, une action, z√©ro tribunal int√©rieur.
        </div>
      </div>
    </div>
  </div>

  <script>
/* =========================================================
   ELIMINATOR ‚Äî Left menu + Right panel + Appearance + Undo
   ========================================================= */

const $ = (id)=>document.getElementById(id);
const clamp = (n,a,b)=>Math.max(a, Math.min(b,n));
const uid = ()=>Math.random().toString(36).slice(2,10)+"_"+Date.now().toString(36);
const nowISO = ()=>new Date().toISOString();
const dayKey = (d=new Date())=>{
  const y=d.getFullYear();
  const m=String(d.getMonth()+1).padStart(2,"0");
  const da=String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${da}`;
};
function fmtMMSS(ms){
  const s = Math.floor(ms/1000);
  const mm = String(Math.floor(s/60)).padStart(2,"0");
  const ss = String(s%60).padStart(2,"0");
  return `${mm}:${ss}`;
}
function plural(n, one, many){ return (n===1)? one : many; }
function rand(n){ return Math.floor(Math.random()*n); }
function escapeHTML(s){
  return (s||"").replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[c]));
}

/* -------------------------
   Storage
------------------------- */
const LS_KEY = "eliminator_v5_right_appearance_undo";
const defaultState = {
  theme: "light",
  focus: false,

  // visibility
  showBelowList: false,
  showCounters: false,      // pills hidden by default
  countersAutoHideSec: 10,  // auto-hide after showing

  // panels
  drawerW: 440,
  rightW: 420,
  activeTab: "inbox",
  rightTab: "sets",

  // appearance
  appearance: {
    accentLight: "cyan",   // options below
    accentDark: "lime",
    fontFamily: "system",
    uiScale: 1.00,
    titleScale: 1.00,
    taskScale: 1.22,
    borders: "on",         // on/off
    buttons: "ghost",      // ghost/filled
    radius: 12,
    barH: 34,
    chipH: 18
  },

  settings: {
    etorionMin: 5,
    fatigue: 2, motivation: 2,

    celebrationChance: 0.28,
    celebrationAutoCloseSec: 11,

    tipsChance: 0.16,
    tipsMinGapMin: 6,

    nudgeChance: 0.10,
    nudgeMinGapMin: 10,

    keepListInFocus: true,
    listSort: "roulette",
    includedCats: [],

    autoSuggestKiffance: true,
    kiffanceSuggestEveryEto: 6
  },

  tasks: [],
  baseline: { totalTasks:0, totalEtorions:0 },
  currentTaskId: null,
  currentTaskStart: null,

  notes: [],
  habits: [],
  history: [],

  kiffance: { bank: {"5":[], "10":[], "15":[], "25":[]} },

  sets: {
    hospital: { enabled:true, patients: 4, itemsPerPatient:["Voir patient","Note","Traitement","Dossier"], checks:{} },
    consult:  { enabled:true, patients: 6, itemsPerPatient:["Voir patient","Note","Ordonnance","Dossier"], checks:{} }
  },

  emotions: { entries: [] },

  lastTipAt: null,
  lastNudgeAt: null,

  stats: { etorionsDone: 0, tasksDone: 0 },

  // undo stack: store compact snapshots of task-related state
  undo: []
};

let state = loadState();

function deepAssign(target, src){
  for(const k in src){
    if(src[k] && typeof src[k]==="object" && !Array.isArray(src[k]) && target[k]){
      deepAssign(target[k], src[k]);
    }else{
      target[k] = src[k];
    }
  }
}
function seedState(s){
  // seed kiffance bank
  const bank = s.kiffance?.bank || (s.kiffance={bank:{"5":[], "10":[], "15":[], "25":[]}}).bank;
  const emptyAll = ["5","10","15","25"].every(k => Array.isArray(bank[k]) && bank[k].length===0);
  if(emptyAll){
    bank["5"] = [
      "Bois un verre d‚Äôeau. Debout. Sans n√©gocier.",
      "Respire 5 cycles lents. √âpaules en bas.",
      "Regarde au loin 20 secondes. Reviens.",
      "Micro-marche 60 secondes. Retour imm√©diat.",
      "√âtire nuque/√©paules 45 secondes. Stop.",
      "Nettoie une surface (30 secondes). Fin."
    ];
    bank["10"] = [
      "Mini-reset: eau + toilette + retour.",
      "D√©charge mentale: 8 lignes, puis reprise.",
      "Rangement √©clair: 10 objets, pas plus.",
      "Fen√™tre: 2 minutes dehors + reprise.",
      "√âtirements 4 minutes + eau."
    ];
    bank["15"] = [
      "Pause active: marche 10 + eau 5.",
      "Snack simple sans √©cran + reprise.",
      "√âtirements 7 + respiration 8.",
      "Mini-douche/visage + retour."
    ];
    bank["25"] = [
      "Vraie pause: 20 min hors √©cran + 5 min reprise douce.",
      "Petite marche + retour avec une seule priorit√©.",
      "Micro-sieste 15‚Äì20 min + eau + reprise.",
      "Respiration + musique sans scroll."
    ];
  }

  if(!s.undo) s.undo = [];
  return s;
}
function loadState(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return seedState(structuredClone(defaultState));
    const parsed = JSON.parse(raw);
    const merged = structuredClone(defaultState);
    deepAssign(merged, parsed);
    return seedState(merged);
  }catch(e){
    return seedState(structuredClone(defaultState));
  }
}
function saveState(){
  localStorage.setItem(LS_KEY, JSON.stringify(state));
}

/* -------------------------
   Appearance mappings
------------------------- */
const ACCENTS = {
  cyan:   { a:"rgba(0,140,255,.16)", a2:"rgba(0,140,255,.30)" },
  violet: { a:"rgba(140,80,255,.16)", a2:"rgba(140,80,255,.30)" },
  lime:   { a:"rgba(0,255,140,.14)", a2:"rgba(0,255,140,.26)" },
  amber:  { a:"rgba(255,180,0,.14)", a2:"rgba(255,180,0,.26)" },
  steel:  { a:"rgba(180,200,255,.12)", a2:"rgba(180,200,255,.22)" }
};
const FONT_FAMILIES = {
  system: 'ui-sans-serif, system-ui, -apple-system, "SF Pro Display", "Segoe UI", Roboto, Helvetica, Arial',
  elegant: '"SF Pro Display", -apple-system, system-ui, "Segoe UI", Roboto, Helvetica, Arial',
  neutral: 'system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial',
  monoish: 'ui-sans-serif, system-ui, -apple-system, "SF Pro Display", "Segoe UI", Roboto, Helvetica, Arial'
};

function applyAppearance(){
  // theme
  document.body.setAttribute("data-theme", state.theme);

  // borders / buttons
  document.body.setAttribute("data-borders", state.appearance.borders || "on");
  document.body.setAttribute("data-buttons", state.appearance.buttons || "ghost");

  // sizes
  document.documentElement.style.setProperty("--uiScale", String(state.appearance.uiScale ?? 1.0));
  document.documentElement.style.setProperty("--titleScale", String(state.appearance.titleScale ?? 1.0));
  document.documentElement.style.setProperty("--taskScale", String(state.appearance.taskScale ?? 1.22));

  document.documentElement.style.setProperty("--radius", `${clamp(state.appearance.radius ?? 12, 6, 18)}px`);
  document.documentElement.style.setProperty("--barH", `${clamp(state.appearance.barH ?? 34, 24, 46)}px`);
  document.documentElement.style.setProperty("--chipH", `${clamp(state.appearance.chipH ?? 18, 14, 26)}px`);

  // widths
  document.documentElement.style.setProperty("--drawerW", `${clamp(state.drawerW||440, 340, 860)}px`);
  document.documentElement.style.setProperty("--rightW", `${clamp(state.rightW||420, 320, 860)}px`);

  // font
  const ff = FONT_FAMILIES[state.appearance.fontFamily] || FONT_FAMILIES.system;
  document.documentElement.style.setProperty("--font", ff);

  // accent per theme
  const key = (state.theme==="light") ? (state.appearance.accentLight||"cyan") : (state.appearance.accentDark||"lime");
  const m = ACCENTS[key] || ACCENTS.cyan;
  document.documentElement.style.setProperty("--accent", m.a);
  document.documentElement.style.setProperty("--accent2", m.a2);

  // theme label
  $("themeLabel").textContent = state.theme==="light" ? "TH√àME CLAIR" : "TH√àME SOMBRE";
}

/* -------------------------
   Pools
------------------------- */
const TAGLINE_POOL = [
  "D√©gomme toutes les t√¢ches. R√©√©cris la r√©alit√©.",
  "Objectif: flow. R√©sultat: domination calme.",
  "Une t√¢che √† la fois. Sort ancien: neutralis√©.",
  "Mode qu√™te principale: activ√©. PNJ int√©rieur: rassur√©.",
  "Une micro-action = une faille dans l‚Äôempire du bazar.",
  "Le chaos a une arm√©e. Toi, tu as une strat√©gie."
];
const CELE_POOL = [
  {t:"CHANT DE VICTOIRE", m:"Une t√¢che est tomb√©e. Les montagnes administratives ont l√©g√®rement trembl√©."},
  {t:"BANNI√àRE PLANT√âE", m:"Territoire reconquis. La fronti√®re du chaos recule d‚Äôun pas."},
  {t:"ARCHITECTE DU R√âEL", m:"Tu viens de plier le temps en origami. R√©alit√©: stabilis√©e."},
  {t:"TECHNIQUE INTERDITE", m:"Coup pr√©cis. La t√¢che est KO avant d‚Äôavoir compris."},
  {t:"GESTE CLINIQUE NET", m:"Incision propre dans le chaos. H√©mostase parfaite. Fermeture: impeccable."},
  {t:"QU√äTE VALID√âE", m:"Objectif atteint. Butin: paix int√©rieure + points de dignit√©."},
  {t:"PORTAIL REFERM√â", m:"Tu viens de fermer une boucle mentale. Silence sacr√©."}
];
const TIPS_POOL = [
  {t:"R√àGLE DU LASER", m:"Une seule cible. Pas de multi-onglets. Ex√©cution."},
  {t:"CORPS = INTERRUPTEUR", m:"√âpaules basses, m√¢choire rel√¢ch√©e. Ton cerveau suit ton corps."},
  {t:"ANTI-FRICTION", m:"Enl√®ve un obstacle mat√©riel maintenant (c√¢ble, dossier, onglet)."},
  {t:"MICRO-CONTRAT", m:"Fais juste 1 √©torion. Apr√®s, tu ren√©gocies. (Spoiler: non.)"}
];
const EMO_NUDGES = [
  {t:"STOP (30s)", m:"Nommer l‚Äô√©motion: ¬´ Je remarque ___ ¬ª. Puis 3 respirations lentes."},
  {t:"ANCRAGE 5-4-3-2-1", m:"5 choses vues, 4 touch√©es, 3 entendues, 2 senties, 1 go√ªt√©e."},
  {t:"D√âFUSION", m:"Remplace ¬´ je suis nul¬∑le ¬ª par ¬´ j‚Äôai la pens√©e que‚Ä¶ ¬ª."},
  {t:"MICRO-CHOIX", m:"Quel est le prochain geste de 30 secondes qui va dans ton sens ?"}
];

/* -------------------------
   Parsing tasks
------------------------- */
function isAllCapsLine(line){
  const t = line.trim();
  if(!t) return false;
  const hasLetters = /[A-Za-z√Ä-√ñ√ò-√∂√∏-√ø]/.test(t);
  if(!hasLetters) return false;
  return t === t.toUpperCase() && t.length <= 90;
}
function parseTaskLine(line){
  const raw = line.trim();
  if(!raw) return null;
  const cleaned = raw.replace(/^[-*‚Ä¢\s]+/, "").trim();
  if(!cleaned) return null;

  let et = null;
  let title = cleaned;
  const m1 = cleaned.match(/^(.*?)(?:\s*[-‚Äì‚Äî]\s*|\s+)(\d+)\s*$/);
  if(m1){
    title = m1[1].trim();
    et = parseInt(m1[2],10);
  }
  title = title.replace(/\s+/g," ").trim();
  if(!title) return null;
  if(et!==null) et = clamp(et, 1, 99);
  return {title, etorions: et};
}
function importFromInbox(text){
  const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(l=>l.length>0);
  let cat = "INBOX";
  const out = [];
  for(const line of lines){
    if(isAllCapsLine(line)){
      cat = line.trim().toUpperCase();
      continue;
    }
    const parsed = parseTaskLine(line);
    if(!parsed) continue;
    out.push({
      id: uid(),
      title: parsed.title,
      cat,
      etorionsTotal: parsed.etorions ?? 1,
      etorionsLeft: parsed.etorions ?? 1,
      pinned: false,
      done: false,
      createdAt: nowISO(),
      doneAt: null
    });
  }
  return out;
}

/* -------------------------
   Tasks
------------------------- */
function activeTasks(){
  const inc = state.settings.includedCats;
  return state.tasks.filter(t=>!t.done).filter(t=>{
    if(!inc || inc.length===0) return true;
    return inc.includes(t.cat);
  });
}
function getTaskById(id){
  return state.tasks.find(t=>t.id===id) || null;
}
function setCurrentTask(id){
  state.currentTaskId = id;
  state.currentTaskStart = Date.now();
}
function sortTasks(list){
  const mode = state.settings.listSort || "roulette";
  if(mode==="alpha") return [...list].sort((a,b)=>a.title.localeCompare(b.title,"fr"));
  if(mode==="cat") return [...list].sort((a,b)=>{
    const c = a.cat.localeCompare(b.cat,"fr");
    return c!==0 ? c : a.title.localeCompare(b.title,"fr");
  });
  if(mode==="ordre") return [...list].sort((a,b)=> (a.createdAt||"").localeCompare(b.createdAt||""));
  return [...list].sort((a,b)=>{
    if(a.pinned && !b.pinned) return -1;
    if(!a.pinned && b.pinned) return 1;
    return (a.createdAt||"").localeCompare(b.createdAt||"");
  });
}
function roulettePick(){
  const list = sortTasks(activeTasks());
  if(list.length===0) return null;
  const pinned = list.filter(t=>t.pinned);
  const pool = pinned.length>0 ? pinned : list;
  return pool[rand(pool.length)];
}
function ensureCurrentTask(){
  const list = activeTasks();
  if(list.length===0){
    state.currentTaskId = null;
    state.currentTaskStart = null;
    return;
  }
  const cur = getTaskById(state.currentTaskId);
  if(!cur || cur.done){
    const pinned = list.find(t=>t.pinned);
    setCurrentTask((pinned||list[0]).id);
  }
}

/* -------------------------
   Progress
------------------------- */
function recomputeBaselineIfNeeded(){
  if(state.baseline.totalTasks===0 && state.baseline.totalEtorions===0 && state.tasks.length>0){
    const allActive = activeTasks();
    state.baseline.totalTasks = allActive.length;
    state.baseline.totalEtorions = allActive.reduce((a,t)=>a+(t.etorionsTotal||0),0);
  }
}
function computeProgress(){
  const baseT = state.baseline.totalTasks || 0;
  const baseE = state.baseline.totalEtorions || 0;
  const remaining = activeTasks();
  const remT = remaining.length;
  const remE = remaining.reduce((a,t)=>a+(t.etorionsLeft||0),0);
  const pct = (baseT<=0) ? 100 : clamp(Math.round((remT/baseT)*100), 0, 100);
  return { baseT, baseE, remT, remE, pct };
}

/* -------------------------
   Undo (task-related snapshots)
------------------------- */
function pushUndo(label){
  // store compact snapshot of task-run state
  const snap = {
    label,
    at: Date.now(),
    tasks: structuredClone(state.tasks),
    baseline: structuredClone(state.baseline),
    currentTaskId: state.currentTaskId,
    currentTaskStart: state.currentTaskStart,
    stats: structuredClone(state.stats)
  };
  state.undo.unshift(snap);
  state.undo = state.undo.slice(0, 12);
}
function undo(){
  const snap = state.undo.shift();
  if(!snap) return;
  state.tasks = snap.tasks;
  state.baseline = snap.baseline;
  state.currentTaskId = snap.currentTaskId;
  state.currentTaskStart = snap.currentTaskStart;
  state.stats = snap.stats;
  saveState();
  renderAll();
}

/* -------------------------
   Notes
------------------------- */
function addNote(text){
  const t = (text||"").trim();
  if(!t) return;
  state.notes.unshift({ id: uid(), text: t, at: nowISO() });
}
function renderNotes(){
  const list = state.notes || [];
  if(list.length===0){
    $("notesList").innerHTML = "<div class='small'>Aucune note.</div>";
    return;
  }
  $("notesList").innerHTML = list.slice(0,80).map(n=>{
    const dt = new Date(n.at);
    const stamp = dt.toLocaleString("fr-BE",{hour:"2-digit",minute:"2-digit", day:"2-digit", month:"2-digit"});
    return `<div style="padding:8px 6px; border-bottom:1px solid var(--line)">
      <div style="font-family:var(--mono); color:var(--muted); font-size:11px; letter-spacing:.06em">${stamp}</div>
      <div style="white-space:pre-wrap; font-size:13px">${escapeHTML(n.text)}</div>
    </div>`;
  }).join("");
}

/* -------------------------
   Habits + mini-charts
------------------------- */
function addHabit(name, slots){
  const nm = (name||"").trim();
  if(!nm) return;
  const sl = clamp(parseInt(slots,10)||8, 3, 12);
  const checks = Array.from({length:sl}, ()=>false);
  state.habits.push({ id: uid(), name:nm, slots:sl, checks, createdAt: nowISO() });
}
function habitProgress(h){
  const done = h.checks.filter(Boolean).length;
  const tot = h.checks.length;
  return {done, tot, pct: tot? Math.round(done/tot*100):0};
}
function toggleHabitCheck(hId, idx){
  const h = state.habits.find(x=>x.id===hId);
  if(!h) return;
  h.checks[idx] = !h.checks[idx];
}

/* -------------------------
   Sets
------------------------- */
function initSetsChecksForToday(){
  const dk = dayKey();
  for(const key of ["hospital","consult"]){
    const s = state.sets[key];
    if(!s.checks) s.checks = {};
    if(!s.checks[dk]) s.checks[dk] = {};
  }
}
function setKeyItem(setName, pIndex, itemIndex){
  return `${setName}|p${pIndex}|i${itemIndex}`;
}
function toggleSetCheck(setName, pIndex, itemIndex){
  initSetsChecksForToday();
  const dk = dayKey();
  const set = state.sets[setName];
  const k = setKeyItem(setName,pIndex,itemIndex);
  set.checks[dk][k] = !set.checks[dk][k];
}
function resetSetToday(setName){
  initSetsChecksForToday();
  const dk = dayKey();
  const set = state.sets[setName];
  set.checks[dk] = {};
}
function summarizeSetsToday(){
  initSetsChecksForToday();
  const dk = dayKey();
  const out = {};
  for(const key of ["hospital","consult"]){
    const set = state.sets[key];
    const checks = set.checks?.[dk] || {};
    const total = set.patients * set.itemsPerPatient.length;
    const done = Object.values(checks).filter(Boolean).length;
    out[key] = { done, total };
  }
  return out;
}

/* -------------------------
   Emotion Journal + charts
------------------------- */
const DISTORTIONS = [
  "Tout ou rien","Surg√©n√©ralisation","Filtre n√©gatif","Disqualification du positif",
  "Lecture de pens√©e","Catastrophisme","Doit / Il faut","Personnalisation",
  "Raisonnement √©motionnel","√âtiquetage"
];
const EMOTIONS = ["Anxi√©t√©","Col√®re","Tristesse","Honte","Culpabilit√©","Stress","Frustration","Soulagement","Joie","Fatigue","Solitude","D√©go√ªt","Peur","Irritabilit√©"];
const SKILLS = [
  "Respiration 4-6 (2 min)",
  "Ancrage 5-4-3-2-1 (1 min)",
  "D√©fusion: ¬´ j‚Äôai la pens√©e que‚Ä¶ ¬ª",
  "Opposite action (micro)",
  "Pause + eau + reprise",
  "Plan 1 √©torion (micro-action)",
  "R√©√©valuation √©crite (3 lignes)",
  "Auto-compassion br√®ve"
];
function addEmotionEntry(entry){
  state.emotions.entries.unshift(entry);
}
function emotionsToday(){
  const dk = dayKey();
  return (state.emotions.entries||[]).filter(e=>e.day===dk);
}

/* -------------------------
   History snapshot + calendar
------------------------- */
function snapshotDay(){
  const dk = dayKey();
  const doneToday = state.tasks.filter(t=>t.done && t.doneAt && t.doneAt.startsWith(dk));
  const active = activeTasks();
  const baseE = state.baseline.totalEtorions || 0;
  const doneE = (state.stats.etorionsDone||0);

  const habitsSummary = (state.habits||[]).map(h=>{
    const p = habitProgress(h);
    return { name:h.name, done:p.done, total:p.tot };
  });
  const sets = summarizeSetsToday();
  const emoToday = emotionsToday();
  const emoSummary = { count: emoToday.length, avg: avgIntensity(emoToday) };

  const entry = {
    day: dk,
    doneTitles: doneToday.map(t=>t.title),
    remainingTitles: active.map(t=>t.title),
    doneTasks: doneToday.length,
    remainingTasks: active.length,
    doneEtorions: doneE,
    baselineEtorions: baseE,
    habits: habitsSummary,
    sets,
    emotions: emoSummary
  };

  const idx = state.history.findIndex(x=>x.day===dk);
  if(idx>=0) state.history[idx] = entry;
  else state.history.unshift(entry);
}
function avgIntensity(list){
  if(!list || list.length===0) return 0;
  const vals = list.map(e=>Number(e.intensity)||0);
  return Math.round(vals.reduce((a,b)=>a+b,0)/vals.length);
}

/* -------------------------
   Confetti (monochrome)
------------------------- */
const conf = $("confetti");
const ctx = conf.getContext("2d");
let confettiPieces = [];
function resizeCanvas(){
  conf.width = window.innerWidth * devicePixelRatio;
  conf.height = window.innerHeight * devicePixelRatio;
  conf.style.width = window.innerWidth+"px";
  conf.style.height = window.innerHeight+"px";
  ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
}
window.addEventListener("resize", resizeCanvas);
resizeCanvas();

let confettiRAF = null;
function confettiBurst(strength=1){
  const w = window.innerWidth;
  const h = window.innerHeight;
  const n = Math.floor(170*strength);
  const centerX = w/2;
  const centerY = h/3;

  for(let i=0;i<n;i++){
    confettiPieces.push({
      x:centerX,
      y:centerY,
      vx:(Math.random()-0.5)*12*strength,
      vy:(Math.random()-0.8)*14*strength,
      g: (0.33 + Math.random()*0.25) * (0.9 + strength*0.2),
      r: 2 + Math.random()*4*strength,
      life: 85 + Math.random()*60,
      rot: Math.random()*Math.PI,
      vr: (Math.random()-0.5)*0.35
    });
  }
  animateConfetti();
}
function animateConfetti(){
  if(confettiRAF) return;
  const step = ()=>{
    ctx.clearRect(0,0,window.innerWidth,window.innerHeight);
    confettiPieces = confettiPieces.filter(p=>p.life>0);
    for(const p of confettiPieces){
      p.vy += p.g;
      p.x += p.vx;
      p.y += p.vy;
      p.rot += p.vr;
      p.life -= 1;

      ctx.save();
      ctx.translate(p.x,p.y);
      ctx.rotate(p.rot);
      ctx.globalAlpha = 0.86;
      ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue("--fg");
      ctx.fillRect(-p.r, -p.r, p.r*2, p.r*2);
      ctx.restore();
    }
    if(confettiPieces.length>0){
      confettiRAF = requestAnimationFrame(step);
    }else{
      cancelAnimationFrame(confettiRAF);
      confettiRAF = null;
      ctx.clearRect(0,0,window.innerWidth,window.innerHeight);
    }
  };
  confettiRAF = requestAnimationFrame(step);
}

/* -------------------------
   Modals
------------------------- */
let celeTimer=null, tipsTimer=null, nudgeTimer=null, countersTimer=null;

function openModal(id){
  $("modalBack").style.display = "block";
  $(id).style.display = "flex";
}
function closeAllModals(){
  ["notesModal","celeModal","tipsModal","emoNudgeModal"].forEach(id=>{
    $(id).style.display = "none";
  });
  $("modalBack").style.display = "none";
}
$("modalBack").addEventListener("click", closeAllModals);
["notesModal","celeModal","tipsModal","emoNudgeModal"].forEach(id=>{
  $(id).addEventListener("click", closeAllModals);
});

function showCelebration(forceStrength=1){
  const pick = CELE_POOL[rand(CELE_POOL.length)];
  $("celeTitle").textContent = pick.t;
  $("celeMsg").textContent = pick.m;

  const p = computeProgress();
  const done = (p.baseT - p.remT);
  $("celeSub").textContent = `${done} ${plural(done,"t√¢che","t√¢ches")} d√©gomm√©e${done===1?"":"s"} ¬∑ continue`;

  confettiBurst(1.45 * forceStrength);
  openModal("celeModal");

  const sec = clamp(parseInt(state.settings.celebrationAutoCloseSec,10)||11, 5, 20);
  if(celeTimer) clearTimeout(celeTimer);
  celeTimer = setTimeout(()=>closeAllModals(), sec*1000);
}
function maybeShowCelebration(){
  const chance = clamp(Number(state.settings.celebrationChance)||0.28, 0, 1);
  const p = computeProgress();
  const done = (p.baseT - p.remT);
  const boost = (done>0 && done%3===0) ? 0.20 : 0;
  if(Math.random() < clamp(chance + boost, 0, 0.80)){
    showCelebration(1);
  }
}
function showTip(){
  const pick = TIPS_POOL[rand(TIPS_POOL.length)];
  $("tipsTitle").textContent = pick.t;
  $("tipsMsg").textContent = pick.m;
  $("tipsSub").textContent = "Conseil bref ‚Üí retour au flow.";
  openModal("tipsModal");
  if(tipsTimer) clearTimeout(tipsTimer);
  tipsTimer = setTimeout(()=>closeAllModals(), 9000);
}
function showNudge(){
  const pick = EMO_NUDGES[rand(EMO_NUDGES.length)];
  $("emoNudgeTitle").textContent = pick.t;
  $("emoNudgeMsg").textContent = pick.m;
  $("emoNudgeSub").textContent = "Micro-r√©gulation ‚Üí puis reprise.";
  openModal("emoNudgeModal");
  if(nudgeTimer) clearTimeout(nudgeTimer);
  nudgeTimer = setTimeout(()=>closeAllModals(), 9000);
}

/* -------------------------
   Etorion + complete
------------------------- */
function degommeEtorion(){
  const t = getTaskById(state.currentTaskId);
  if(!t || t.done) return;

  pushUndo("etorion");

  if(typeof t.etorionsLeft!=="number") t.etorionsLeft = t.etorionsTotal||1;
  t.etorionsLeft = clamp(t.etorionsLeft - 1, 0, 99);
  state.stats.etorionsDone = (state.stats.etorionsDone||0) + 1;

  // optional micro-coach cadence
  if(state.settings.autoSuggestKiffance){
    const every = clamp(parseInt(state.settings.kiffanceSuggestEveryEto,10)||6, 3, 20);
    if(state.stats.etorionsDone>0 && state.stats.etorionsDone % every === 0){
      const r = Math.random();
      if(r<0.38) showTip();
      else if(r<0.56) showNudge();
    }
  }

  if(t.etorionsLeft<=0){
    completeTask(t.id);
    return;
  }

  snapshotDay();
  saveState();
  renderAll();
}
function completeTask(taskId){
  const t = getTaskById(taskId);
  if(!t || t.done) return;

  pushUndo("taskComplete");

  t.done = true;
  t.doneAt = nowISO();
  state.stats.tasksDone = (state.stats.tasksDone||0) + 1;

  confettiBurst(1.1);
  maybeShowCelebration();

  snapshotDay();
  ensureCurrentTask();
  saveState();
  renderAll();
}

/* -------------------------
   Counters show/hide
------------------------- */
function setCountersVisible(on, autoHide=true){
  state.showCounters = !!on;
  const pills = ["pillTasks","pillEto","pillDone","pillTimer"].map($);
  pills.forEach(p=>p.classList.toggle("hidden", !state.showCounters));
  saveState();

  if(countersTimer) clearTimeout(countersTimer);
  if(on && autoHide){
    countersTimer = setTimeout(()=>{
      state.showCounters = false;
      pills.forEach(p=>p.classList.add("hidden"));
      saveState();
    }, clamp(state.countersAutoHideSec||10, 3, 30) * 1000);
  }
}

/* -------------------------
   UI: theme / focus / panels
------------------------- */
function toggleTheme(){
  state.theme = (state.theme==="light") ? "dark" : "light";
  saveState();
  renderAll();
}
function applyFocus(){
  const app = $("app");
  if(state.focus) app.classList.add("focusOn");
  else app.classList.remove("focusOn");
}
function toggleFocus(){
  state.focus = !state.focus;
  saveState();
  renderAll();
}

/* Left drawer */
function openDrawer(){
  $("drawerBack").classList.add("show");
  $("drawer").classList.add("open");
  renderDrawer();
}
function closeDrawer(){
  $("drawerBack").classList.remove("show");
  $("drawer").classList.remove("open");
}

/* Right panel */
function openRight(){
  $("rightBack").classList.add("show");
  $("rightPanel").classList.add("open");
  renderRight();
}
function closeRight(){
  $("rightBack").classList.remove("show");
  $("rightPanel").classList.remove("open");
}

/* Resizers */
function initResizer(resId, which){
  const res = $(resId);
  let dragging=false, startX=0, startW=0;
  res.addEventListener("mousedown",(e)=>{
    dragging=true;
    startX=e.clientX;
    startW=clamp(which==="left" ? (state.drawerW||440) : (state.rightW||420), 320, 860);
    e.preventDefault();
  });
  window.addEventListener("mousemove",(e)=>{
    if(!dragging) return;
    const dx = e.clientX - startX;
    if(which==="left"){
      state.drawerW = clamp(startW + dx, 320, 860);
    }else{
      // dragging handle on left edge of right panel, so width grows opposite
      state.rightW = clamp(startW - dx, 320, 860);
    }
    applyAppearance();
  });
  window.addEventListener("mouseup",()=>{
    if(!dragging) return;
    dragging=false;
    saveState();
  });

  // touch
  res.addEventListener("touchstart",(e)=>{
    dragging=true;
    startX=e.touches[0].clientX;
    startW=clamp(which==="left" ? (state.drawerW||440) : (state.rightW||420), 320, 860);
    e.preventDefault();
  }, {passive:false});
  window.addEventListener("touchmove",(e)=>{
    if(!dragging) return;
    const dx = e.touches[0].clientX - startX;
    if(which==="left") state.drawerW = clamp(startW + dx, 320, 860);
    else state.rightW = clamp(startW - dx, 320, 860);
    applyAppearance();
  }, {passive:true});
  window.addEventListener("touchend",()=>{
    if(!dragging) return;
    dragging=false;
    saveState();
  });
}
initResizer("drawerResizer","left");
initResizer("rightResizer","right");

/* -------------------------
   HUD / timer
------------------------- */
function setRandomTagline(force=false){
  const el = $("tagline");
  if(force || Math.random()<0.22 || !el.textContent.trim()){
    el.textContent = TAGLINE_POOL[rand(TAGLINE_POOL.length)];
  }
}
function renderHUD(){
  recomputeBaselineIfNeeded();
  const p = computeProgress();
  $("pillTasks").textContent = `${p.remT}/${p.baseT} ${plural(p.baseT,"t√¢che","t√¢ches")}`;
  $("pillEto").textContent = `${p.remE}/${p.baseE} √©torions`;
  const done = (p.baseT - p.remT);
  $("pillDone").textContent = `${done} ${plural(done,"faite","faites")}`;
}
function renderTimer(){
  const el = $("pillTimer");
  if(!state.currentTaskStart){
    el.textContent = "00:00";
    return;
  }
  el.textContent = fmtMMSS(Date.now() - state.currentTaskStart);
}
let timerInterval=null;
function startTimerLoop(){
  if(timerInterval) clearInterval(timerInterval);
  timerInterval = setInterval(()=>{ if(state.showCounters) renderTimer(); }, 500);
}

/* -------------------------
   Render main
------------------------- */
function renderProgress(){
  const p = computeProgress();
  $("taskBarFill").style.width = `${p.pct}%`;
  $("taskBarPct").textContent = `${p.pct}%`;
  $("barInfo").textContent = `${p.remT} restantes sur ${p.baseT}`;
}
function renderCurrent(){
  ensureCurrentTask();
  const t = getTaskById(state.currentTaskId);
  if(!t){
    $("taskName").textContent = "Aucune t√¢che";
    $("chips").innerHTML = "";
    $("btnEtorion").style.opacity = 0.45;
    $("btnEtorion").style.pointerEvents = "none";
    return;
  }
  $("btnEtorion").style.opacity = 1;
  $("btnEtorion").style.pointerEvents = "auto";
  $("taskName").textContent = t.title;

  const total = t.etorionsTotal || 1;
  const left = (typeof t.etorionsLeft==="number") ? t.etorionsLeft : total;

  const chips = [];
  for(let i=0;i<total;i++){
    chips.push(`<div class="chip ${i<left?"on":""}"></div>`);
  }
  $("chips").innerHTML = chips.join("");
  if(!state.currentTaskStart) state.currentTaskStart = Date.now();
}
function applyListVisible(){
  const el = $("belowList");
  const show = !!state.showBelowList;
  el.classList.toggle("show", show && (!state.focus || state.settings.keepListInFocus));
}
function moveTask(id, delta){
  const idx = state.tasks.findIndex(t=>t.id===id);
  if(idx<0) return;
  const j = clamp(idx+delta, 0, state.tasks.length-1);
  const [it] = state.tasks.splice(idx,1);
  state.tasks.splice(j,0,it);
}
function renderBelowList(){
  const box = $("belowTasks");
  const list = sortTasks(activeTasks());
  if(list.length===0){
    box.innerHTML = `<div class="small">Aucune t√¢che.</div>`;
    return;
  }
  box.innerHTML = list.slice(0,50).map(t=>{
    const et = t.etorionsTotal||1;
    const left = t.etorionsLeft??et;
    const isCur = t.id===state.currentTaskId;
    return `
      <div class="taskRow" style="${isCur?"background:linear-gradient(180deg,var(--glass2),transparent); border-radius:10px; border:1px solid var(--line)":""}">
        <div class="t">${escapeHTML(t.title)}</div>
        <div class="meta">${left}/${et}</div>
        <div class="tools">
          <div class="toolBtn" data-act="up" data-id="${t.id}" title="Monter">‚Üë</div>
          <div class="toolBtn" data-act="down" data-id="${t.id}" title="Descendre">‚Üì</div>
          <div class="toolBtn" data-act="pin" data-id="${t.id}" title="√âpingler">${t.pinned?"‚ñ†":"‚ñ°"}</div>
          <div class="toolBtn" data-act="go" data-id="${t.id}" title="Cibler">‚óé</div>
          <div class="toolBtn" data-act="done" data-id="${t.id}" title="D√©gomm√©e">‚úì</div>
        </div>
      </div>
    `;
  }).join("");
  box.querySelectorAll(".toolBtn").forEach(b=>{
    b.onclick = ()=>{
      const id = b.getAttribute("data-id");
      const act = b.getAttribute("data-act");
      const t = getTaskById(id);
      if(!t) return;

      pushUndo("listAction");

      if(act==="up") moveTask(id,-1);
      if(act==="down") moveTask(id,1);
      if(act==="pin") t.pinned = !t.pinned;
      if(act==="go"){ setCurrentTask(id); }
      if(act==="done") completeTask(id);

      snapshotDay();
      saveState();
      renderAll();
    };
  });
}

function renderAll(){
  applyAppearance();
  applyFocus();
  setRandomTagline();
  recomputeBaselineIfNeeded();
  ensureCurrentTask();

  renderHUD();
  renderProgress();
  renderCurrent();
  renderBelowList();
  applyListVisible();

  // counters visibility
  setCountersVisible(state.showCounters, false); // don't restart timer here

  // enable/disable undo button
  $("btnUndo").style.opacity = state.undo.length ? 1 : 0.45;
  $("btnUndo").style.pointerEvents = state.undo.length ? "auto" : "none";
}

/* -------------------------
   Drawer (left) tabs
------------------------- */
const TAB_DEFS = [
  { key:"inbox", label:"INBOX" },
  { key:"liste", label:"LISTE" },
  { key:"kiff",  label:"KIFFANCE" },
  { key:"flow",  label:"FLOW" },
  { key:"app",   label:"APPARENCE" },
  { key:"hist",  label:"HIST" }
];

function buildTabs(){
  const el = $("tabs");
  el.innerHTML = "";
  TAB_DEFS.forEach(t=>{
    const b = document.createElement("div");
    b.className = "tab"+(state.activeTab===t.key?" active":"");
    b.textContent = t.label;
    b.onclick = ()=>{ state.activeTab=t.key; saveState(); renderDrawer(); };
    el.appendChild(b);
  });
}
function renderDrawer(){
  buildTabs();
  const body = $("drawerBody");
  body.innerHTML = "";
  if(state.activeTab==="inbox") body.appendChild(viewInbox());
  if(state.activeTab==="liste") body.appendChild(viewListe());
  if(state.activeTab==="kiff")  body.appendChild(viewKiffance());
  if(state.activeTab==="flow")  body.appendChild(viewFlow());
  if(state.activeTab==="app")   body.appendChild(viewAppearance());
  if(state.activeTab==="hist")  body.appendChild(viewHistory());
}

/* -------------------------
   Right panel tabs (SETS / HABITS / EMOTIONS)
------------------------- */
const RIGHT_TABS = [
  { key:"sets", label:"SETS" },
  { key:"habits", label:"HABITUDES" },
  { key:"emotions", label:"√âMOTIONS" }
];

function buildRightTabs(){
  const el = $("rightTabs");
  el.innerHTML = "";
  RIGHT_TABS.forEach(t=>{
    const b = document.createElement("div");
    b.className = "tab"+(state.rightTab===t.key?" active":"");
    b.textContent = t.label;
    b.onclick = ()=>{ state.rightTab=t.key; saveState(); renderRight(); };
    el.appendChild(b);
  });
}
function renderRight(){
  buildRightTabs();
  const body = $("rightBody");
  body.innerHTML = "";
  if(state.rightTab==="sets") body.appendChild(viewRightSets());
  if(state.rightTab==="habits") body.appendChild(viewRightHabits());
  if(state.rightTab==="emotions") body.appendChild(viewRightEmotions());
}

/* -------------------------
   Views ‚Äî Left
------------------------- */
function viewInbox(){
  const wrap = document.createElement("div");
  wrap.className = "section";
  wrap.innerHTML = `
    <h3>Importer des t√¢ches</h3>
    <div class="small" style="margin-bottom:8px">
      Cat√©gorie en MAJUSCULE + t√¢ches dessous. Chiffre final = √©torions.<br/>
      Exemple: <span style="font-family:var(--mono)">APPELS / Appeler X - 2</span>
    </div>
    <textarea id="inboxArea" placeholder="Colle ta liste ici"></textarea>
    <div class="row" style="margin-top:8px">
      <button class="btn primary" id="btnImport">IMPORTER</button>
      <button class="btn" id="btnClearInbox">VIDER</button>
      <button class="btn" id="btnOpenRight">PANNEAU DROIT</button>
    </div>
    <div class="small" id="importMsg" style="margin-top:8px"></div>
  `;
  setTimeout(()=>{
    const area = $("inboxArea");
    $("btnClearInbox").onclick = ()=> area.value="";
    $("btnOpenRight").onclick = ()=>{ openRight(); };
    $("btnImport").onclick = ()=>{
      const imported = importFromInbox(area.value||"");
      const msg = $("importMsg");
      if(imported.length===0){
        msg.textContent = "Rien import√©. V√©rifie le format.";
        return;
      }

      pushUndo("import");

      state.tasks.push(...imported);

      // update baseline so progress starts at 100% and decreases
      if(state.baseline.totalTasks===0 && state.baseline.totalEtorions===0){
        const act = activeTasks();
        state.baseline.totalTasks = act.length;
        state.baseline.totalEtorions = act.reduce((a,t)=>a+(t.etorionsTotal||0),0);
      }else{
        state.baseline.totalTasks += imported.length;
        state.baseline.totalEtorions += imported.reduce((a,t)=>a+(t.etorionsTotal||0),0);
      }

      snapshotDay();
      saveState();
      renderAll();
      msg.textContent = `${imported.length} ${plural(imported.length,"t√¢che import√©e","t√¢ches import√©es")}.`;
    };
  },0);
  return wrap;
}

function viewListe(){
  const wrap = document.createElement("div");
  wrap.className = "section";
  const cats = Array.from(new Set(state.tasks.map(t=>t.cat))).sort((a,b)=>a.localeCompare(b,"fr"));

  wrap.innerHTML = `
    <h3>Liste</h3>
    <div class="row" style="margin-bottom:8px">
      <select id="sortSel">
        <option value="roulette">roulette (pinned d‚Äôabord)</option>
        <option value="ordre">ordre d‚Äôimport</option>
        <option value="alpha">alphab√©tique</option>
        <option value="cat">par cat√©gorie</option>
      </select>
      <button class="btn" id="btnToggleBelow">${state.showBelowList?"MASQUER":"AFFICHER"} LISTE (√âCRAN)</button>
    </div>

    <div class="section" style="margin-bottom:10px">
      <h3>Cat√©gories incluses</h3>
      <div class="small" style="margin-bottom:8px">Vide = toutes. Sinon, coche celles √† inclure.</div>
      <div id="catsBox"></div>
      <div class="row" style="margin-top:8px">
        <button class="btn" id="catsAll">TOUTES</button>
        <button class="btn" id="catsNone">AUCUNE</button>
      </div>
    </div>

    <div class="section">
      <h3>Actions</h3>
      <div class="row">
        <button class="btn" id="btnResetRun">RESET SESSION (garde notes/habitudes/√©motions)</button>
        <button class="btn" id="btnPurgeDone">PURGER FAITES</button>
      </div>
    </div>
  `;

  setTimeout(()=>{
    $("sortSel").value = state.settings.listSort || "roulette";
    $("sortSel").onchange = (e)=>{
      state.settings.listSort = e.target.value;
      saveState(); renderAll(); renderDrawer();
    };
    $("btnToggleBelow").onclick = ()=>{
      state.showBelowList = !state.showBelowList;
      saveState(); renderAll(); renderDrawer();
    };

    // categories box
    const inc = state.settings.includedCats || [];
    const catsBox = $("catsBox");
    catsBox.innerHTML = cats.map(c=>{
      const checked = inc.length===0 ? true : inc.includes(c);
      return `
        <div class="row" style="justify-content:space-between; margin:6px 0">
          <div style="flex:1; min-width:0; font-size:13px; color:var(--fg); overflow:hidden; text-overflow:ellipsis; white-space:nowrap">${escapeHTML(c)}</div>
          <div class="toolBtn" style="width:40px" data-cat="${escapeHTML(c)}">${checked?"‚úì":""}</div>
        </div>
      `;
    }).join("");

    catsBox.querySelectorAll(".toolBtn").forEach(el=>{
      el.onclick = ()=>{
        const c = el.getAttribute("data-cat");
        let list = state.settings.includedCats || [];
        if(list.length===0) list = [...cats];
        if(list.includes(c)) list = list.filter(x=>x!==c);
        else list.push(c);
        state.settings.includedCats = (list.length===cats.length) ? [] : list;
        saveState(); ensureCurrentTask(); renderAll(); renderDrawer();
      };
    });

    $("catsAll").onclick = ()=>{
      state.settings.includedCats = [];
      saveState(); ensureCurrentTask(); renderAll(); renderDrawer();
    };
    $("catsNone").onclick = ()=>{
      state.settings.includedCats = ["__NONE__"];
      saveState(); ensureCurrentTask(); renderAll(); renderDrawer();
    };

    $("btnResetRun").onclick = ()=>{
      pushUndo("resetSession");
      state.tasks = [];
      state.baseline = { totalTasks:0, totalEtorions:0 };
      state.currentTaskId = null;
      state.currentTaskStart = null;
      state.stats = { etorionsDone:0, tasksDone:0 };
      state.settings.includedCats = [];
      snapshotDay();
      saveState();
      renderAll();
      renderDrawer();
    };

    $("btnPurgeDone").onclick = ()=>{
      pushUndo("purgeDone");
      state.tasks = state.tasks.filter(t=>!t.done);
      const act = activeTasks();
      state.baseline.totalTasks = act.length;
      state.baseline.totalEtorions = act.reduce((a,t)=>a+(t.etorionsTotal||0),0);
      snapshotDay();
      saveState();
      ensureCurrentTask();
      renderAll();
      renderDrawer();
    };
  },0);

  return wrap;
}

function viewKiffance(){
  const wrap = document.createElement("div");
  wrap.className = "section";
  wrap.innerHTML = `
    <h3>Kiffance</h3>
    <div class="small" style="margin-bottom:8px">
      Banque visible + ajout. (Le coaching flow vient aussi du panneau droit.)
    </div>
    <div class="section" style="margin-bottom:10px">
      <h3>Suggestion</h3>
      <div class="row">
        <button class="btn primary" id="kPick">RAFRA√éCHIR</button>
        <button class="btn" id="kAddToTasks">AJOUTER EN T√ÇCHE</button>
      </div>
      <div id="kOut" class="small" style="margin-top:10px; font-size:13px; color:var(--fg)"></div>
    </div>
    <div class="section" style="margin-bottom:10px">
      <h3>Afficher une cat√©gorie</h3>
      <div class="row">
        <select id="kBucket">
          <option value="5">‚â§ 5 min</option>
          <option value="10">‚â§ 10 min</option>
          <option value="15">‚â§ 15 min</option>
          <option value="25">‚â• 25 min</option>
        </select>
        <button class="btn" id="kShow">AFFICHER</button>
      </div>
      <div id="kList" class="small" style="margin-top:8px"></div>
    </div>
    <div class="section">
      <h3>Ajouter √† la banque</h3>
      <select id="kAddBucket">
        <option value="5">‚â§ 5 min</option>
        <option value="10">‚â§ 10 min</option>
        <option value="15">‚â§ 15 min</option>
        <option value="25">‚â• 25 min</option>
      </select>
      <textarea id="kText" placeholder="Action simple, sans fioriture."></textarea>
      <div class="row" style="margin-top:8px">
        <button class="btn primary" id="kAdd">AJOUTER</button>
      </div>
    </div>
  `;
  setTimeout(()=>{
    let last = pickKiffance();
    $("kOut").textContent = last;

    $("kPick").onclick = ()=>{
      last = pickKiffance();
      $("kOut").textContent = last;
    };
    $("kAddToTasks").onclick = ()=>{
      const t = last.trim();
      if(!t) return;
      pushUndo("kiffToTask");
      const et = 1;
      state.tasks.push({
        id: uid(),
        title: t,
        cat: "KIFFANCE",
        etorionsTotal: et,
        etorionsLeft: et,
        pinned: false,
        done: false,
        createdAt: nowISO(),
        doneAt: null
      });
      state.baseline.totalTasks += 1;
      state.baseline.totalEtorions += et;
      snapshotDay();
      saveState();
      ensureCurrentTask();
      renderAll();
    };

    $("kShow").onclick = ()=>{
      const b = $("kBucket").value;
      const list = state.kiffance.bank[b] || [];
      $("kList").innerHTML = list.length===0 ? "‚Äî" : list.map((x,i)=>`
        <div style="padding:6px 4px; border-bottom:1px solid var(--line)">
          <span style="font-family:var(--mono); color:var(--muted); font-size:11px">${i+1}</span>
          <span style="margin-left:8px">${escapeHTML(x)}</span>
        </div>
      `).join("");
    };

    $("kAdd").onclick = ()=>{
      const b = $("kAddBucket").value;
      const t = ($("kText").value||"").trim();
      if(!t) return;
      pushUndo("kiffAdd");
      state.kiffance.bank[b] = state.kiffance.bank[b] || [];
      state.kiffance.bank[b].push(t);
      $("kText").value = "";
      saveState();
      renderDrawer();
    };
  },0);
  return wrap;
}

function pickKiffance(){
  const min = state.settings.etorionMin || 5;
  const b = (min<=5)?"5":(min<=10)?"10":(min<=15)?"15":"25";
  const list = state.kiffance.bank[b] || [];
  if(list.length===0) return "Respire. Puis reviens.";
  return list[rand(list.length)];
}

function viewFlow(){
  const wrap = document.createElement("div");
  wrap.className = "section";
  wrap.innerHTML = `
    <h3>Flow</h3>
    <div class="section" style="margin-bottom:10px">
      <h3>Surprises</h3>
      <div class="row">
        <div>
          <div class="small">C√©l√©bration (0‚Äì1)</div>
          <input id="celeChance" type="number" step="0.05" min="0" max="1" />
        </div>
        <div>
          <div class="small">Auto-fermeture (sec)</div>
          <input id="celeSec" type="number" min="5" max="20" />
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn" id="testCele">TEST C√âL√âBRATION</button>
        <button class="btn" id="testTip">TEST CONSEIL</button>
        <button class="btn" id="testNudge">TEST R√âGULATION</button>
      </div>
    </div>

    <div class="section">
      <h3>Cadence coaching</h3>
      <div class="row">
        <div>
          <div class="small">Auto-sugg√©rer tous les X √©torions</div>
          <input id="kEvery" type="number" min="3" max="20" />
        </div>
        <div>
          <div class="small">Activer auto-suggestion</div>
          <select id="autoSugg">
            <option value="true">oui</option>
            <option value="false">non</option>
          </select>
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn primary" id="saveFlow">SAUVER</button>
      </div>
    </div>
  `;
  setTimeout(()=>{
    $("celeChance").value = state.settings.celebrationChance;
    $("celeSec").value = state.settings.celebrationAutoCloseSec;
    $("kEvery").value = state.settings.kiffanceSuggestEveryEto;
    $("autoSugg").value = String(!!state.settings.autoSuggestKiffance);

    $("testCele").onclick = ()=> showCelebration(1.2);
    $("testTip").onclick = ()=> showTip();
    $("testNudge").onclick = ()=> showNudge();

    $("saveFlow").onclick = ()=>{
      state.settings.celebrationChance = clamp(Number($("celeChance").value)||0,0,1);
      state.settings.celebrationAutoCloseSec = clamp(parseInt($("celeSec").value,10)||11,5,20);
      state.settings.kiffanceSuggestEveryEto = clamp(parseInt($("kEvery").value,10)||6,3,20);
      state.settings.autoSuggestKiffance = ($("autoSugg").value==="true");
      saveState();
      renderAll();
      renderDrawer();
    };
  },0);
  return wrap;
}

function viewAppearance(){
  const wrap = document.createElement("div");
  wrap.className = "section";
  wrap.innerHTML = `
    <h3>Apparence</h3>

    <div class="section" style="margin-bottom:10px">
      <h3>Surbrillance</h3>
      <div class="row">
        <div>
          <div class="small">Th√®me clair</div>
          <select id="accentLight">
            <option value="cyan">cyan</option>
            <option value="violet">violet</option>
            <option value="steel">steel</option>
            <option value="amber">amber</option>
            <option value="lime">lime</option>
          </select>
        </div>
        <div>
          <div class="small">Th√®me sombre</div>
          <select id="accentDark">
            <option value="lime">lime</option>
            <option value="cyan">cyan</option>
            <option value="violet">violet</option>
            <option value="amber">amber</option>
            <option value="steel">steel</option>
          </select>
        </div>
      </div>
    </div>

    <div class="section" style="margin-bottom:10px">
      <h3>Police & tailles</h3>
      <div class="row">
        <div>
          <div class="small">Police</div>
          <select id="fontFamily">
            <option value="system">system</option>
            <option value="elegant">elegant</option>
            <option value="neutral">neutral</option>
          </select>
        </div>
        <div>
          <div class="small">UI (boutons/pills)</div>
          <input id="uiScale" type="number" min="0.85" max="1.30" step="0.05" />
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <div>
          <div class="small">Titre ELIMINATOR</div>
          <input id="titleScale" type="number" min="0.85" max="1.45" step="0.05" />
        </div>
        <div>
          <div class="small">Nom de t√¢che</div>
          <input id="taskScale" type="number" min="1.00" max="1.80" step="0.05" />
        </div>
      </div>
    </div>

    <div class="section" style="margin-bottom:10px">
      <h3>Formes</h3>
      <div class="row">
        <div>
          <div class="small">Arrondi</div>
          <input id="radius" type="number" min="6" max="18" />
        </div>
        <div>
          <div class="small">Barre (hauteur)</div>
          <input id="barH" type="number" min="24" max="46" />
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <div>
          <div class="small">Cases √©torions</div>
          <input id="chipH" type="number" min="14" max="26" />
        </div>
        <div>
          <div class="small">Contours</div>
          <select id="borders">
            <option value="on">on</option>
            <option value="off">off</option>
          </select>
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <div>
          <div class="small">Style boutons</div>
          <select id="buttons">
            <option value="ghost">ghost</option>
            <option value="filled">filled</option>
          </select>
        </div>
        <div>
          <div class="small">Auto-hide compteurs (sec)</div>
          <input id="cAuto" type="number" min="3" max="30" />
        </div>
      </div>
    </div>

    <div class="section">
      <h3>Largeur panneaux</h3>
      <div class="row">
        <div>
          <div class="small">Menu gauche</div>
          <input id="dw" type="number" min="340" max="860" />
        </div>
        <div>
          <div class="small">Panneau droit</div>
          <input id="rw" type="number" min="320" max="860" />
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn primary" id="saveApp">APPLIQUER</button>
      </div>
    </div>
  `;
  setTimeout(()=>{
    $("accentLight").value = state.appearance.accentLight || "cyan";
    $("accentDark").value  = state.appearance.accentDark || "lime";
    $("fontFamily").value  = state.appearance.fontFamily || "system";
    $("uiScale").value     = state.appearance.uiScale ?? 1.00;
    $("titleScale").value  = state.appearance.titleScale ?? 1.00;
    $("taskScale").value   = state.appearance.taskScale ?? 1.22;
    $("radius").value      = state.appearance.radius ?? 12;
    $("barH").value        = state.appearance.barH ?? 34;
    $("chipH").value       = state.appearance.chipH ?? 18;
    $("borders").value     = state.appearance.borders || "on";
    $("buttons").value     = state.appearance.buttons || "ghost";
    $("cAuto").value       = state.countersAutoHideSec ?? 10;
    $("dw").value          = state.drawerW || 440;
    $("rw").value          = state.rightW || 420;

    $("saveApp").onclick = ()=>{
      state.appearance.accentLight = $("accentLight").value;
      state.appearance.accentDark  = $("accentDark").value;
      state.appearance.fontFamily  = $("fontFamily").value;

      state.appearance.uiScale     = clamp(Number($("uiScale").value)||1.0, 0.85, 1.30);
      state.appearance.titleScale  = clamp(Number($("titleScale").value)||1.0, 0.85, 1.45);
      state.appearance.taskScale   = clamp(Number($("taskScale").value)||1.22, 1.00, 1.80);

      state.appearance.radius      = clamp(parseInt($("radius").value,10)||12, 6, 18);
      state.appearance.barH        = clamp(parseInt($("barH").value,10)||34, 24, 46);
      state.appearance.chipH       = clamp(parseInt($("chipH").value,10)||18, 14, 26);

      state.appearance.borders     = $("borders").value;
      state.appearance.buttons     = $("buttons").value;

      state.countersAutoHideSec    = clamp(parseInt($("cAuto").value,10)||10, 3, 30);

      state.drawerW                = clamp(parseInt($("dw").value,10)||440, 340, 860);
      state.rightW                 = clamp(parseInt($("rw").value,10)||420, 320, 860);

      saveState();
      renderAll();
      renderDrawer();
      renderRight();
    };
  },0);
  return wrap;
}

function viewHistory(){
  const wrap = document.createElement("div");
  wrap.className = "section";
  snapshotDay();
  wrap.innerHTML = `
    <h3>Historique</h3>
    <div class="section" style="margin-bottom:10px">
      <h3>Jours r√©cents</h3>
      <div id="histList"></div>
    </div>
    <div class="section">
      <h3>Calendrier (30 jours)</h3>
      <div class="gridCal" id="calGrid"></div>
      <div class="small" style="margin-top:8px">Intensit√© = t√¢ches faites ¬∑ teinte = surbrillance.</div>
    </div>
  `;
  setTimeout(()=>{
    const box = $("histList");
    const hist = (state.history||[]).slice(0,14);
    box.innerHTML = hist.length===0 ? "‚Äî" : hist.map(h=>{
      const emo = h.emotions?.count||0;
      const avg = h.emotions?.avg||0;
      return `
        <div style="padding:8px 6px; border-bottom:1px solid var(--line)">
          <div style="font-family:var(--mono); color:var(--muted); font-size:11px; letter-spacing:.08em">${h.day}</div>
          <div style="font-size:13px">
            Faites: ${h.doneTasks} ¬∑ Restantes: ${h.remainingTasks} ¬∑ √âtorions: ${h.doneEtorions} ¬∑ √âmotions: ${emo}${emo?` (avg ${avg})`:""}
          </div>
        </div>
      `;
    }).join("");

    const grid = $("calGrid");
    const days = [];
    const today = new Date();
    for(let i=29;i>=0;i--){
      const d = new Date(today);
      d.setDate(today.getDate()-i);
      days.push(dayKey(d));
    }
    const map = {};
    (state.history||[]).forEach(e=>{ map[e.day] = e.doneTasks || 0; });
    const max = Math.max(1, ...Object.values(map));
    grid.innerHTML = days.map(dk=>{
      const v = map[dk] || 0;
      const intensity = clamp(v/max, 0, 1);
      const a = 0.06 + intensity*0.34;
      const dd = String(new Date(dk).getDate()).padStart(2,"0");
      return `
        <div class="calCell" title="${dk} ‚Äî ${v} ${plural(v,"t√¢che","t√¢ches")}">
          <div class="calInk" style="opacity:${a}"></div>
          <div class="calTxt">${dd}</div>
        </div>
      `;
    }).join("");
  },0);
  return wrap;
}

/* -------------------------
   Right panel views
------------------------- */
function viewRightSets(){
  const wrap = document.createElement("div");
  wrap.className = "section";
  initSetsChecksForToday();
  const dk = dayKey();

  wrap.innerHTML = `
    <h3>Sets</h3>
    <div class="small" style="margin-bottom:10px">Checklist √† droite = z√©ro oubli, z√©ro friction.</div>

    <div class="section" style="margin-bottom:10px">
      <h3>Hospitalier</h3>
      <div class="row" style="margin-bottom:8px">
        <input id="hospPatients" type="number" min="1" max="20" />
        <button class="btn" id="hospReset">RESET</button>
      </div>
      <div id="hospList"></div>
    </div>

    <div class="section">
      <h3>Consultation</h3>
      <div class="row" style="margin-bottom:8px">
        <input id="consPatients" type="number" min="1" max="30" />
        <button class="btn" id="consReset">RESET</button>
      </div>
      <div id="consList"></div>
    </div>
  `;

  setTimeout(()=>{
    $("hospPatients").value = state.sets.hospital.patients;
    $("consPatients").value = state.sets.consult.patients;

    $("hospPatients").onchange = (e)=>{
      state.sets.hospital.patients = clamp(parseInt(e.target.value,10)||4,1,20);
      saveState(); renderRight();
    };
    $("consPatients").onchange = (e)=>{
      state.sets.consult.patients = clamp(parseInt(e.target.value,10)||6,1,30);
      saveState(); renderRight();
    };
    $("hospReset").onclick = ()=>{ resetSetToday("hospital"); saveState(); renderRight(); snapshotDay(); };
    $("consReset").onclick = ()=>{ resetSetToday("consult"); saveState(); renderRight(); snapshotDay(); };

    const buildSetList = (key, boxId)=>{
      const set = state.sets[key];
      const checks = set.checks?.[dk] || {};
      const items = set.itemsPerPatient;
      const box = $(boxId);
      box.innerHTML = "";
      for(let p=1;p<=set.patients;p++){
        const head = document.createElement("div");
        head.className = "small";
        head.style.cssText = "font-family:var(--mono); letter-spacing:.06em; margin-top:10px";
        head.textContent = `Patient ${p}`;
        box.appendChild(head);

        items.forEach((it,idx)=>{
          const k = setKeyItem(key,p,idx);
          const on = !!checks[k];
          const row = document.createElement("div");
          row.style.cssText = "display:flex; align-items:center; gap:8px; margin:6px 0";
          row.innerHTML = `
            <div class="toolBtn" style="width:34px;height:30px" data-set="${key}" data-p="${p}" data-i="${idx}">${on?"‚úì":""}</div>
            <div style="font-size:13px; color:var(--fg)">${escapeHTML(it)}</div>
          `;
          row.querySelector(".toolBtn").onclick = ()=>{
            toggleSetCheck(key,p,idx);
            saveState();
            snapshotDay();
            renderRight();
          };
          box.appendChild(row);
        });
      }
    };

    buildSetList("hospital","hospList");
    buildSetList("consult","consList");
  },0);

  return wrap;
}

function viewRightHabits(){
  const wrap = document.createElement("div");
  wrap.className = "section";
  wrap.innerHTML = `
    <h3>Habitudes</h3>

    <div class="section" style="margin-bottom:10px">
      <h3>Ajouter</h3>
      <div class="row">
        <input id="hName" placeholder="Nom (ex: eau)" />
        <input id="hSlots" type="number" min="3" max="12" value="8" />
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn primary" id="hAdd">AJOUTER</button>
      </div>
    </div>

    <div class="section">
      <h3>Suivi</h3>
      <div id="hList"></div>
    </div>
  `;
  setTimeout(()=>{
    $("hAdd").onclick = ()=>{
      pushUndo("habitAdd");
      addHabit($("hName").value, $("hSlots").value);
      $("hName").value="";
      snapshotDay();
      saveState();
      renderRight();
      renderAll();
    };
    renderHabitsListRight();
  },0);
  return wrap;
}

function renderHabitsListRight(){
  const box = $("hList");
  if(!box) return;
  const list = state.habits || [];
  if(list.length===0){
    box.innerHTML = `<div class="small">Aucune habitude.</div>`;
    return;
  }
  box.innerHTML = list.map(h=>{
    const p = habitProgress(h);
    const checks = h.checks.map((v,idx)=>`
      <div class="toolBtn" style="width:34px;height:30px" data-h="${h.id}" data-i="${idx}">${v?"‚úì":""}</div>
    `).join("");
    return `
      <div class="section" style="margin-bottom:10px">
        <h3>${escapeHTML(h.name)} <span style="font-weight:400; letter-spacing:.06em">(${p.done}/${p.tot})</span></h3>
        <div class="spark" title="${p.pct}%">
          <div class="sparkFill" style="width:${p.pct}%"></div>
        </div>
        <div style="height:8px"></div>
        <div style="display:flex; gap:6px; flex-wrap:wrap; align-items:center">${checks}</div>
        <div class="row" style="margin-top:8px">
          <button class="btn" data-act="resetHabit" data-h="${h.id}">RESET</button>
          <button class="btn" data-act="delHabit" data-h="${h.id}">SUPPRIMER</button>
        </div>
      </div>
    `;
  }).join("");

  box.querySelectorAll(".toolBtn[data-h]").forEach(el=>{
    el.onclick = ()=>{
      pushUndo("habitToggle");
      const hId = el.getAttribute("data-h");
      const i = parseInt(el.getAttribute("data-i"),10);
      toggleHabitCheck(hId, i);
      snapshotDay();
      saveState();
      renderRight();
      renderAll();
    };
  });
  box.querySelectorAll("button[data-act]").forEach(b=>{
    b.onclick = ()=>{
      pushUndo("habitAction");
      const act = b.getAttribute("data-act");
      const hId = b.getAttribute("data-h");
      const h = state.habits.find(x=>x.id===hId);
      if(!h) return;
      if(act==="resetHabit") h.checks = h.checks.map(()=>false);
      if(act==="delHabit") state.habits = state.habits.filter(x=>x.id!==hId);
      snapshotDay();
      saveState();
      renderRight();
      renderAll();
    };
  });
}

function viewRightEmotions(){
  const wrap = document.createElement("div");
  wrap.className = "section";
  wrap.innerHTML = `
    <h3>√âmotions (TCC)</h3>

    <div class="section" style="margin-bottom:10px">
      <h3>Nouvelle entr√©e</h3>
      <div class="row">
        <select id="emoEmotion"></select>
        <input id="emoIntensity" type="number" min="0" max="100" value="60" />
      </div>
      <div class="row" style="margin-top:8px">
        <textarea id="emoSituation" placeholder="Situation (factuelle, courte)"></textarea>
      </div>
      <div class="row" style="margin-top:8px">
        <textarea id="emoThoughts" placeholder="Pens√©es automatiques"></textarea>
      </div>
      <div class="row" style="margin-top:8px">
        <select id="emoSkill"></select>
        <input id="emoAfter" type="number" min="0" max="100" value="40" />
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn primary" id="emoSave">ENREGISTRER</button>
        <button class="btn" id="emoQuick">MICRO-R√âGULATION</button>
      </div>
    </div>

    <div class="section" style="margin-bottom:10px">
      <h3>Aujourd'hui</h3>
      <div id="emoToday"></div>
      <div style="height:8px"></div>
      <div class="small">Graph: intensit√© moyenne (aujourd‚Äôhui)</div>
      <div class="spark" id="emoSpark"><div class="sparkFill" id="emoSparkFill" style="width:0%"></div></div>
    </div>

    <div class="section">
      <h3>Distorsions (rep√®res)</h3>
      <div class="small">${escapeHTML(DISTORTIONS.join(" ¬∑ "))}</div>
    </div>
  `;
  setTimeout(()=>{
    $("emoEmotion").innerHTML = EMOTIONS.map(e=>`<option value="${escapeHTML(e)}">${escapeHTML(e)}</option>`).join("");
    $("emoSkill").innerHTML = SKILLS.map(s=>`<option value="${escapeHTML(s)}">${escapeHTML(s)}</option>`).join("");

    $("emoQuick").onclick = ()=> showNudge();

    $("emoSave").onclick = ()=>{
      const day = dayKey();
      const time = new Date().toLocaleTimeString("fr-BE",{hour:"2-digit",minute:"2-digit"});
      const situation = ($("emoSituation").value||"").trim();
      const thoughts = ($("emoThoughts").value||"").trim();
      const emotion = $("emoEmotion").value;
      const intensity = clamp(parseInt($("emoIntensity").value,10)||0, 0, 100);
      const skillUsed = $("emoSkill").value;
      const afterIntensity = clamp(parseInt($("emoAfter").value,10)||0, 0, 100);

      if(!situation && !thoughts){
        showNudge();
        return;
      }

      pushUndo("emoAdd");

      addEmotionEntry({ id: uid(), day, time, situation, thoughts, emotion, intensity, skillUsed, afterIntensity });

      $("emoSituation").value="";
      $("emoThoughts").value="";

      snapshotDay();
      saveState();
      renderRight();
      renderAll();

      // a tiny tip sometimes (not celebration)
      if(Math.random()<0.14) showTip();
    };

    renderEmoTodayRight();
  },0);

  return wrap;
}

function renderEmoTodayRight(){
  const box = $("emoToday");
  if(!box) return;
  const list = emotionsToday();
  if(list.length===0){
    box.innerHTML = `<div class="small">Aucune entr√©e.</div>`;
    $("emoSparkFill").style.width = "0%";
    return;
  }
  box.innerHTML = list.slice(0,10).map(e=>{
    return `
      <div style="padding:8px 6px; border-bottom:1px solid var(--line)">
        <div style="font-family:var(--mono); color:var(--muted); font-size:11px; letter-spacing:.06em">
          ${escapeHTML(e.time)} ‚Äî ${escapeHTML(e.emotion)} ${e.intensity}‚Üí${e.afterIntensity} ¬∑ ${escapeHTML(e.skillUsed||"")}
        </div>
        <div style="font-size:13px; margin-top:4px">${escapeHTML(e.situation||"‚Äî")}</div>
      </div>
    `;
  }).join("");

  const avg = avgIntensity(list);
  $("emoSparkFill").style.width = `${avg}%`;
}

/* -------------------------
   Wire actions
------------------------- */
$("btnMenu").onclick = openDrawer;
$("drawerClose").onclick = closeDrawer;
$("drawerBack").onclick = closeDrawer;

$("btnRight").onclick = openRight;
$("rightClose").onclick = closeRight;
$("rightBack").onclick = closeRight;

$("btnTheme").onclick = toggleTheme;

$("btnFocus").onclick = toggleFocus;

$("btnCounters").onclick = ()=>{
  // show now, then auto-hide
  setCountersVisible(!state.showCounters, true);
  if(state.showCounters) renderHUD();
};

$("btnListToggle").onclick = ()=>{
  state.showBelowList = !state.showBelowList;
  saveState();
  renderAll();
};

$("btnUndo").onclick = ()=> undo();

$("btnRoulette").onclick = ()=>{
  const el = $("btnRoulette");
  el.classList.remove("rouletteSpin");
  void el.offsetWidth;
  el.classList.add("rouletteSpin");

  const pick = roulettePick();
  if(!pick) return;
  setTimeout(()=>{
    pushUndo("roulette");
    setCurrentTask(pick.id);
    snapshotDay();
    saveState();
    renderAll();
    if(Math.random()<0.14) showTip();
    if(Math.random()<0.10) showNudge();
  }, 230);
};

$("btnEtorion").onclick = degommeEtorion;

$("btnNotes").onclick = ()=>{
  renderNotes();
  openModal("notesModal");
};

$("noteAdd").onclick = ()=>{
  addNote($("noteInput").value);
  $("noteInput").value="";
  saveState();
  renderNotes();
};
$("noteClear").onclick = ()=>{ $("noteInput").value=""; };

$("btnDoneTask").onclick = ()=>{
  const t = getTaskById(state.currentTaskId);
  if(!t) return;
  completeTask(t.id);
};

$("btnEditTask").onclick = ()=>{
  const t = getTaskById(state.currentTaskId);
  if(!t) return;
  const nv = prompt("√âditer la t√¢che (titre)", t.title);
  if(nv===null) return;
  const v = nv.trim();
  if(!v) return;
  pushUndo("editTask");
  t.title = v;
  snapshotDay();
  saveState();
  renderAll();
};

$("btnHideBelow").onclick = ()=>{
  state.showBelowList = false;
  saveState();
  renderAll();
};

/* -------------------------
   Init
------------------------- */
applyAppearance();
applyFocus();
setRandomTagline(true);
snapshotDay();
renderAll();
renderDrawer();
startTimerLoop();

// refresh the right panel live (if open)
document.addEventListener("visibilitychange", ()=>{
  if(!document.hidden){
    snapshotDay();
    renderAll();
    if($("rightPanel").classList.contains("open")) renderRight();
  }
});

// keep right panel content in sync after renderAll
const origRenderAll = renderAll;
renderAll = function(){
  origRenderAll();
  if($("rightPanel").classList.contains("open")) renderRight();
};

// initial right panel content (but closed)
renderRight();

// ensure counters match state at start
setCountersVisible(state.showCounters, false);
  </script>
</body>
</html>
