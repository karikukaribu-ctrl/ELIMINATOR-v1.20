<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ELIMINATOR</title>

  <!-- Polices "soft / Ghibli-ish" (rondes, chaleureuses) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&family=Fredoka:wght@400;600;700&family=Comfortaa:wght@400;700&family=Patrick+Hand&display=swap" rel="stylesheet">

  <style>
    :root{
      /* Base */
      --bg:#f4f6fb; --fg:#0d1321; --muted: rgba(13,19,33,.62);
      --glass: rgba(255,255,255,.62); --glass2: rgba(255,255,255,.36);
      --lineA: rgba(13,19,33,.14); --line: var(--lineA);
      --shadow: 0 18px 60px rgba(0,0,0,.10);
      --blur: 18px;

      /* Palette par défaut = ocre / bordeaux doux */
      --accent: rgba(198, 126, 40, .18);      /* ocre */
      --accent2: rgba(198, 126, 40, .34);
      --barAccent: rgba(198, 126, 40, .22);
      --barAccent2: rgba(198, 126, 40, .44);

      /* UI */
      --radius: 8px;
      --radius2: 6px;

      --uiScale: 1.00;
      --titleScale: 1.12;
      --taskScale: 1.42;

      /* Barre (grosse + adaptable) */
      --barH: clamp(64px, 10vh, 120px);
      --barText: clamp(18px, 2.4vw, 28px);
      --barBlockMinH: clamp(120px, 24vh, 220px); /* "au moins 25% de la moitié de l'écran" approx -> gros bloc */

      --chipH: 18px;

      --appW: min(1320px, 96vw);
      --vpad: clamp(10px, 2.2vh, 18px);
      --hpad: clamp(10px, 2.2vw, 18px);

      --font: "Nunito", ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial;
      --display: "Fredoka", "Nunito", ui-sans-serif, system-ui;
      --hand: "Patrick Hand", "Nunito", ui-sans-serif;
      --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;

      --btnFill: 0;
      --drawerW: 460px;
      --rightW: 560px;

      --topbarH: 72px;
    }

    /* Sombre mais pas cave de Mordor */
    [data-theme="dark"]{
      --bg:#0e1422; --fg:#eaf0ff; --muted: rgba(234,240,255,.66);
      --glass: rgba(20,28,46,.62); --glass2: rgba(20,28,46,.36);
      --lineA: rgba(234,240,255,.14);
      --shadow: 0 18px 90px rgba(0,0,0,.40);
      --blur: 20px;

      --accent: rgba(131, 26, 36, .18);        /* bordeaux */
      --accent2: rgba(131, 26, 36, .34);
      --barAccent: rgba(208, 138, 56, .16);    /* ocre plus doux en sombre */
      --barAccent2: rgba(208, 138, 56, .34);
    }

    /* Pastel “Ghibli-like” (ludique) */
    [data-theme="pastel"]{
      --bg:#f7f3ea; --fg:#1f2937; --muted: rgba(31,41,55,.62);
      --glass: rgba(255,255,255,.70); --glass2: rgba(255,255,255,.42);
      --lineA: rgba(31,41,55,.14);
      --shadow: 0 20px 70px rgba(0,0,0,.12);
      --blur: 18px;

      --accent: rgba(120, 190, 170, .20);     /* vert d’eau */
      --accent2: rgba(120, 190, 170, .38);
      --barAccent: rgba(244, 173, 104, .22);  /* orange pastel */
      --barAccent2: rgba(244, 173, 104, .44);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: var(--font);
      background:
        radial-gradient(1200px 700px at 25% 15%, rgba(255,255,255,.45), transparent 60%),
        radial-gradient(1000px 680px at 80% 30%, rgba(0,0,0,.06), transparent 60%),
        var(--bg);
      color: var(--fg);
      overflow-x:hidden;
    }
    [data-theme="dark"] body{
      background:
        radial-gradient(1200px 700px at 25% 15%, rgba(131,26,36,.10), transparent 60%),
        radial-gradient(1100px 720px at 80% 30%, rgba(198,126,40,.08), transparent 60%),
        var(--bg);
    }
    [data-theme="pastel"] body{
      background:
        radial-gradient(1200px 700px at 25% 15%, rgba(120,190,170,.20), transparent 60%),
        radial-gradient(1100px 720px at 80% 30%, rgba(244,173,104,.18), transparent 60%),
        var(--bg);
    }

    .wrap{
      min-height:100%;
      display:flex;
      flex-direction:column;
      gap: clamp(10px, 1.6vh, 14px);
      padding: calc(var(--vpad) + var(--topbarH) + 14px) var(--hpad) calc(var(--vpad) + 10px);
      align-items:center;
    }

    /* TOPBAR VRAIMENT FIXE */
    .topbar{
      width: var(--appW);
      height: var(--topbarH);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding: 10px 10px;
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: linear-gradient(180deg, var(--glass), rgba(255,255,255,.10));
      backdrop-filter: blur(var(--blur));
      box-shadow: var(--shadow);
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      top: 10px;
      z-index: 70;
    }

    .topbar .left, .topbar .right{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      min-width:0;
    }
    .topbar .right{ justify-content:flex-end; }

    .btn{
      border:1px solid var(--line);
      background: transparent;
      color:var(--fg);
      border-radius: var(--radius2);
      padding: calc(8px * var(--uiScale)) calc(10px * var(--uiScale));
      font-size: calc(12px * var(--uiScale));
      letter-spacing:.08em;
      text-transform:uppercase;
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
      transition: transform 140ms ease, background 120ms ease, opacity 120ms ease;
      font-family: var(--mono);
    }
    .btn:hover{ background: rgba(0,0,0,.04); }
    [data-theme="dark"] .btn:hover{ background: rgba(255,255,255,.06); }
    [data-theme="pastel"] .btn:hover{ background: rgba(0,0,0,.03); }
    .btn:active{ transform: translateY(1px); }

    .btn.icon{
      width: calc(40px * var(--uiScale));
      height: calc(36px * var(--uiScale));
      display:grid;
      place-items:center;
      padding:0;
      letter-spacing:0;
      text-transform:none;
      font-size: calc(15px * var(--uiScale));
    }

    .btn.primary{
      background:
        radial-gradient(700px 200px at 20% 40%, var(--accent2), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255, calc(.25 * var(--btnFill))), rgba(0,0,0,0));
      box-shadow: inset 0 0 0 1px var(--line);
      font-weight: 900;
    }

    .pill{
      padding: calc(6px * var(--uiScale)) calc(10px * var(--uiScale));
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.03);
      color: var(--muted);
      font-size: calc(12px * var(--uiScale));
      font-family: var(--mono);
      white-space:nowrap;
      user-select:none;
    }
    [data-theme="dark"] .pill{ background: rgba(255,255,255,.05); }
    .pill.hidden{ display:none; }
    .pill.hot{
      color: var(--fg);
      background:
        radial-gradient(550px 180px at 20% 40%, var(--barAccent2), transparent 62%),
        rgba(0,0,0,.02);
      font-weight: 900;
    }

    .hero{
      width: var(--appW);
      display:flex;
      flex-direction:column;
      align-items:center;
      gap: 8px;
      padding: 2px 8px 0;
    }
    .title{
      font-family: var(--display);
      font-size: calc(clamp(54px, 5.8vw, 92px) * var(--titleScale));
      letter-spacing: .18em;
      text-transform:uppercase;
      margin: 6px 0 0;
      font-weight: 900;
      line-height:1.02;
      text-align:center;
      text-shadow: 0 10px 30px rgba(0,0,0,.10);
    }
    .tag{
      font-family: var(--hand);
      font-size: clamp(14px, 1.4vw, 18px);
      color: var(--muted);
      text-align:center;
      max-width: 78ch;
      padding: 0 8px;
      min-height: 18px;
      letter-spacing: .02em;
    }

    .main{
      width: var(--appW);
      display:flex;
      flex-direction:column;
      gap: clamp(12px, 2.2vh, 18px);
      align-items:center;
      flex:1;
      justify-content:center;
    }

    /* GROS BLOC PROGRESSION */
    .barWrap{
      width:100%;
      min-height: var(--barBlockMinH);
      display:flex;
      flex-direction:column;
      gap: 14px;
      padding: 18px 16px 18px;
      border:1px solid var(--line);
      border-radius: var(--radius);
      background:
        radial-gradient(900px 260px at 25% 15%, var(--glass2), transparent 60%),
        linear-gradient(180deg, var(--glass), rgba(255,255,255,.08));
      backdrop-filter: blur(var(--blur));
      box-shadow: var(--shadow);
    }
    .barRow{ display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; }
    .barLabel{
      font-size: 12px;
      letter-spacing:.10em;
      text-transform:uppercase;
      color: var(--muted);
      font-family: var(--mono);
    }
    .bar{
      width:100%;
      height: var(--barH);
      border:1px solid var(--line);
      background: rgba(0,0,0,.03);
      border-radius: calc(var(--radius2) + 2px);
      position:relative;
      overflow:hidden;
    }
    [data-theme="dark"] .bar{ background: rgba(255,255,255,.06); }
    .barFill{
      position:absolute; inset:0;
      width:100%;
      background:
        radial-gradient(900px 220px at 25% 50%, var(--barAccent2), transparent 58%),
        linear-gradient(90deg, var(--barAccent), transparent 72%);
      transition: width 260ms ease;
    }
    .barPct{
      position:absolute; inset:0;
      display:grid;
      place-items:center;
      font-family: var(--display);
      font-size: var(--barText);
      color: var(--fg);
      opacity:.95;
      pointer-events:none;
      letter-spacing: .06em;
      text-transform: uppercase;
      font-weight: 900;
      text-shadow: 0 10px 24px rgba(0,0,0,.12);
    }

    .current{
      width:100%;
      padding: 16px 16px 14px;
      border:1px solid var(--line);
      border-radius: var(--radius);
      background:
        radial-gradient(700px 240px at 20% 0%, var(--glass2), transparent 70%),
        linear-gradient(180deg, var(--glass), rgba(255,255,255,.08));
      backdrop-filter: blur(var(--blur));
      box-shadow: var(--shadow);
      display:flex;
      flex-direction:column;
      gap: 14px;
    }

    .taskName{
      font-family: var(--display);
      font-size: calc(clamp(30px, 4.2vw, 62px) * var(--taskScale));
      font-weight: 900;
      letter-spacing:.02em;
      text-align:center;
      line-height:1.06;
      padding: 4px 6px;
      word-break: break-word;
    }

    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      justify-content:center;
      padding: 0;
    }
    .chip{
      width: var(--chipH);
      height: var(--chipH);
      border-radius: 3px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.03);
    }
    [data-theme="dark"] .chip{ background: rgba(255,255,255,.05); }
    .chip.on{ background: var(--barAccent2); }

    .actions{
      display:flex;
      gap:12px;
      justify-content:center;
      flex-wrap:wrap;
      align-items:center;
    }

    .roulette{
      width: clamp(110px, 14vw, 170px);
      height: clamp(110px, 14vw, 170px);
      border-radius: 999px;
      border:1px solid var(--line);
      background:
        radial-gradient(circle at 30% 30%, var(--glass2), transparent 60%),
        linear-gradient(180deg, var(--glass2), transparent);
      backdrop-filter: blur(var(--blur));
      box-shadow: var(--shadow);
      display:grid;
      place-items:center;
      cursor:pointer;
      user-select:none;
      transition: transform 140ms ease;
      position:relative;
      overflow:hidden;
    }
    .roulette:active{ transform: translateY(1px) scale(.99); }
    .rouletteText{
      font-size: 12px;
      letter-spacing:.14em;
      text-transform:uppercase;
      color: var(--fg);
      opacity:.92;
      font-weight: 900;
      font-family: var(--mono);
    }
    .rouletteRing{
      position:absolute; inset:10px;
      border-radius:999px;
      border:1px dashed var(--line);
      opacity:.85;
    }
    .rouletteNeedle{
      position:absolute; top: 10px; left: 50%;
      width: 0; height: 0;
      border-left: 8px solid transparent;
      border-right: 8px solid transparent;
      border-bottom: 14px solid rgba(0,0,0,.18);
      transform: translateX(-50%);
      opacity:.9;
    }
    [data-theme="dark"] .rouletteNeedle{ border-bottom-color: rgba(255,255,255,.18); }
    .rouletteSpin{ animation: spin 860ms cubic-bezier(.08,.92,.20,1) 1; }
    @keyframes spin{ 0%{ transform: rotate(0deg); } 100%{ transform: rotate(1080deg); } }

    .bomb{
      min-width: clamp(190px, 28vw, 320px);
      padding: 14px 16px;
      border-radius: var(--radius2);
      border:1px solid var(--line);
      background:
        radial-gradient(700px 220px at 25% 40%, var(--barAccent2), transparent 62%),
        linear-gradient(180deg, var(--glass2), transparent);
      cursor:pointer;
      text-transform:uppercase;
      letter-spacing:.10em;
      font-size: 12px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:12px;
      user-select:none;
      box-shadow: var(--shadow);
      transition: transform 140ms ease;
      font-family: var(--mono);
      font-weight: 900;
    }
    .bomb:active{ transform: translateY(1px) scale(.99); }
    .bomb .em{ font-family: var(--mono); font-size: 16px; opacity:.92; }
    .bomb .label{ display:flex; flex-direction:column; line-height:1.10; align-items:center; }
    .bomb .label span{ font-size: 12px; font-family: var(--mono); }
    .bomb .label small{
      font-size: 10px;
      color: var(--muted);
      letter-spacing:.14em;
      text-transform:uppercase;
      font-family: var(--mono);
    }

    .miniRow{ display:flex; gap:10px; justify-content:center; align-items:center; flex-wrap:wrap; }
    .miniIcon{
      width:56px; height:56px;
      border-radius: var(--radius2);
      border:1px solid var(--line);
      display:grid;
      place-items:center;
      cursor:pointer;
      background: transparent;
      box-shadow: var(--shadow);
      font-family: var(--mono);
      font-size: 15px;
      user-select:none;
      transition: transform 140ms ease, background 120ms ease;
      letter-spacing:.06em;
    }
    .miniIcon:hover{ background: rgba(0,0,0,.03); }
    [data-theme="dark"] .miniIcon:hover{ background: rgba(255,255,255,.05); }
    .miniIcon:active{ transform: translateY(1px) scale(.99); }
    .miniLabel{ width:auto; padding: 0 12px; font-size: 12px; text-transform:uppercase; }

    /* SETS SUR L'INTERFACE (alignés) */
    .setsDock{
      width: 100%;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 860px){
      .setsDock{ grid-template-columns: 1fr; }
    }
    .setCard{
      border:1px solid var(--line);
      border-radius: var(--radius);
      background:
        radial-gradient(700px 220px at 20% 10%, var(--glass2), transparent 60%),
        linear-gradient(180deg, var(--glass), rgba(255,255,255,.06));
      box-shadow: var(--shadow);
      padding: 10px;
      backdrop-filter: blur(var(--blur));
    }
    .setHead{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding-bottom:8px;
      border-bottom:1px solid var(--line);
      margin-bottom:8px;
    }
    .setTitle{
      font-family: var(--mono);
      font-size: 12px;
      letter-spacing:.12em;
      text-transform:uppercase;
      color: var(--muted);
      font-weight: 900;
    }
    .setMeta{
      font-family: var(--mono);
      font-size: 11px;
      color: var(--muted);
      white-space:nowrap;
    }
    .setGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    .setUnit{
      border:1px solid var(--line);
      border-radius: var(--radius2);
      padding: 8px;
      background: rgba(0,0,0,.02);
    }
    [data-theme="dark"] .setUnit{ background: rgba(255,255,255,.04); }
    .setUnitTitle{
      font-family: var(--mono);
      font-size: 11px;
      color: var(--muted);
      letter-spacing:.10em;
      text-transform:uppercase;
      margin-bottom:8px;
      font-weight: 900;
    }
    .setBtns{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
    }
    .setBtn{
      border:1px solid var(--line);
      border-radius: var(--radius2);
      padding: 8px 8px;
      background: transparent;
      font-family: var(--mono);
      font-size: 11px;
      cursor:pointer;
      letter-spacing:.06em;
      text-transform:uppercase;
      user-select:none;
    }
    .setBtn.on{
      background:
        radial-gradient(550px 180px at 20% 50%, var(--accent2), transparent 62%),
        rgba(0,0,0,.02);
      color: var(--fg);
      font-weight: 900;
    }

    /* Emotions mini-résumé (plus joli) */
    .emoDock{
      width:100%;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:center;
    }
    .emoChip{
      border:1px solid var(--line);
      border-radius: 999px;
      padding: 8px 10px;
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing:.08em;
      text-transform:uppercase;
      background: rgba(0,0,0,.02);
      color: var(--fg);
      display:flex;
      gap:8px;
      align-items:center;
      user-select:none;
    }
    [data-theme="dark"] .emoChip{ background: rgba(255,255,255,.04); }
    .emoDot{
      width:10px; height:10px;
      border-radius:999px;
      background: var(--barAccent2);
      border:1px solid var(--line);
    }

    .small{ font-size:12px; color: var(--muted); font-family: var(--mono); }

    .focusOn .topbar .btn:not(.keepFocus),
    .focusOn .topbar .right{ display:none !important; }
    .focusOn .topbar{ justify-content:center; }
    .focusOn .topbar .left{ width:100%; justify-content:center; }

    .drawerBack, .rightBack, .modalBack{
      position:fixed; inset:0;
      background: rgba(0,0,0,.22);
      backdrop-filter: blur(10px);
      display:none;
      z-index:80;
    }
    .drawer, .rightPanel{
      position:fixed; top:0;
      height:100%;
      background: var(--glass);
      backdrop-filter: blur(var(--blur));
      box-shadow: var(--shadow);
      transition: transform 220ms ease;
      z-index:90;
      display:flex;
      flex-direction:column;
    }
    .drawer{
      left:0;
      width: min(var(--drawerW), 94vw);
      border-right:1px solid var(--line);
      transform: translateX(-105%);
    }
    .rightPanel{
      right:0;
      width: min(var(--rightW), 94vw);
      border-left:1px solid var(--line);
      transform: translateX(105%);
      z-index:85;
    }
    .drawer.open{ transform: translateX(0); }
    .rightPanel.open{ transform: translateX(0); }
    .drawerBack.show, .rightBack.show{ display:block; }

    .drawerTop, .rightTop{
      display:flex; justify-content:space-between; align-items:center;
      padding: 10px 12px;
      border-bottom:1px solid var(--line);
      gap:10px;
    }
    .drawerTitle, .rightTitle{
      font-size: 12px;
      letter-spacing:.14em;
      text-transform:uppercase;
      color: var(--muted);
      font-family: var(--mono);
      font-weight: 900;
    }
    .tabs, .rightTabs{
      display:flex; gap:8px; padding: 10px 12px 6px; flex-wrap:wrap;
    }
    .tab{
      padding: 7px 9px;
      border-radius: var(--radius2);
      border:1px solid var(--line);
      cursor:pointer;
      font-size: 11px;
      letter-spacing:.12em;
      text-transform:uppercase;
      color: var(--muted);
      user-select:none;
      font-family: var(--mono);
      font-weight: 900;
    }
    .tab.active{
      color: var(--fg);
      background:
        radial-gradient(600px 180px at 20% 50%, var(--accent2), transparent 62%),
        linear-gradient(180deg, var(--glass2), transparent);
      box-shadow: inset 0 0 0 1px var(--line);
    }
    .drawerBody, .rightBody{ padding: 10px 12px 18px; overflow:auto; }

    .section{
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding: 10px;
      background: rgba(0,0,0,.02);
    }
    [data-theme="dark"] .section{ background: rgba(255,255,255,.04); }
    .section h3{
      margin: 0 0 8px;
      font-size: 11px;
      letter-spacing:.14em;
      text-transform:uppercase;
      color: var(--muted);
      font-family: var(--mono);
      font-weight: 900;
    }

    textarea, input, select{
      width:100%;
      border:1px solid var(--line);
      background: transparent;
      color: var(--fg);
      border-radius: var(--radius2);
      padding: 10px;
      outline:none;
      font-family: var(--font);
      font-size: 13px;
    }
    textarea{ min-height: 120px; resize:vertical; }
    .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .row > *{ flex:1; min-width: 140px; }

    .modal{
      position:fixed; inset:0;
      display:none;
      z-index:120;
      padding: 18px;
      align-items:center;
      justify-content:center;
    }
    .modalCard{
      width:min(980px, 96vw);
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: var(--glass);
      backdrop-filter: blur(var(--blur));
      box-shadow: var(--shadow);
      padding: 12px;
      position:relative;
      max-height: 86vh;
      overflow:auto;
    }
    .modalHead{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding: 6px 6px 10px;
      border-bottom:1px solid var(--line);
      margin-bottom:10px;
    }
    .modalHead .mh{
      font-size: 12px; letter-spacing:.14em; text-transform:uppercase; color: var(--muted);
      font-family: var(--mono);
      font-weight: 900;
    }

    #confetti{
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:140;
    }

    [data-borders="off"]{ --line: rgba(0,0,0,0); }
    [data-buttons="filled"]{ --btnFill: 1; }

    @media (max-width: 560px){
      .btn{ font-size: 11px; padding: 8px 9px; }
      .btn.icon{ width: 38px; height: 34px; }
      .pill{ font-size: 11px; }
      .bomb{ min-width: 170px; }
      .miniIcon{ width: 52px; height: 52px; }
    }
  </style>
</head>

<body data-theme="light" data-borders="on" data-buttons="ghost">
  <canvas id="confetti"></canvas>

  <div class="drawerBack" id="drawerBack"></div>
  <div class="drawer" id="drawer">
    <div class="drawerTop">
      <div class="drawerTitle">MENU</div>
      <button class="btn" id="drawerClose">FERMER</button>
    </div>
    <div class="tabs" id="tabs"></div>
    <div class="drawerBody" id="drawerBody"></div>
  </div>

  <div class="rightBack" id="rightBack"></div>
  <div class="rightPanel" id="rightPanel">
    <div class="rightTop">
      <div class="rightTitle" id="rightTitle">PANNEAU DROIT</div>
      <button class="btn" id="rightClose">FERMER</button>
    </div>
    <div class="rightTabs" id="rightTabs"></div>
    <div class="rightBody" id="rightBody"></div>
  </div>

  <div class="modalBack" id="modalBack"></div>

  <div class="modal" id="notesModal">
    <div class="modalCard" onclick="event.stopPropagation()">
      <div class="modalHead">
        <div class="mh">NOTES</div>
        <div class="small">Clique hors de la carte pour fermer</div>
      </div>
      <div class="section">
        <h3>Ajouter une note</h3>
        <textarea id="noteInput" placeholder="Écris ici. Une rune dans le grimoire."></textarea>
        <div class="row" style="margin-top:8px">
          <button class="btn primary" id="noteAdd">AJOUTER</button>
          <button class="btn" id="noteClear">VIDER</button>
        </div>
      </div>
      <div style="height:10px"></div>
      <div class="section">
        <h3>Historique</h3>
        <div id="notesList" class="small"></div>
      </div>
    </div>
  </div>

  <div class="modal" id="pomodoroModal">
    <div class="modalCard" onclick="event.stopPropagation()">
      <div class="modalHead">
        <div class="mh">POMODORO</div>
        <div class="small">Clique hors de la carte pour fermer</div>
      </div>
      <div class="section">
        <h3>Durée</h3>
        <div class="row">
          <input id="pomoMin" type="number" min="5" max="90" step="1" />
          <button class="btn primary" id="pomoStart">DÉMARRER</button>
          <button class="btn" id="pomoStop">STOP</button>
        </div>
        <div style="height:10px"></div>
        <div class="small" id="pomoInfo">—</div>
      </div>
    </div>
  </div>

  <div class="modal" id="exportModal">
    <div class="modalCard" onclick="event.stopPropagation()">
      <div class="modalHead">
        <div class="mh">EXPORT</div>
        <div class="small">Clique hors de la carte pour fermer</div>
      </div>
      <div class="section">
        <h3>Texte / JSON / CSV</h3>
        <div class="row" style="margin-bottom:8px">
          <button class="btn primary" id="expText">TEXTE</button>
          <button class="btn" id="expJSON">JSON</button>
          <button class="btn" id="expCSV">CSV</button>
          <button class="btn" id="expCopy">COPIER</button>
        </div>
        <textarea id="expOut" style="min-height:260px"></textarea>
      </div>
    </div>
  </div>

  <div class="wrap" id="app">
    <div class="topbar">
      <div class="left">
        <button class="btn icon keepFocus" id="btnMenu" title="Menu gauche">≡</button>

        <!-- Thème : light → dark → pastel -->
        <button class="btn keepFocus" id="btnTheme" title="Thème"><span id="themeLabel">MODE CLAIR</span></button>

        <button class="btn keepFocus" id="btnCounters" title="Afficher/masquer compteurs">COMPTEURS</button>
        <span class="pill hidden" id="pillTasks">0/0</span>
        <span class="pill hidden" id="pillEto">0/0</span>
        <span class="pill hidden" id="pillDone">0</span>

        <!-- Timer + Pomodoro visibles sur la topbar -->
        <span class="pill hot" id="pillTimer">00:00</span>
        <span class="pill" id="pillPomo">POMO —</span>
        <button class="btn keepFocus" id="btnPomo" title="Pomodoro">POMO</button>

        <button class="btn keepFocus" id="btnListToggle" title="Afficher/masquer la liste sur l'écran">LISTE</button>
        <button class="btn keepFocus" id="btnFocus" title="Mode focus">FOCUS</button>
      </div>
      <div class="right">
        <button class="btn icon keepFocus" id="btnRight" title="Panneau droit">▦</button>
      </div>
    </div>

    <div class="hero">
      <div class="title" id="appTitle">ELIMINATOR</div>
      <div class="tag" id="tagline"></div>
    </div>

    <div class="main">
      <div class="barWrap">
        <div class="barRow">
          <div class="barLabel">progression (tu réduis le chaos)</div>
          <div class="barLabel" id="barInfo">—</div>
        </div>
        <div class="bar" title="La barre commence à 100% et diminue">
          <div class="barFill" id="taskBarFill" style="width:100%"></div>
          <div class="barPct" id="taskBarPct">100%</div>
        </div>

        <!-- Mini résumé émotions -->
        <div class="emoDock" id="emoDock"></div>
      </div>

      <div class="current">
        <div class="taskName" id="taskName">Aucune tâche</div>
        <div class="chips" id="chips"></div>

        <div class="actions">
          <div class="roulette" id="btnRoulette" title="Roulette">
            <div class="rouletteRing" aria-hidden="true"></div>
            <div class="rouletteNeedle" aria-hidden="true"></div>
            <div class="rouletteText">ROULETTE</div>
          </div>

          <div class="bomb" id="btnEtorion" title="Dégommer un étorion">
            <div class="em">⚔️</div>
            <div class="label">
              <span>DÉGOMMER</span>
              <small>1 ÉTORION</small>
            </div>
          </div>
        </div>

        <div class="miniRow">
          <div class="miniIcon" id="btnUndo" title="Annuler">↶</div>
          <div class="miniIcon miniLabel" id="btnNotes" title="Notes">NOTES</div>
          <div class="miniIcon" id="btnDoneTask" title="Tâche terminée">✓</div>
          <div class="miniIcon" id="btnPause" title="Pause timer">⏸</div>
        </div>

        <!-- Sets visibles directement + alignés -->
        <div class="setsDock" id="setsDock"></div>

        <div class="small" id="hintLine" style="text-align:center">
          Aujourd’hui tu es un paladin du rangement mental. Un paladin un peu fatigué, mais paladin quand même.
        </div>
      </div>

      <div class="section" id="belowList" style="width:100%; display:none">
        <div class="row" style="margin-bottom:8px">
          <div class="small" style="flex:2">LISTE EN COURS</div>
          <button class="btn" id="btnHideBelow">MASQUER</button>
        </div>
        <div id="belowTasks"></div>
      </div>

    </div>
  </div>

  <script>
"use strict";

/* ================= Utils ================= */
const $ = (id)=>document.getElementById(id);
const clamp = (n,a,b)=>Math.max(a, Math.min(b,n));
const uid = ()=>Math.random().toString(36).slice(2,10)+"_"+Date.now().toString(36);
const nowISO = ()=>new Date().toISOString();
function dayKey(d=new Date()){
  const y=d.getFullYear();
  const m=String(d.getMonth()+1).padStart(2,"0");
  const da=String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${da}`;
}
function fmtMMSS(ms){
  const s=Math.max(0, Math.floor(ms/1000));
  const mm=String(Math.floor(s/60)).padStart(2,"0");
  const ss=String(s%60).padStart(2,"0");
  return `${mm}:${ss}`;
}
function escapeHTML(s){
  return (s||"").replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[c]));
}
function clearEl(el){ while(el.firstChild) el.removeChild(el.firstChild); }
function structuredCloneSafe(o){
  if(typeof structuredClone==="function") return structuredClone(o);
  return JSON.parse(JSON.stringify(o));
}

/* ================= Storage ================= */
const LS_KEY = "eliminator_ghibli_plus_v1";

/* ================= Default state ================= */
const defaultState = {
  theme:"light",                 // light | dark | pastel
  focus:false,
  showBelowList:false,
  showCounters:false,
  countersAutoHideSec:10,

  appearance:{
    borders:"on",
    buttons:"ghost",
    uiScale:1.0,
    titleScale:1.12,
    taskScale:1.42,
    // Adaptables :
    barH: 86,                    // px (sera clamp côté CSS via var)
    barBlockMinH: 170,           // px
    barText: 24                  // px
  },

  settings:{
    // Flow utile :
    tipsChance:0.14,
    tipsMinGapMin:6,
    nudgeChance:0.10,
    nudgeMinGapMin:10,
    keepListInFocus:true
  },

  timer:{
    startedAt:null,
    pausedAt:null,
    pausedTotal:0
  },

  pomodoro:{
    minutes:25,
    running:false,
    endsAt:null
  },

  tasks:[],
  baseline:{ totalTasks:0, totalEtorions:0 },
  currentTaskId:null,

  notes:[],
  emotions:{ entries:[] },

  sets:{ list:[], selectedIds:[] },  // on affiche 2 sets dockés
  history:[],
  stats:{ etorionsDone:0, tasksDone:0 },
  streak:{ tasksInARow:0, lastTaskDoneAt:null },

  undo:[]
};

/* ================= Seed / merge ================= */
function deepAssign(target, src){
  for(const k in src){
    if(src[k] && typeof src[k]==="object" && !Array.isArray(src[k]) && target[k]){
      deepAssign(target[k], src[k]);
    }else target[k]=src[k];
  }
}

function seedState(s){
  // Sets : 2 sets par défaut, renommés SET 1 / SET 2, alignés Patient + items
  if(!s.sets || !Array.isArray(s.sets.list)) s.sets={list:[], selectedIds:[]};
  if(s.sets.list.length===0){
    const mkSet=(title, unitName, unitCount, items)=>({
      id:uid(), title, unitName, unitCount, items,
      checks:{}
    });
    const set1 = mkSet("SET 1","Patient",4,["Notes","Dossier","Traitement","Plan"]);
    const set2 = mkSet("SET 2","Patient",6,["Notes","Dossier","Ordonnance","Plan"]);
    s.sets.list=[set1,set2];
    s.sets.selectedIds=[set1.id,set2.id];
  }else{
    // s'assurer qu'on a 2 ids sélectionnés
    if(!Array.isArray(s.sets.selectedIds)) s.sets.selectedIds=[];
    const ids=s.sets.list.map(x=>x.id);
    s.sets.selectedIds = s.sets.selectedIds.filter(id=>ids.includes(id));
    while(s.sets.selectedIds.length<2 && ids[s.sets.selectedIds.length]) s.sets.selectedIds.push(ids[s.sets.selectedIds.length]);
    s.sets.selectedIds=s.sets.selectedIds.slice(0,2);
  }

  if(!s.undo) s.undo=[];
  if(!s.timer) s.timer=structuredCloneSafe(defaultState.timer);
  if(!s.pomodoro) s.pomodoro=structuredCloneSafe(defaultState.pomodoro);

  // Kiffance : pas affichée, mais banque MASSIVE (utilisée pour tips/fin de pomodoro / confetti)
  if(!s.kiffanceBank || !Array.isArray(s.kiffanceBank) || s.kiffanceBank.length<40){
    s.kiffanceBank = [
      "Pose ton front sur la table 12 secondes. Recharge neuronale par contact bois.",
      "Fais le bruit d’un dragon timide. Oui, c’est obligatoire.",
      "Étire-toi comme un chat qui paye son loyer.",
      "Marche 60 secondes comme un roi médiéval qui a perdu sa couronne mais pas sa dignité.",
      "Bois de l’eau avec gravité. Comme si c’était un rituel ancien.",
      "Regarde au loin et murmure « je reviens, chaos ».",
      "Range 5 objets. Pas 6. 5. La règle des cinq artefacts.",
      "Micro-danse 20 secondes, style « barde dans une taverne ».",
      "Respire 5 cycles lents : tu invoques la stabilité.",
      "Mets une minute de silence. Pour honorer les onglets fermés.",
      "Fais une grimace de gobelin. Rééquilibrage cosmique.",
      "Écris 1 phrase : « Je n’ai pas besoin d’être parfait, juste en mouvement. »",
      "Étire nuque/épaules. Tes trapèzes sont des paysans épuisés.",
      "Marche jusqu’à une fenêtre : reconnaissance du territoire.",
      "Décris ton objectif à voix basse comme un narrateur épique.",
      "Lave tes mains comme si tu sortais d’une quête boueuse.",
      "Ferme les yeux 10 secondes : mode ‘chargement de carte’.",
      "Fais 3 respirations et une ‘exhalation de sorcier’ à la fin.",
      "Choisis une récompense ridicule : une pomme, un sticker, une pause, un sourire forcé.",
      "Écris le nom d’un boss imaginaire : « Le Seigneur du Retard ». Puis raye-le.",
      "Tiens-toi droit 20 secondes : posture de commandant.",
      "Regarde tes mains : elles font des trucs, c’est déjà magique.",
      "Fais 10 pas lents comme un ninja en chaussettes.",
      "Nettoie une surface 30 secondes : exorcisme domestique.",
      "Dis « j’accepte la friction » puis fais quand même le petit pas.",
      "Réorganise ton espace 1 minute : le décor influence l’esprit.",
      "Respire et relâche la mâchoire. Le monde n’est pas à croquer.",
      "Lance une pièce imaginaire : pile = avance, face = avance aussi.",
      "Fais un mini ‘check armure’ : eau ? pipi ? respiration ? ok.",
      "Écris 3 mots : « simple, net, maintenant ».",
      "Souris 2 secondes : hack neurologique sans demander l’avis du cerveau.",
      "Un étirement de poignet : salutations aux tendons.",
      "Dépose ton téléphone plus loin : exil diplomatique.",
      "Fais une pause yeux : regarde à 6 mètres pendant 20 secondes.",
      "Prends une inspiration ‘qui sent le pain’. Expire ‘qui chasse les corbeaux’.",
      "Choisis un objet et remets-le parfaitement aligné. Petite victoire fasciste (mais utile).",
      "Dessine un carré. Puis un autre. Voilà, structure.",
      "Tape dans tes mains une fois. Fin de la cérémonie.",
      "Répète : « je fais le prochain geste, pas le plan entier ».",
      "Tu gagnes le titre de “Chevalier du Prochain Pas”."
    ];
  }

  return s;
}

function loadState(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return seedState(structuredCloneSafe(defaultState));
    const parsed = JSON.parse(raw);
    const merged = structuredCloneSafe(defaultState);
    deepAssign(merged, parsed);
    return seedState(merged);
  }catch(e){
    return seedState(structuredCloneSafe(defaultState));
  }
}
let state = loadState();
function saveState(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }

/* ================= Theme / appearance ================= */
function applyAppearance(){
  document.body.setAttribute("data-theme", state.theme);
  document.body.setAttribute("data-borders", state.appearance.borders || "on");
  document.body.setAttribute("data-buttons", state.appearance.buttons || "ghost");

  // Variables adaptables
  const barH = clamp(Number(state.appearance.barH)||86, 56, 160);
  const barBlockMinH = clamp(Number(state.appearance.barBlockMinH)||170, 120, 320);
  const barText = clamp(Number(state.appearance.barText)||24, 16, 40);

  document.documentElement.style.setProperty("--barH", `clamp(64px, 10vh, ${barH}px)`);
  document.documentElement.style.setProperty("--barBlockMinH", `clamp(120px, 24vh, ${barBlockMinH}px)`);
  document.documentElement.style.setProperty("--barText", `${barText}px`);

  $("themeLabel").textContent =
    state.theme==="light" ? "MODE CLAIR" :
    state.theme==="dark" ? "MODE SOMBRE" : "MODE PASTEL";
}

/* ================= Taglines (médiéval absurde) ================= */
const TAGLINE_POOL = [
  "Tu avances, le chaos recule. C’est la loi du royaume.",
  "Aujourd’hui : une quête principale. Le reste : des gobelins décoratifs.",
  "Ton agenda tremble. Tes étorions aussi.",
  "On ne négocie pas avec la procrastination. On la contourne.",
  "Par la barbe du mage, tu vas finir ce truc.",
  "Le boss final c’est… le bouton ‘envoyer’. À l’assaut.",
  "Si tu hésites : frappe un étorion. Très chevaleresque."
];
function setRandomTagline(force=false){
  const el=$("tagline");
  if(force || !el.textContent.trim() || Math.random()<0.25){
    el.textContent = TAGLINE_POOL[Math.floor(Math.random()*TAGLINE_POOL.length)];
  }
}

/* ================= Tasks parsing ================= */
function isAllCapsLine(line){
  const t=line.trim(); if(!t) return false;
  const hasLetters=/[A-Za-zÀ-ÖØ-öø-ÿ]/.test(t);
  if(!hasLetters) return false;
  return t===t.toUpperCase() && t.length<=90;
}
function parseTaskLine(line){
  const raw=line.trim(); if(!raw) return null;
  const cleaned=raw.replace(/^[-*•\s]+/,"").trim();
  if(!cleaned) return null;

  let et=null, title=cleaned;
  const m=cleaned.match(/^(.*?)(?:\s*[-–—]\s*|\s+)(\d+)\s*$/);
  if(m){ title=m[1].trim(); et=parseInt(m[2],10); }
  title=title.replace(/\s+/g," ").trim();
  if(!title) return null;
  if(et!==null) et=clamp(et,1,99);
  return {title, etorions: et};
}
function importFromInbox(text){
  const lines=text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  let cat="INBOX";
  const out=[];
  for(const line of lines){
    if(isAllCapsLine(line)){ cat=line.trim().toUpperCase(); continue; }
    const p=parseTaskLine(line); if(!p) continue;
    out.push({
      id: uid(),
      title: p.title,
      cat,
      etorionsTotal: p.etorions ?? 1,
      etorionsLeft: p.etorions ?? 1,
      pinned:false,
      done:false,
      createdAt: nowISO(),
      doneAt:null
    });
  }
  return out;
}

/* ================= Tasks core ================= */
function activeTasks(){ return state.tasks.filter(t=>!t.done); }
function getTaskById(id){ return state.tasks.find(t=>t.id===id) || null; }
function setCurrentTask(id){ state.currentTaskId=id; }
function sortTasks(list){
  return [...list].sort((a,b)=>{
    if(a.pinned && !b.pinned) return -1;
    if(!a.pinned && b.pinned) return 1;
    return (a.createdAt||"").localeCompare(b.createdAt||"");
  });
}
function roulettePick(){
  const list=sortTasks(activeTasks());
  if(list.length===0) return null;
  const pinned=list.filter(t=>t.pinned);
  const pool=pinned.length?pinned:list;
  return pool[Math.floor(Math.random()*pool.length)];
}
function ensureCurrentTask(){
  const list=activeTasks();
  if(list.length===0){ state.currentTaskId=null; return; }
  const cur=getTaskById(state.currentTaskId);
  if(!cur || cur.done){
    const pinned=list.find(t=>t.pinned);
    state.currentTaskId=(pinned||list[0]).id;
  }
}

/* ================= Baseline + progress ================= */
function recomputeBaselineIfNeeded(){
  if(state.baseline.totalTasks===0 && state.baseline.totalEtorions===0 && state.tasks.length>0){
    const all=activeTasks();
    state.baseline.totalTasks=all.length;
    state.baseline.totalEtorions=all.reduce((a,t)=>a+(t.etorionsTotal||0),0);
  }
}
function computeProgress(){
  const baseT=state.baseline.totalTasks||0;
  const baseE=state.baseline.totalEtorions||0;
  const rem=activeTasks();
  const remT=rem.length;
  const remE=rem.reduce((a,t)=>a+(t.etorionsLeft||0),0);
  const pct=(baseT<=0)?100:clamp(Math.round((remT/baseT)*100),0,100);
  return {baseT,baseE,remT,remE,pct};
}

/* ================= Undo ================= */
function pushUndo(label){
  state.undo.unshift({
    label, at:Date.now(),
    snapshot: structuredCloneSafe({
      tasks: state.tasks,
      baseline: state.baseline,
      currentTaskId: state.currentTaskId,
      stats: state.stats,
      timer: state.timer,
      pomodoro: state.pomodoro,
      emotions: state.emotions,
      sets: state.sets
    })
  });
  state.undo = state.undo.slice(0,12);
}
function undo(){
  const snap=state.undo.shift();
  if(!snap) return;
  const s=snap.snapshot;
  state.tasks=s.tasks;
  state.baseline=s.baseline;
  state.currentTaskId=s.currentTaskId;
  state.stats=s.stats;
  state.timer=s.timer;
  state.pomodoro=s.pomodoro;
  state.emotions=s.emotions;
  state.sets=s.sets;
  saveState();
  renderAll();
}

/* ================= Confetti (simple) ================= */
const conf=$("confetti");
const ctx=conf.getContext("2d");
let confettiPieces=[];
function resizeCanvas(){
  conf.width=window.innerWidth*devicePixelRatio;
  conf.height=window.innerHeight*devicePixelRatio;
  conf.style.width=window.innerWidth+"px";
  conf.style.height=window.innerHeight+"px";
  ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
}
window.addEventListener("resize", resizeCanvas);
resizeCanvas();
let confettiRAF=null;
function confettiBurst(strength=1){
  const w=window.innerWidth, h=window.innerHeight;
  const n=Math.floor(120*strength);
  const cx=w/2, cy=h/3;
  for(let i=0;i<n;i++){
    confettiPieces.push({
      x:cx,y:cy,
      vx:(Math.random()-0.5)*10*strength,
      vy:(Math.random()-0.85)*14*strength,
      g:0.35+Math.random()*0.2,
      r:2+Math.random()*3*strength,
      life:70+Math.random()*50,
      rot:Math.random()*Math.PI,
      vr:(Math.random()-0.5)*0.35
    });
  }
  if(!confettiRAF) confettiRAF=requestAnimationFrame(confettiStep);
}
function confettiStep(){
  ctx.clearRect(0,0,window.innerWidth,window.innerHeight);
  confettiPieces=confettiPieces.filter(p=>p.life>0);
  for(const p of confettiPieces){
    p.vy+=p.g; p.x+=p.vx; p.y+=p.vy; p.rot+=p.vr; p.life-=1;
    ctx.save();
    ctx.translate(p.x,p.y);
    ctx.rotate(p.rot);
    ctx.globalAlpha=0.84;
    ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue("--fg");
    ctx.fillRect(-p.r,-p.r,p.r*2,p.r*2);
    ctx.restore();
  }
  if(confettiPieces.length>0) confettiRAF=requestAnimationFrame(confettiStep);
  else { cancelAnimationFrame(confettiRAF); confettiRAF=null; ctx.clearRect(0,0,window.innerWidth,window.innerHeight); }
}

/* ================= Modals ================= */
function openModal(id){
  $("modalBack").style.display="block";
  $(id).style.display="flex";
}
function closeAllModals(){
  ["notesModal","pomodoroModal","exportModal"].forEach(id=>{ const el=$(id); if(el) el.style.display="none"; });
  $("modalBack").style.display="none";
}
$("modalBack").addEventListener("click", closeAllModals);

/* ================= Notes ================= */
function addNote(text){
  const t=(text||"").trim(); if(!t) return;
  state.notes.unshift({id:uid(), text:t, at:nowISO()});
}
function renderNotes(){
  const list=state.notes||[];
  if(list.length===0){ $("notesList").innerHTML="<div class='small'>Aucune note.</div>"; return; }
  $("notesList").innerHTML = list.slice(0,80).map(n=>{
    const dt=new Date(n.at);
    const stamp=dt.toLocaleString("fr-BE",{hour:"2-digit",minute:"2-digit",day:"2-digit",month:"2-digit"});
    return `<div style="padding:8px 6px; border-bottom:1px solid var(--line)">
      <div style="font-family:var(--mono); color:var(--muted); font-size:11px">${stamp}</div>
      <div style="white-space:pre-wrap; font-size:13px">${escapeHTML(n.text)}</div>
    </div>`;
  }).join("");
}

/* ================= Timer / Pomodoro ================= */
function timerNowMs(){
  if(!state.timer.startedAt) return 0;
  const now=Date.now();
  const paused=state.timer.pausedTotal||0;
  const extra=state.timer.pausedAt ? (now - state.timer.pausedAt) : 0;
  return Math.max(0, now - state.timer.startedAt - paused - extra);
}
function togglePause(){
  if(!state.timer.startedAt) state.timer.startedAt=Date.now();
  if(state.timer.pausedAt){
    state.timer.pausedTotal=(state.timer.pausedTotal||0) + (Date.now()-state.timer.pausedAt);
    state.timer.pausedAt=null;
  }else{
    state.timer.pausedAt=Date.now();
  }
  saveState(); renderAll();
}
function pomoRemainingMs(){
  if(!state.pomodoro.running || !state.pomodoro.endsAt) return null;
  return Math.max(0, state.pomodoro.endsAt - Date.now());
}
function startPomodoro(min){
  const m=clamp(Number(min)||25, 5, 90);
  state.pomodoro.minutes=m;
  state.pomodoro.running=true;
  state.pomodoro.endsAt=Date.now() + m*60*1000;
  saveState(); renderAll();
}
function stopPomodoro(){
  state.pomodoro.running=false;
  state.pomodoro.endsAt=null;
  saveState(); renderAll();
}

/* ================= Kiffance (non affichée) ================= */
function randomKiffance(){
  const bank=state.kiffanceBank||[];
  if(!bank.length) return "Pause courte : eau + respiration.";
  return bank[Math.floor(Math.random()*bank.length)];
}

/* ================= Completing ================= */
function completeTask(taskId){
  const t=getTaskById(taskId);
  if(!t || t.done) return;

  pushUndo("taskComplete");
  t.done=true; t.doneAt=nowISO();
  state.stats.tasksDone=(state.stats.tasksDone||0)+1;
  confettiBurst(1.10);

  ensureCurrentTask();
  saveState();
  renderAll();
}
function degommeEtorion(){
  const t=getTaskById(state.currentTaskId);
  if(!t || t.done) return;

  pushUndo("etorion");
  const total=t.etorionsTotal||1;
  if(typeof t.etorionsLeft!=="number") t.etorionsLeft=total;
  t.etorionsLeft = clamp(t.etorionsLeft-1, 0, 99);
  state.stats.etorionsDone=(state.stats.etorionsDone||0)+1;

  if(t.etorionsLeft<=0){ completeTask(t.id); return; }
  saveState(); renderAll();
}

/* ================= Emotions : plus visuel ================= */
const EMOTIONS = [
  {name:"Joie", c:"#2fbf71"},
  {name:"Soulagement", c:"#7bdff2"},
  {name:"Fatigue", c:"#cdb4db"},
  {name:"Stress", c:"#ffd166"},
  {name:"Anxiété", c:"#ef476f"},
  {name:"Colère", c:"#ff6b6b"},
  {name:"Tristesse", c:"#4d96ff"},
  {name:"Honte", c:"#9b5de5"},
  {name:"Culpabilité", c:"#f15bb5"},
  {name:"Frustration", c:"#f77f00"}
];
function addEmotionQuick(name, intensity){
  pushUndo("emoAdd");
  state.emotions.entries.unshift({
    id:uid(),
    day:dayKey(),
    at:nowISO(),
    emotion:name,
    intensity: clamp(Number(intensity)||5,0,10)
  });
  saveState();
  renderAll();
}
function emotionsToday(){
  const dk=dayKey();
  return (state.emotions.entries||[]).filter(e=>e.day===dk);
}
function avgIntensity(list){
  if(!list?.length) return 0;
  return Math.round(list.reduce((a,b)=>a+(Number(b.intensity)||0),0)/list.length);
}
function topEmotion(list){
  if(!list?.length) return null;
  const m=new Map();
  list.forEach(e=>m.set(e.emotion,(m.get(e.emotion)||0)+1));
  let best=null,v=-1; for(const [k,n] of m){ if(n>v){v=n;best=k;} }
  return best;
}
function colorForEmotion(name){
  const f=EMOTIONS.find(e=>e.name===name);
  return f?.c || "#f4a261";
}

/* ================= Sets ================= */
function getSetById(id){ return state.sets.list.find(s=>s.id===id) || null; }
function initSetChecksForToday(set){
  const dk=dayKey();
  if(!set.checks) set.checks={};
  if(!set.checks[dk]) set.checks[dk]={};
}
function setCheckKey(u,i){ return `u${u}_i${i}`; }
function toggleSetCheck(setId,u,i){
  const set=getSetById(setId); if(!set) return;
  initSetChecksForToday(set);
  const dk=dayKey();
  const k=setCheckKey(u,i);
  set.checks[dk][k]=!set.checks[dk][k];
}
function summarizeSetToday(setId){
  const set=getSetById(setId); if(!set) return {done:0,total:0};
  initSetChecksForToday(set);
  const dk=dayKey();
  const checks=set.checks[dk]||{};
  const total=(set.unitCount||0)*(set.items?.length||0);
  const done=Object.values(checks).filter(Boolean).length;
  return {done,total};
}

/* ================= Drawer / Right panels ================= */
const TAB_DEFS = [
  {key:"inbox", label:"INBOX"},
  {key:"liste", label:"LISTE"},
  {key:"flow", label:"FLOW"},
  {key:"export", label:"EXPORT"}
];

function mkSection(title){
  const s=document.createElement("div");
  s.className="section";
  const h=document.createElement("h3");
  h.textContent=title;
  s.appendChild(h);
  return s;
}
function mkBtn(txt, cls="btn"){ const b=document.createElement("button"); b.className=cls; b.textContent=txt; return b; }

function buildTabs(){
  const el=$("tabs"); clearEl(el);
  TAB_DEFS.forEach(t=>{
    const b=document.createElement("div");
    b.className="tab"+(state.activeTab===t.key?" active":"");
    b.textContent=t.label;
    b.onclick=()=>{ state.activeTab=t.key; saveState(); renderDrawer(); };
    el.appendChild(b);
  });
}

function viewInbox(){
  const wrap=document.createElement("div");
  const s1=mkSection("Importer des tâches");
  const ta=document.createElement("textarea");
  ta.placeholder="COLLE ICI.\n\nADMIN\n- Mail X 2\n- Appeler Y 1\n\nPROJET\n- Rapport Z 6\n\nLigne MAJUSCULES = catégorie.\nChiffre final = étorions.";
  s1.appendChild(ta);

  const row=document.createElement("div");
  row.className="row";
  row.style.marginTop="8px";

  const btnImport=mkBtn("IMPORTER (RESET BASELINE)","btn primary");
  btnImport.onclick=()=>{
    const items=importFromInbox(ta.value||"");
    if(items.length===0) return;
    pushUndo("import");
    state.tasks.push(...items);
    state.baseline.totalTasks=activeTasks().length;
    state.baseline.totalEtorions=activeTasks().reduce((a,t)=>a+(t.etorionsTotal||0),0);
    ensureCurrentTask();
    saveState();
    renderAll();
    ta.value="";
    closeDrawer();
  };

  const btnDemo=mkBtn("EXEMPLE","btn");
  btnDemo.onclick=()=>{
    ta.value=
`QUÊTE PRINCIPALE
- Écrire note 3
- Envoyer mail 2

GOBELINS
- Ranger bureau 2
- Dossier patient 6`;
  };

  row.appendChild(btnImport);
  row.appendChild(btnDemo);
  s1.appendChild(row);

  wrap.appendChild(s1);
  return wrap;
}

function viewListe(){
  const wrap=document.createElement("div");
  const s=mkSection("Actives");
  const list=document.createElement("div");
  const act=sortTasks(activeTasks());
  list.innerHTML = act.length ? act.map(t=>`
    <div style="display:flex; gap:10px; align-items:center; padding:10px 6px; border-bottom:1px solid var(--line)">
      <div style="flex:1; min-width:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis">${escapeHTML(t.title)} <span class="small">${t.cat?`[${escapeHTML(t.cat)}]`:""}</span></div>
      <div class="small">${t.etorionsLeft??t.etorionsTotal}/${t.etorionsTotal}</div>
      <button class="btn" data-go="${t.id}">CIBLER</button>
      <button class="btn primary" data-done="${t.id}">FINIR</button>
    </div>`).join("")
    : `<div class="small">Aucune tâche.</div>`;
  s.appendChild(list);

  list.querySelectorAll("button[data-go]").forEach(b=>{
    b.onclick=()=>{ pushUndo("go"); setCurrentTask(b.getAttribute("data-go")); saveState(); renderAll(); };
  });
  list.querySelectorAll("button[data-done]").forEach(b=>{
    b.onclick=()=>{ completeTask(b.getAttribute("data-done")); };
  });

  wrap.appendChild(s);
  return wrap;
}

function viewFlow(){
  const wrap=document.createElement("div");

  const s=mkSection("Interface");
  const row=document.createElement("div"); row.className="row";

  const barH=document.createElement("input");
  barH.type="number"; barH.min="56"; barH.max="160"; barH.step="1";
  barH.value=String(state.appearance.barH||86);

  const barText=document.createElement("input");
  barText.type="number"; barText.min="16"; barText.max="40"; barText.step="1";
  barText.value=String(state.appearance.barText||24);

  const barBlock=document.createElement("input");
  barBlock.type="number"; barBlock.min="120"; barBlock.max="320"; barBlock.step="1";
  barBlock.value=String(state.appearance.barBlockMinH||170);

  row.appendChild(barH);
  row.appendChild(barText);
  row.appendChild(barBlock);

  const apply=mkBtn("APPLIQUER","btn primary");
  apply.onclick=()=>{
    state.appearance.barH=Number(barH.value)||86;
    state.appearance.barText=Number(barText.value)||24;
    state.appearance.barBlockMinH=Number(barBlock.value)||170;
    saveState(); renderAll();
  };

  s.appendChild(row);
  s.appendChild(document.createElement("div")).style.height="8px";
  s.appendChild(apply);

  const s2=mkSection("Pomodoro");
  const r2=document.createElement("div"); r2.className="row";
  const pm=document.createElement("input"); pm.type="number"; pm.min="5"; pm.max="90"; pm.step="1";
  pm.value=String(state.pomodoro.minutes||25);
  const b2=mkBtn("SAUVER","btn primary");
  b2.onclick=()=>{ state.pomodoro.minutes=clamp(Number(pm.value)||25,5,90); saveState(); renderAll(); };
  r2.appendChild(pm); r2.appendChild(b2);
  s2.appendChild(r2);

  const s3=mkSection("Probabilités (tips / nudges)");
  const r3=document.createElement("div"); r3.className="row";
  const tips=document.createElement("input"); tips.type="number"; tips.min="0"; tips.max="1"; tips.step="0.01"; tips.value=String(state.settings.tipsChance||0.14);
  const nudge=document.createElement("input"); nudge.type="number"; nudge.min="0"; nudge.max="1"; nudge.step="0.01"; nudge.value=String(state.settings.nudgeChance||0.10);
  const b3=mkBtn("SAUVER","btn primary");
  b3.onclick=()=>{
    state.settings.tipsChance=clamp(Number(tips.value)||0,0,1);
    state.settings.nudgeChance=clamp(Number(nudge.value)||0,0,1);
    saveState(); renderAll();
  };
  r3.appendChild(tips); r3.appendChild(nudge); r3.appendChild(b3);
  s3.appendChild(r3);

  wrap.appendChild(s);
  wrap.appendChild(document.createElement("div")).style.height="10px";
  wrap.appendChild(s2);
  wrap.appendChild(document.createElement("div")).style.height="10px";
  wrap.appendChild(s3);
  return wrap;
}

function viewExport(){
  const wrap=document.createElement("div");
  const s=mkSection("Export");
  const b=mkBtn("OUVRIR EXPORT","btn primary");
  b.onclick=()=>{ openModal("exportModal"); renderExport("text"); };
  s.appendChild(b);
  wrap.appendChild(s);
  return wrap;
}

function renderDrawer(){
  buildTabs();
  const body=$("drawerBody"); clearEl(body);
  if(state.activeTab==="inbox") body.appendChild(viewInbox());
  if(state.activeTab==="liste") body.appendChild(viewListe());
  if(state.activeTab==="flow") body.appendChild(viewFlow());
  if(state.activeTab==="export") body.appendChild(viewExport());
}

const RIGHT_TABS=[
  {key:"emotions", label:"ÉMOTIONS"},
  {key:"sets", label:"SETS"}
];

function buildRightTabs(){
  const el=$("rightTabs"); clearEl(el);
  RIGHT_TABS.forEach(t=>{
    const b=document.createElement("div");
    b.className="tab"+(state.rightTab===t.key?" active":"");
    b.textContent=t.label;
    b.onclick=()=>{ state.rightTab=t.key; saveState(); renderRight(); };
    el.appendChild(b);
  });
}

function viewRightEmotions(){
  const wrap=document.createElement("div");
  const s=mkSection("Ajout rapide (1 clic)");
  const grid=document.createElement("div");
  grid.style.display="grid";
  grid.style.gridTemplateColumns="repeat(2,minmax(0,1fr))";
  grid.style.gap="8px";

  EMOTIONS.forEach(e=>{
    const b=mkBtn(`${e.name}`, "btn");
    b.style.textTransform="none";
    b.style.letterSpacing="0";
    b.style.fontFamily="var(--mono)";
    b.style.borderColor="var(--line)";
    b.style.background=`radial-gradient(520px 160px at 20% 40%, ${e.c}33, transparent 62%)`;
    b.onclick=()=> addEmotionQuick(e.name, 5);
    grid.appendChild(b);
  });

  s.appendChild(grid);

  const s2=mkSection("Résumé du jour");
  const list=emotionsToday();
  const avg=avgIntensity(list);
  const top=topEmotion(list);
  const info=document.createElement("div");
  info.className="small";
  info.innerHTML = list.length
    ? `Entrées: <b>${list.length}</b> · Intensité moyenne: <b>${avg}/10</b> · Dominante: <b>${escapeHTML(top||"—")}</b>`
    : "Aucune entrée aujourd’hui.";
  s2.appendChild(info);

  const s3=mkSection("Historique (aujourd’hui)");
  const box=document.createElement("div");
  box.innerHTML = list.length ? list.slice(0,30).map(x=>{
    const c=colorForEmotion(x.emotion);
    return `<div style="display:flex; gap:10px; align-items:center; padding:8px 6px; border-bottom:1px solid var(--line)">
      <div style="width:10px;height:10px;border-radius:999px;background:${c}; border:1px solid var(--line)"></div>
      <div style="flex:1; font-family:var(--mono); font-size:12px">${escapeHTML(x.emotion)}</div>
      <div class="small">${escapeHTML(String(x.intensity))}/10</div>
    </div>`;
  }).join("") : `<div class="small">—</div>`;
  s3.appendChild(box);

  wrap.appendChild(s);
  wrap.appendChild(document.createElement("div")).style.height="10px";
  wrap.appendChild(s2);
  wrap.appendChild(document.createElement("div")).style.height="10px";
  wrap.appendChild(s3);
  return wrap;
}

function viewRightSets(){
  const wrap=document.createElement("div");
  const s=mkSection("Info");
  const info=document.createElement("div");
  info.className="small";
  info.textContent="Les sets sont affichés sur l’écran principal (dock). Ici on garde une vue complémentaire.";
  s.appendChild(info);
  wrap.appendChild(s);
  return wrap;
}

function renderRight(){
  buildRightTabs();
  const body=$("rightBody"); clearEl(body);
  if(state.rightTab==="emotions") body.appendChild(viewRightEmotions());
  if(state.rightTab==="sets") body.appendChild(viewRightSets());
}

/* ================= Export ================= */
function tasksAsText(){
  const act=sortTasks(activeTasks());
  const lines=[];
  lines.push(`ELIMINATOR — ${dayKey()}`);
  act.forEach(t=>lines.push(`- ${t.title} — ${t.etorionsLeft??t.etorionsTotal}/${t.etorionsTotal} ${t.cat?`[${t.cat}]`:""}`));
  return lines.join("\n");
}
function tasksAsCSV(){
  const rows=[["title","cat","etorions_total","etorions_left","pinned","done","createdAt","doneAt"]];
  state.tasks.forEach(t=>{
    rows.push([t.title||"", t.cat||"", String(t.etorionsTotal||1), String(t.etorionsLeft??(t.etorionsTotal||1)), t.pinned?"1":"0", t.done?"1":"0", t.createdAt||"", t.doneAt||""]);
  });
  return rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(",")).join("\n");
}
function renderExport(mode){
  let out="";
  if(mode==="text") out=tasksAsText();
  if(mode==="json") out=JSON.stringify({meta:{exportedAt:nowISO(), key:LS_KEY}, state}, null, 2);
  if(mode==="csv") out=tasksAsCSV();
  $("expOut").value=out;
}

/* ================= Renders ================= */
function renderHUD(){
  recomputeBaselineIfNeeded();
  const p=computeProgress();
  $("pillTasks").textContent = `${p.remT}/${p.baseT}`;
  $("pillEto").textContent = `${p.remE}/${p.baseE}`;
  $("pillDone").textContent = `${(p.baseT - p.remT)}`;
}
function renderProgress(){
  const p=computeProgress();
  $("taskBarFill").style.width = `${p.pct}%`;
  $("taskBarPct").textContent = `${p.pct}%`;
  $("barInfo").textContent = `${p.remT} restantes sur ${p.baseT} · ${p.remE} étorions`;
}
function renderCurrent(){
  ensureCurrentTask();
  const t=getTaskById(state.currentTaskId);
  if(!t){
    $("taskName").textContent="Aucune tâche";
    $("chips").innerHTML="";
    $("btnEtorion").style.opacity=0.45;
    $("btnEtorion").style.pointerEvents="none";
    return;
  }
  $("btnEtorion").style.opacity=1;
  $("btnEtorion").style.pointerEvents="auto";
  $("taskName").textContent=t.title;

  const total=t.etorionsTotal||1;
  const left=(typeof t.etorionsLeft==="number") ? t.etorionsLeft : total;
  const chips=[];
  for(let i=0;i<total;i++) chips.push(`<div class="chip ${i<left?"on":""}"></div>`);
  $("chips").innerHTML=chips.join("");

  if(!state.timer.startedAt) state.timer.startedAt=Date.now();
}

function renderTimer(){
  $("pillTimer").textContent = fmtMMSS(timerNowMs());
  const rem=pomoRemainingMs();
  if(rem===null){
    $("pillPomo").textContent = `POMO ${state.pomodoro.minutes||25}m`;
  }else{
    $("pillPomo").textContent = `POMO ${fmtMMSS(rem)}`;
  }
}

function renderBelowList(){
  const box=$("belowTasks");
  const list=sortTasks(activeTasks());
  if(list.length===0){
    box.innerHTML=`<div class="small">Aucune tâche. Menu ≡ → INBOX pour importer.</div>`;
    return;
  }
  box.innerHTML = list.slice(0,60).map(t=>{
    const et=t.etorionsTotal||1;
    const left=t.etorionsLeft ?? et;
    const isCur=t.id===state.currentTaskId;
    return `
      <div style="display:flex; gap:10px; align-items:center; padding:10px 6px; border-bottom:1px solid var(--line); ${isCur?"background:rgba(0,0,0,.02)":" "}">
        <div style="flex:1; min-width:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis">${escapeHTML(t.title)}</div>
        <div class="small">${left}/${et}</div>
        <button class="btn" data-go="${t.id}">◎</button>
        <button class="btn primary" data-done="${t.id}">✓</button>
      </div>
    `;
  }).join("");

  box.querySelectorAll("button[data-go]").forEach(b=>{
    b.onclick=()=>{ pushUndo("go"); setCurrentTask(b.getAttribute("data-go")); saveState(); renderAll(); };
  });
  box.querySelectorAll("button[data-done]").forEach(b=>{
    b.onclick=()=>{ completeTask(b.getAttribute("data-done")); };
  });
}

function applyListVisible(){
  const show = !!state.showBelowList && (!state.focus || state.settings.keepListInFocus);
  $("belowList").style.display = show ? "block" : "none";
}

function renderEmoDock(){
  const dock=$("emoDock");
  clearEl(dock);
  const list=emotionsToday();
  const avg=avgIntensity(list);
  const top=topEmotion(list);

  const chip1=document.createElement("div");
  chip1.className="emoChip";
  chip1.innerHTML=`<span class="emoDot" style="background:${colorForEmotion(top||"")};"></span> DOMINANTE: ${escapeHTML(top||"—")}`;
  dock.appendChild(chip1);

  const chip2=document.createElement("div");
  chip2.className="emoChip";
  chip2.innerHTML=`<span class="emoDot" style="background:var(--barAccent2)"></span> INTENSITÉ: ${avg}/10`;
  dock.appendChild(chip2);

  const chip3=document.createElement("div");
  chip3.className="emoChip";
  chip3.innerHTML=`<span class="emoDot" style="background:var(--accent2)"></span> ENTRÉES: ${list.length}`;
  dock.appendChild(chip3);
}

/* Sets dock principal */
function renderSetsDock(){
  const dock=$("setsDock");
  clearEl(dock);

  const ids = state.sets.selectedIds || [];
  const sets = ids.map(getSetById).filter(Boolean).slice(0,2);

  sets.forEach(set=>{
    initSetChecksForToday(set);
    const sum=summarizeSetToday(set.id);

    const card=document.createElement("div");
    card.className="setCard";

    const head=document.createElement("div");
    head.className="setHead";
    const t=document.createElement("div");
    t.className="setTitle";
    t.textContent=set.title;
    const m=document.createElement("div");
    m.className="setMeta";
    m.textContent=`${sum.done}/${sum.total}`;
    head.appendChild(t); head.appendChild(m);
    card.appendChild(head);

    const grid=document.createElement("div");
    grid.className="setGrid";

    // On affiche 2 unités par ligne (Patient 1..n)
    for(let u=0; u<set.unitCount; u++){
      const unit=document.createElement("div");
      unit.className="setUnit";

      const ut=document.createElement("div");
      ut.className="setUnitTitle";
      ut.textContent = `${set.unitName} ${u+1}`;
      unit.appendChild(ut);

      const btns=document.createElement("div");
      btns.className="setBtns";

      set.items.forEach((it,i)=>{
        const k=setCheckKey(u,i);
        const dk=dayKey();
        const on=!!(set.checks?.[dk]?.[k]);
        const b=document.createElement("button");
        b.className="setBtn"+(on?" on":"");
        b.textContent=it;
        b.onclick=()=>{
          pushUndo("setCheck");
          toggleSetCheck(set.id,u,i);
          saveState();
          renderAll();
        };
        btns.appendChild(b);
      });

      unit.appendChild(btns);
      grid.appendChild(unit);
    }

    card.appendChild(grid);
    dock.appendChild(card);
  });
}

/* ================= Counters toggle ================= */
function setCountersVisible(on, autoHide=true){
  state.showCounters=!!on;
  const pills=["pillTasks","pillEto","pillDone"].map($);
  pills.forEach(p=>p.classList.toggle("hidden", !state.showCounters));
  saveState();

  if(state._countersTimer) clearTimeout(state._countersTimer);
  if(on && autoHide){
    state._countersTimer=setTimeout(()=>{
      state.showCounters=false;
      pills.forEach(p=>p.classList.add("hidden"));
      saveState();
    }, clamp(state.countersAutoHideSec||10,3,30)*1000);
  }
}

/* ================= Focus / Panels / Theme cycling ================= */
function applyFocus(){
  $("app").classList.toggle("focusOn", !!state.focus);
}
function cycleTheme(){
  state.theme = state.theme==="light" ? "dark" : state.theme==="dark" ? "pastel" : "light";
  saveState(); renderAll();
}
function toggleFocus(){ state.focus=!state.focus; saveState(); renderAll(); }

function openDrawer(){ $("drawerBack").classList.add("show"); $("drawer").classList.add("open"); renderDrawer(); }
function closeDrawer(){ $("drawerBack").classList.remove("show"); $("drawer").classList.remove("open"); }
function openRight(){ $("rightBack").classList.add("show"); $("rightPanel").classList.add("open"); renderRight(); }
function closeRight(){ $("rightBack").classList.remove("show"); $("rightPanel").classList.remove("open"); }

/* ================= Wire events ================= */
$("btnMenu").onclick = ()=> openDrawer();
$("drawerClose").onclick = ()=> closeDrawer();
$("drawerBack").onclick = ()=> closeDrawer();

$("btnRight").onclick = ()=> openRight();
$("rightClose").onclick = ()=> closeRight();
$("rightBack").onclick = ()=> closeRight();

$("btnTheme").onclick = ()=> cycleTheme();

$("btnCounters").onclick = ()=> setCountersVisible(!state.showCounters, true);

$("btnListToggle").onclick = ()=>{
  state.showBelowList=!state.showBelowList;
  saveState(); renderAll();
};
$("btnHideBelow").onclick = ()=>{
  state.showBelowList=false;
  saveState(); renderAll();
};

$("btnFocus").onclick = ()=> toggleFocus();

$("btnRoulette").onclick = ()=>{
  const btn=$("btnRoulette");
  btn.classList.remove("rouletteSpin");
  void btn.offsetWidth;
  btn.classList.add("rouletteSpin");
  const pick=roulettePick();
  if(!pick) return;
  pushUndo("roulette");
  setCurrentTask(pick.id);
  saveState();
  renderAll();
};

$("btnEtorion").onclick = ()=> degommeEtorion();
$("btnUndo").onclick = ()=> undo();

$("btnNotes").onclick = ()=>{ renderNotes(); openModal("notesModal"); };
$("noteAdd").onclick = ()=>{ addNote($("noteInput").value); $("noteInput").value=""; saveState(); renderNotes(); };
$("noteClear").onclick = ()=>{ if(confirm("Vider toutes les notes ?")){ state.notes=[]; saveState(); renderNotes(); } };

$("btnDoneTask").onclick = ()=>{
  const t=getTaskById(state.currentTaskId);
  if(t) completeTask(t.id);
};
$("btnPause").onclick = ()=> togglePause();

/* Pomodoro */
$("btnPomo").onclick = ()=>{
  $("pomoMin").value = String(state.pomodoro.minutes||25);
  renderTimer();
  $("pomoInfo").textContent = state.pomodoro.running ? `En cours : ${fmtMMSS(pomoRemainingMs()||0)}` : "Prêt. Lance quand tu veux.";
  openModal("pomodoroModal");
};
$("pomoStart").onclick = ()=>{
  startPomodoro($("pomoMin").value);
  $("pomoInfo").textContent = `En cours : ${fmtMMSS(pomoRemainingMs()||0)}`;
};
$("pomoStop").onclick = ()=>{
  stopPomodoro();
  $("pomoInfo").textContent = "Stop. Le temps t’appartient à nouveau.";
};

/* Export */
$("expText").onclick = ()=> renderExport("text");
$("expJSON").onclick = ()=> renderExport("json");
$("expCSV").onclick = ()=> renderExport("csv");
$("expCopy").onclick = async ()=>{
  try{ await navigator.clipboard.writeText($("expOut").value||""); }
  catch(e){ alert("Copie impossible (clipboard)."); }
};

window.addEventListener("keydown",(e)=>{
  if(e.key==="Escape"){ closeAllModals(); closeDrawer(); closeRight(); }
});

/* ================= Render all ================= */
function renderAll(){
  applyAppearance();
  applyFocus();
  setRandomTagline();

  recomputeBaselineIfNeeded();
  ensureCurrentTask();

  renderHUD();
  renderProgress();
  renderCurrent();
  renderEmoDock();
  renderSetsDock();

  applyListVisible();
  if(state.showBelowList) renderBelowList();

  // Timer + pomo visibles en permanence
  renderTimer();

  // Pomodoro fin
  if(state.pomodoro.running){
    const rem=pomoRemainingMs();
    if(rem!==null && rem<=0){
      state.pomodoro.running=false;
      state.pomodoro.endsAt=null;
      saveState();
      confettiBurst(1.35);
      // Kiffance (pas d'UI dédiée, mais petite punchline)
      $("hintLine").textContent = randomKiffance();
    }
  }
}

/* ================= Timer loop ================= */
let timerInterval=null;
function startTimerLoop(){
  if(timerInterval) clearInterval(timerInterval);
  timerInterval=setInterval(()=> renderTimer(), 500);
}

/* ================= Boot ================= */
(function boot(){
  if(!state.activeTab) state.activeTab="inbox";
  if(!state.rightTab) state.rightTab="emotions";

  applyAppearance();
  setRandomTagline(true);

  // Démarre le timer si absent
  if(!state.timer.startedAt) state.timer.startedAt=Date.now();

  ensureCurrentTask();
  saveState();
  renderAll();
  startTimerLoop();
})();
</script>

</body>
</html>
